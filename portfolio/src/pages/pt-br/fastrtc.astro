---
import PostLayout from '@layouts/PostLayout.astro';
import CodeBlockInputCell from '@components/CodeBlockInputCell.astro';
import CodeBlockOutputCell from '@components/CodeBlockOutputCell.astro';

const { metadata_page } = await import('@portfolio/consts.json');
const { colors } = await import('@portfolio/consts.json');
const { svg_paths } = await import('@portfolio/consts.json');

const page_title = 'Guia Completo de FastRTC: Crie um Chat de Voz com IA em Tempo Real com Python';
const end_url = 'fastrtc';
const description = 'Aprenda a usar o FastRTC para criar aplicativos de IA por voz em tempo real com Python. Siga nosso guia passo a passo para construir um chatbot de voz com LLMs, desde a instala√ß√£o b√°sica at√© a integra√ß√£o com uma chamada telef√¥nica.';
const keywords = 'fastrtc, real-time, ai, aplica√ß√£o, telefone, python, chat de voz, llm';
const languaje = 'PT';
const image_path = 'https://images.maximofn.com/fastrtc-thumbnail.webp';
const opening_brace = '{';
const closing_brace = '}';
---

<PostLayout 
    title={page_title}
    languaje={languaje}
    description={description}
    keywords={keywords}
    author={metadata_page.author}
    theme_color={colors.background_color}
    end_url={end_url}
    image_path={image_path}
    image_width=960
    image_height=720
    image_extension=webp
    article_date=2025-03-08+T00:00:00Z
>

  <section class="post-body">


    <aside class="post-index">
      <a class="anchor-link" href="#Principais caracteristicas de FastRTC"><h2>Principais caracter√≠sticas de FastRTC</h2></a>
      <a class="anchor-link" href="#Instalacao"><h2>Instala√ß√£o</h2></a>
      <a class="anchor-link" href="#Primeiros passos"><h2>Primeiros passos</h2></a>
      <a class="anchor-link" href="#Subindo de nivel: Bate-papo de voz com LLM"><h2>Subindo de n√≠vel: Bate-papo de voz com LLM</h2></a>
      <a class="anchor-link" href="#Chamada telefonica"><h2>Chamada telef√¥nica</h2></a>
    </aside>


    <div class="post-body-content">
      
      <section class="section-block-markdown-cell">
      </section>
      
      <section class="section-block-markdown-cell">
      <blockquote>
      <p>Aviso: Este post foi traduzido para o portugu√™s usando um modelo de tradu√ß√£o autom√°tica. Por favor, me avise se encontrar algum erro.</p>
      </blockquote>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Nos √∫ltimos meses, temos visto um grande avan√ßo em modelos de voz em tempo real, com empresas inteiras fundadas ao redor de modelos tanto de c√≥digo aberto quanto fechado. Alguns marcos importantes incluem:</p>
      <ul>
        <li><code>OpenAI</code> e <code>Google</code> lan√ßaram suas APIs multimodais ao vivo para ChatGPT e Gemini. ¬°A OpenAI at√© lan√ßou um n√∫mero de telefone <code>1-800-ChatGPT</code>!</li>
        <li><code>Kyutai</code> lan√ßou <a href="https://huggingface.co/kyutai" target="_blank" rel="nofollow noreferrer">Moshi</a>, um LLM de √°udio para √°udio totalmente de c√≥digo aberto.</li>
        <li><code>Alibaba</code> lan√ßou <a href="https://huggingface.co/Qwen/Qwen2-Audio-7B-Instruct" target="_blank" rel="nofollow noreferrer">Qwen2-Audio</a>, um LLM de c√≥digo aberto que entende √°udio de forma nativa.</li>
        <li><code>Fixie.ai</code> lan√ßou <a href="https://huggingface.co/fixie-ai/ultravox-v0_5-llama-3_3-70b" target="_blank" rel="nofollow noreferrer">Ultravox</a>, outro LLM de c√≥digo aberto que tamb√©m entende √°udio de forma nativa.</li>
        <li><code>ElevenLabs</code> arrecadou 180 milh√µes de d√≥lares na sua S√©rie C.</li>
      </ul>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Apesar desta explos√£o em modelos e financiamento, ainda √© dif√≠cil construir aplica√ß√µes de IA em tempo real que transmitam √°udio e v√≠deo, especialmente em Python.</p>
      <ul>
        <li>Os engenheiros de ML podem n√£o ter experi√™ncia com as tecnologias necess√°rias para construir aplica√ß√µes em tempo real, como <code>WebRTC</code>.</li>
        <li>Mesmo ferramentas de assist√™ncia de c√≥digo como <code>Cursor</code> e <code>Copilot</code> t√™m dificuldades em escrever c√≥digo Python que suporte aplica√ß√µes de √°udio/v√≠deo em tempo real.</li>
      </ul>
      <p>Por isso √© empolgante o an√∫ncio de <code>FastRTC</code>, a biblioteca de comunica√ß√£o em tempo real para Python. A biblioteca foi projetada para facilitar a constru√ß√£o de aplica√ß√µes de IA de √°udio e v√≠deo em tempo real totalmente em Python!</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <h2 id="Principais caracteristicas de FastRTC">Principais caracter√≠sticas de FastRTC<a class="anchor-link" href="#Principais caracteristicas de FastRTC"><img decoding="async" class="link-img" width="24px" height="24px" alt="link image 13" src={svg_paths.link_svg_path}/></a></h2>
      </section>
      
      <section class="section-block-markdown-cell">
      <ul>
        <li>üó£Ô∏è Detec√ß√£o de voz autom√°tica e gerenciamento de turnos integrado, para que voc√™ s√≥ precise se preocupar com a l√≥gica de resposta ao usu√°rio.</li>
        <li>üíª UI autom√°tica - UI do Gradio habilitada para WebRTC integrada para testes (ou implanta√ß√£o em produ√ß√£o!).</li>
        <li>üìû Chamada telef√¥nica - Use <code>fastphone()</code> para obter um n√∫mero de telefone <strong>gratuito</strong> para ligar para o seu fluxo de √°udio (√© necess√°rio um token HF).</li>
        <li>‚ö°Ô∏è Suporte para <code>WebRTC</code> e <code>Websocket</code>.</li>
        <li>üí™ Personaliz√°vel - Voc√™ pode montar o stream em qualquer aplica√ß√£o <code>FastAPI</code> para servir uma UI personalizada e implantar al√©m do <code>Gradio</code>.</li>
        <li>üß∞ Muitas utilidades para <code>text-to-speech</code>, <code>speech-to-text</code>, <code>detec√ß√£o de parada</code> para te ajudar a come√ßar.</li>
      </ul>
      </section>
      
      <section class="section-block-markdown-cell">
      <h2 id="Instalacao">Instala√ß√£o<a class="anchor-link" href="#Instalacao"><img decoding="async" class="link-img" width="24px" height="24px" alt="link image 14" src={svg_paths.link_svg_path}/></a></h2>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Para poder usar <code>FastRTC</code>, primeiro voc√™ precisa instalar a biblioteca:</p>
      <div class='highlight'><pre><code class="language-bash">pip install fastrtc</code></pre></div>
      <p>Mas se quisermos instalar as funcionalidades de detec√ß√£o de pausa, speech-to-text e text-to-speech, precisamos instalar algumas depend√™ncias adicionais:</p>
      <div class='highlight'><pre><code class="language-bash">pip install "fastrtc[vad, stt, tts]"</code></pre></div>
      </section>
      
      <section class="section-block-markdown-cell">
      <h2 id="Primeiros passos">Primeiros passos<a class="anchor-link" href="#Primeiros passos"><img decoding="async" class="link-img" width="24px" height="24px" alt="link image 15" src={svg_paths.link_svg_path}/></a></h2>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Come√ßaremos construindo o <code>ol√° mundo</code> do √°udio em tempo real: fazer eco do que o usu√°rio diz. Em <code>FastRTC</code>, isso √© t√£o simples quanto:</p>
      </section>
      
      <CodeBlockInputCell
        text={[
      '<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">ReplyOnPause</span>',
      '<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>',
      '<span class="w"> </span>',
      '<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>',
      '<span class="w">    </span><span class="k">yield</span> <span class="n">audio</span>',
      '<span class="w"> </span>',
      '<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>',
      '<span class="n">stream</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>',
        ]}
        languaje='python'
      ></CodeBlockInputCell>
      
      <CodeBlockOutputCell
        text={[
          '* Running on local URL:  http://127.0.0.1:7872',
          'To create a public link, set `share=True` in `launch()`.',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <CodeBlockOutputCell
        text={[
          '&amp;lt;IPython.core.display.HTML object&amp;gt;',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <CodeBlockOutputCell
        text={[
          'INFO:     127.0.0.1:58223 - &quot;GET / HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/index-C7PS0jJm.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/index-Bo0Yq5bb.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/svelte/svelte.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/Embed-FUIL71FR.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/Index-wMEhc4G9.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/StreamingBar-DOagx4HU.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/index-B1gfMDT9.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/IconButtonWrapper-EOzMzU45.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/StreamingBar.svelte_svelte_type_style_lang-CDNxkBIr.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/MarkdownCode-DPiWQnAx.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/DownloadLink-CqD3Uu0l.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/IconButtonWrapper.svelte_svelte_type_style_lang-BOpxTcdu.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/prism-python-qapVsvY8.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-BJ_RfjVB.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/MarkdownCode.svelte_svelte_type_style_lang-3tofWDHK.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/IconButton-B-aAVSzy.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Clear-By3xiIwg.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/context-TgWPFwN2.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/Button-BWSOH8Qq.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/Image-CsmDAdIf.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Blocks-E57YC_S0.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/Button-DTh9AgeE.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/Image-B8dFOee4.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/ImagePreview-DJhr8Mfv.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/file-url-DgijyRSD.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/Dropdown-CWxB-qJp.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/Example-D7K5RtQ2.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/Blocks-B5wxaDIo.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Dropdown-DjrBHETv.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/Block-DZqtZLFP.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/BlockTitle-BIcnzvtg.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/index-CvpmwOJi.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/MarkdownCode-DJM7o_VY.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/Info-DcCn6tHi.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/DropdownArrow-dYuMZY9s.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Toast-DdWZrg4w.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/utils-BsGrhMNe.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/Index-ChJkSByh.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/Index-CfowPFmo.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-CptIZeFZ.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Index-Csm0OGa9.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /assets/Index-Cgj6KPvj.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58223 - &quot;GET /assets/Code-DGNrTu_I.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58225 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-HXWviefR.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58229 - &quot;GET /assets/Index-WEzAIkMk.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58230 - &quot;GET /assets/BlockLabel-DqHge3FF.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58227 - &quot;GET /assets/Index-CRGGsrTx.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58241 - &quot;GET / HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58241 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58241 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58244 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58260 - &quot;GET /static/fonts/ui-sans-serif/ui-sans-serif-Bold.woff2 HTTP/1.1&quot; 404 Not Found',
          'INFO:     127.0.0.1:58260 - &quot;GET /static/fonts/system-ui/system-ui-Bold.woff2 HTTP/1.1&quot; 404 Not Found',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <section class="section-block-markdown-cell">
      <p>Quando vamos ao link que o Gradio sugere, primeiro temos que dar permiss√µes ao navegador para acessar o microfone. A seguir, aparecer√° isto</p>
      <img decoding="async" onerror="this.parentNode.removeChild(this)" src="https://images.maximofn.com/fastRTC%20-%20hello%20world%20-%20init.webp" alt="fastrct - hello world - init">
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Se clicarmos na guia √† direita da palavra <code>Record</code>, podemos selecionar o microfone que queremos usar.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Ao clicar no bot√£o <code>Record</code>, tudo o que dissermos ser√° repetido pelo aplicativo. Isso significa que ele captura o √°udio, detecta quando paramos de falar e o repete.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Vamos a desmembr√°-lo:</p>
      <ul>
        <li><code>ReplyOnPause</code> ir√° tratar a detec√ß√£o de voz e a passagem de turnos para voc√™. Voc√™ s√≥ precisa se preocupar com a l√≥gica para responder ao usu√°rio. √â necess√°rio passar a fun√ß√£o que ser√° respons√°vel por gerenciar o √°udio de entrada. No nosso caso, √© a fun√ß√£o <code>echo</code>, que captura o √°udio de entrada e o retorna em stream usando <code>yield</code>, que muitas pessoas n√£o conhecem, mas √© um gerador, ou seja, √© um m√©todo do Python para criar iteradores. Se quiser saber mais sobre <code>yield</code>, pode ler meu post sobre <a href="https://www.maximofn.com/python#6.5.-Generadores">Python</a>. Qualquer gerador que retorne uma tupla de √°udio (representada como <code>(sample_rate, audio_data)</code>) funcionar√°.* A classe <code>Stream</code> construir√° uma UI do Gradio para que voc√™ possa testar rapidamente seu stream. Uma vez que voc√™ tenha terminado de prototipar, voc√™ pode implantar seu Stream como um aplicativo FastAPI pronto para produ√ß√£o em uma √∫nica linha de c√≥digo</li>
      </ul>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Aqui podemos ver um exemplo dos criadores de <code>FastRTC</code></p>
      <video src="https://github.com/user-attachments/assets/fcf2d30e-3e98-47c9-8dc3-23340784c441" controls></video>
      </section>
      
      <section class="section-block-markdown-cell">
      <h2 id="Subindo de nivel: Bate-papo de voz com LLM">Subindo de n√≠vel: Bate-papo de voz com LLM<a class="anchor-link" href="#Subindo de nivel: Bate-papo de voz com LLM"><img decoding="async" class="link-img" width="24px" height="24px" alt="link image 16" src={svg_paths.link_svg_path}/></a></h2>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>O pr√≥ximo n√≠vel √© usar um LLM para responder ao usu√°rio. <code>FastRTC</code> vem com capacidades de <code>speech-to-text</code> e <code>text-to-speech</code> incorporadas, portanto trabalhar com LLMs √© realmente f√°cil. Vamos alterar nossa fun√ß√£o <code>echo</code> accordingly:</p>
      </section>
      
      <CodeBlockInputCell
        text={[
      '<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplyOnPause</span><span class="p">,</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">get_stt_model</span><span class="p">,</span> <span class="n">get_tts_model</span>',
      '<span class="kn">from</span><span class="w"> </span><span class="nn">gradio_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>',
      '<span class="w"> </span>',
      '<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;Maximofn/SmolLM2_localModel&quot;</span><span class="p">)</span>',
      '<span class="n">stt_model</span> <span class="o">=</span> <span class="n">get_stt_model</span><span class="p">()</span>',
      '<span class="n">tts_model</span> <span class="o">=</span> <span class="n">get_tts_model</span><span class="p">()</span>',
      '<span class="w"> </span>',
      '<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">):</span>',
      '<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">stt_model</span><span class="o">.</span><span class="n">stt</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>',
      '<span class="w">    </span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>',
      '<span class="w">            </span><span class="n">message</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;You are a friendly Chatbot. Always reply in the language in which the user is writing to you.&quot;</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;/chat&quot;</span>',
      '<span class="w">    </span><span class="p">)</span>',
      '<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>',
      '<span class="w">    </span><span class="k">for</span> <span class="n">audio_chunk</span> <span class="ow">in</span> <span class="n">tts_model</span><span class="o">.</span><span class="n">stream_tts_sync</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>',
      '<span class="w">        </span><span class="k">yield</span> <span class="n">audio_chunk</span>',
      '<span class="w"> </span>',
      '<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>',
      '<span class="n">stream</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>',
        ]}
        languaje='python'
      ></CodeBlockInputCell>
      
      <CodeBlockOutputCell
        text={[
          'Loaded as API: https://maximofn-smollm2-localmodel.hf.space ‚úî',
          '* Running on local URL:  http://127.0.0.1:7871',
          'To create a public link, set `share=True` in `launch()`.',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <CodeBlockOutputCell
        text={[
          '&amp;lt;IPython.core.display.HTML object&amp;gt;',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <CodeBlockOutputCell
        text={[
          'INFO:     127.0.0.1:58224 - &quot;GET / HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/index-Bo0Yq5bb.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/index-C7PS0jJm.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/svelte/svelte.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-wMEhc4G9.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/StreamingBar-DOagx4HU.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/IconButtonWrapper-EOzMzU45.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/Embed-FUIL71FR.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/StreamingBar.svelte_svelte_type_style_lang-CDNxkBIr.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/index-B1gfMDT9.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/MarkdownCode-DPiWQnAx.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/MarkdownCode.svelte_svelte_type_style_lang-3tofWDHK.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/Index-BJ_RfjVB.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/DownloadLink-CqD3Uu0l.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/IconButtonWrapper.svelte_svelte_type_style_lang-BOpxTcdu.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/prism-python-qapVsvY8.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/IconButton-B-aAVSzy.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/Clear-By3xiIwg.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/context-TgWPFwN2.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/Blocks-E57YC_S0.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/Image-B8dFOee4.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/ImagePreview-DJhr8Mfv.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/Button-BWSOH8Qq.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/Button-DTh9AgeE.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/Dropdown-CWxB-qJp.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/Image-CsmDAdIf.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/Blocks-B5wxaDIo.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/Example-D7K5RtQ2.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/Block-DZqtZLFP.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/file-url-DgijyRSD.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/Info-DcCn6tHi.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/MarkdownCode-DJM7o_VY.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/Dropdown-DjrBHETv.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/index-CvpmwOJi.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/BlockTitle-BIcnzvtg.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/DropdownArrow-dYuMZY9s.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/Toast-DdWZrg4w.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/utils-BsGrhMNe.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/Index-CfowPFmo.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/Index-ChJkSByh.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /assets/Code-DGNrTu_I.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-Csm0OGa9.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /assets/Index-HXWviefR.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/BlockLabel-DqHge3FF.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58224 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58231 - &quot;GET /assets/Index-Cgj6KPvj.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58233 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-CptIZeFZ.css HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58232 - &quot;GET /assets/Index-CRGGsrTx.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58234 - &quot;GET /assets/Index-WEzAIkMk.js HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58242 - &quot;GET / HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58242 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK',
          'INFO:     127.0.0.1:58242 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58243 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified',
          'INFO:     127.0.0.1:58250 - &quot;GET /static/fonts/ui-sans-serif/ui-sans-serif-Bold.woff2 HTTP/1.1&quot; 404 Not Found',
          'INFO:     127.0.0.1:58250 - &quot;GET /static/fonts/system-ui/system-ui-Bold.woff2 HTTP/1.1&quot; 404 Not Found',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <section class="section-block-markdown-cell">
      <p>Como modelo de <code>speech-to-text</code> use <code>Moonshine</code>, que supostamente s√≥ suporta ingl√™s, mas eu o testei em espanhol e ele entende bem.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Como modelo de linguagem vamos usar o modelo que desployei em um backend no Hugging Face e que escrevi no post <a href="https://www.maximofn.com/deploy-backend-with-llm-in-huggingface">Desplegar backend com LLM em HuggingFace</a>. Utiliza o LLM <code>HuggingFaceTB/SmolLM2-1.7B-Instruct</code> que √© um modelo pequeno, j√° que est√° rodando em um backend com CPU, mas que funciona bastante bem.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Como modelo de <code>text-to-speech</code> use <code>Kokoro</code> que sim tem op√ß√µes de falar em outros idiomas, mas que por enquanto na biblioteca <code>FastRTC</code> ainda n√£o est√° implementado.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Se nos interessa muito usar modelos de <code>speech-to-speech</code> e <code>text-to-speech</code> em outros idiomas, poder√≠amos implement√°-los n√≥s mesmos, pois o maior potencial do <code>FastRTC</code> est√° na camada de comunica√ß√£o em tempo real, mas n√£o vou me aprofundar nisso agora.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Agora, se testarmos o c√≥digo que acabamos de escrever, podemos ter um chatbot, por voz em tempo real.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <h2 id="Chamada telefonica">Chamada telef√¥nica<a class="anchor-link" href="#Chamada telefonica"><img decoding="async" class="link-img" width="24px" height="24px" alt="link image 17" src={svg_paths.link_svg_path}/></a></h2>
      <p>Se voc√™ chamar <code>stream.fastphone()</code> em vez de <code>stream.ui.launch()</code>, obter√° um n√∫mero de telefone gratuito para ligar para o seu stream. Tenha em mente que √© necess√°rio um token do Hugging Face.</p>
      <p>Geramos um script, pois nem sempre funciona em um Jupyter Notebook.</p>
      </section>
      
      <CodeBlockInputCell
        text={[
      '<span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">fastrtc_phone_demo</span><span class="o">.</span><span class="n">py</span>',
      '<span class="w"> </span>',
      '<span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplyOnPause</span><span class="p">,</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">get_stt_model</span><span class="p">,</span> <span class="n">get_tts_model</span>',
      '<span class="kn">import</span><span class="w"> </span><span class="nn">gradio</span>',
      '<span class="kn">from</span><span class="w"> </span><span class="nn">gradio_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>',
      '<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>',
      '<span class="kn">from</span><span class="w"> </span><span class="nn">gradio.networking</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_tunnel</span> <span class="k">as</span> <span class="n">original_setup_tunnel</span>',
      '<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Monkey patch setup_tunnel para que acepte el par√°metro adicional</span>',
      '<span class="k">def</span><span class="w"> </span><span class="nf">patched_setup_tunnel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">share_token</span><span class="p">,</span> <span class="n">share_server_address</span><span class="p">,</span> <span class="n">share_server_tls_certificate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>',
      '<span class="w">    </span><span class="k">return</span> <span class="n">original_setup_tunnel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">share_token</span><span class="p">,</span> <span class="n">share_server_address</span><span class="p">,</span> <span class="n">share_server_tls_certificate</span><span class="p">)</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Replace the original function with our patched version</span>',
      '<span class="n">gradio</span><span class="o">.</span><span class="n">networking</span><span class="o">.</span><span class="n">setup_tunnel</span> <span class="o">=</span> <span class="n">patched_setup_tunnel</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Get the token from the environment variable</span>',
      '<span class="n">HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN&quot;</span><span class="p">)</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Initialize the LLM client</span>',
      '<span class="n">llm_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;Maximofn/SmolLM2_localModel&quot;</span><span class="p">)</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Initialize the STT and TTS models</span>',
      '<span class="n">stt_model</span> <span class="o">=</span> <span class="n">get_stt_model</span><span class="p">()</span>',
      '<span class="n">tts_model</span> <span class="o">=</span> <span class="n">get_tts_model</span><span class="p">()</span>',
      '<span class="w"> </span>',
      '<span class="c1"># Define the echo function</span>',
      '<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">):</span>',
      '<span class="w">    </span><span class="c1"># Convert the audio to text</span>',
      '<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">stt_model</span><span class="o">.</span><span class="n">stt</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>',
      '<span class="w"> </span>',
      '<span class="w">    </span><span class="c1"># Generate the response</span>',
      '<span class="w">    </span><span class="n">response</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>',
      '<span class="w">            </span><span class="n">message</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;You are a friendly Chatbot. Always reply in the language in which the user is writing to you.&quot;</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>',
      '<span class="w">            </span><span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;/chat&quot;</span>',
      '<span class="w">    </span><span class="p">)</span>',
      '<span class="w">    </span>',
      '<span class="w">    </span><span class="c1"># Convert the response to audio</span>',
      '<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>',
      '<span class="w"> </span>',
      '<span class="w">    </span><span class="c1"># Stream the audio</span>',
      '<span class="w">    </span><span class="k">for</span> <span class="n">audio_chunk</span> <span class="ow">in</span> <span class="n">tts_model</span><span class="o">.</span><span class="n">stream_tts_sync</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>',
      '<span class="w">        </span><span class="k">yield</span> <span class="n">audio_chunk</span>',
      '<span class="w"> </span>',
      '<span class="k">def</span><span class="w"> </span><span class="nf">find_free_port</span><span class="p">(</span><span class="n">start_port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>',
      '<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the first free port starting from start_port.&quot;&quot;&quot;</span>',
      '<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for a free port starting from </span><span class="si">{</span><span class="n">start_port</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>',
      '<span class="w">    </span><span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_port</span><span class="p">,</span> <span class="n">max_port</span><span class="p">):</span>',
      '<span class="w">        </span><span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>',
      '<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>',
      '<span class="w">            </span><span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If result != 0, the port is free</span>',
      '<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free port found: </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>',
      '<span class="w">                </span><span class="k">return</span> <span class="n">port</span>',
      '<span class="w">    </span><span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No free port found between </span><span class="si">{</span><span class="n">start_port</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>',
      '<span class="w">    </span>',
      '<span class="n">free_port</span> <span class="o">=</span> <span class="n">find_free_port</span><span class="p">()</span>    <span class="c1"># Search for a free port</span>',
      '<span class="w"> </span>',
      '<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>',
      '<span class="n">stream</span><span class="o">.</span><span class="n">fastphone</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">free_port</span><span class="p">)</span>',
        ]}
        languaje='python'
      ></CodeBlockInputCell>
      
      <section class="section-block-markdown-cell">
      <p>Explicamos o c√≥digo</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>A parte</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-python"># Monkey patch setup_tunnel para aceitar o par√¢metro adicional<br>def patched_setup_tunnel(host, port, share_token, share_server_address, share_server_tls_certificate=None):<br>return original_setup_tunnel(host, port, share_token, share_server_address, share_server_tls_certificate)<br><br># Substitua a fun√ß√£o original pela nossa vers√£o patchadagradio.networking.setup_tunnel = patched_setup_tunnel</code></pre></div>
            </section>
      <p>√â necess√°rio porque <code>FastRTC</code> foi escrito para uma vers√£o antiga do <code>gradio</code> que n√£o suporta o par√¢metro <code>share_server_address</code> no m√©todo <code>setup_tunnel</code>. Ent√£o, n√≥s o patcheamos para aceitar o par√¢metro adicional.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Como √© necess√°rio um token do Hugging Face, obtemos o token da vari√°vel de ambiente <code>HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</code>.</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-python"># Obtenha o token da vari√°vel de ambiente<br>HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN = os.getenv("HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN")</code></pre></div>
            </section>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>A seguir s√£o criados os modelos de linguagem, de <code>speech-to-text</code> e de <code>text-to-speech</code>, e criamos a fun√ß√£o <code>echo</code> que ser√° respons√°vel por gerenciar o √°udio de entrada e sa√≠da.</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-python"># Inicialize o cliente LLM<br>llm_client = Client("Maximofn/SmolLM2_localModel")<br><br># Inicialize os modelos STT e TTS<br>stt_model = get_stt_model()<br>tts_model = get_tts_model()<br><br># Defina a fun√ß√£o echo<br>def eco(√°udio):<br># Converter o √°udio em texto<br>prompt = stt_model.stt(audio)<br><br># Gerar a resposta<br>resposta = llm_client.predict(<br>message=prompt,<br>Entendido. Estou pronto para traduzir o texto markdown para o portugu√™s conforme solicitado. Por favor, forne√ßa o texto que deseja traduzir.max_tokens=512,<br>temperature=0.7,<br>top_p=0,95,<br>api_name="/chat"<br>)<br>    <br># Converter a resposta em √°udio<br>prompt = resposta<br><br># Transmita o √°udio<br>for audio_chunk in tts_model.stream_tts_sync(prompt):<br>yield audio_chunk</code></pre></div>
            </section>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Como antes usamos a porta <code>8000</code>, caso voc√™s digam que ela est√° ocupada, criamos uma fun√ß√£o para encontrar uma porta livre e encontramos uma.</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-python">def find_free_port(start_port=8000, max_port=9000):<br>"""Encontre a primeira porta livre a partir de start_port."""<br>print(f"Procurando uma porta livre a partir de &#123;start_port&#125;...")<br>for port in range(start_port, max_port):<br>com socket.socket(socket.AF_INET, socket.SOCK_STREAM) como sock:<br>result = sock.connect_ex((&#39;127.0.0.1&#39;, port))<br>if result != 0:  # Se result != 0, a porta est√° livre<br>print(f"Porta livre encontrada: &#123;port&#125;")<br>retornar portugu√™s<br>raise RuntimeError(f"Nenhuma porta livre encontrada entre &#123;start_port&#125; e &#123;max_port&#125;")<br>    <br>porta_livre = encontrar_porta_livre()    # Procurar uma porta livre</code></pre></div>
            </section>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>O fluxo √© criado e agora <code>stream.fastphone()</code> √© usado para obter um n√∫mero de telefone gratuito para ligar ao seu fluxo, em vez de <code>stream.ui.launch()</code>, que usamos anteriormente para criar a interface gr√°fica.</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-python">stream = Stream(ReplyOnPause(echo), modality="audio", mode="send-receive")<br>stream.fastphone(token=HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN, port=free_port)</code></pre></div>
            </section>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Se o executarmos, veremos algo assim:</p>
      </section>
      
      <CodeBlockInputCell
        text={[
      '<span></span><span class="err">!</span><span class="n">python</span> <span class="n">fastrtc_phone_demo</span><span class="o">.</span><span class="n">py</span>',
        ]}
        languaje='python'
      ></CodeBlockInputCell>
      
      <CodeBlockOutputCell
        text={[
          'Loaded as API: https://maximofn-smollm2-localmodel.hf.space ‚úî',
          'INFO:	  Warming up STT model.',
          'INFO:	  STT model warmed up.',
          'INFO:	  Warming up VAD model.',
          'INFO:	  VAD model warmed up.',
          'Searching for a free port starting from 8000...',
          'Free port found: 8004',
          'INFO:     Started server process [24029]',
          'INFO:     Waiting for application startup.',
          'INFO:	  Visit https://fastrtc.org/userguide/api/ for WebRTC or Websocket API docs.',
          'INFO:     Application startup complete.',
          'INFO:     Uvicorn running on http://127.0.0.1:8004 (Press CTRL+C to quit)',
          'INFO:	  Your FastPhone is now live! Call +1 877-713-4471 and use code 994514 to connect to your stream.',
          'INFO:	  You have 30:00 minutes remaining in your quota (Resetting on 2025-04-07)',
          'INFO:	  Visit https://fastrtc.org/userguide/audio/#telephone-integration for information on making your handler compatible with phone usage.',
        ]}
        languaje='python'
      ></CodeBlockOutputCell>
      
      <section class="section-block-markdown-cell">
      <p>Vemos que aparece</p>
      
      <section class="section-block-markdown-cell">
            <div class='highlight'><pre><code class="language-bash">INFO: Seu FastPhone est√° agora ativo! Ligue para +1 877-713-4471 e use o c√≥digo 994514 para se conectar ao seu stream.<br>INFO: Voc√™ tem 30:00 minutos restantes em sua cota (Redefinindo em 2025-04-07)</code></pre></div>
            </section>
      <p>Isto √©, se ligarmos para o n√∫mero <code>+1 877-713-4471</code> e usarmos o c√≥digo <code>994514</code>, seremos conectados ao nosso stream.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Se formos at√© <a href="https://fastrtc.org/userguide/audio/#telephone-integration" target="_blank" rel="nofollow noreferrer">Telephone Integration</a> da documenta√ß√£o de <code>FastRTC</code>, veremos que usa <a href="https://www.twilio.com/">twilio</a> para fazer a chamada. Tem op√ß√£o para configurar um n√∫mero local nos Estados Unidos, Dublin, Frankfurt, T√≥quio, Singapura, Sydney e S√£o Paulo.</p>
      </section>
      
      <section class="section-block-markdown-cell">
      <p>Tente testeado fazer a chamada da Espanha (o que vai me custar bastante) e funciona, mas √© lento. Liguei, inseri o c√≥digo e fiquei esperando para ser conectado com o agente, mas como estava demorando muito, desliguei.</p>
      </section>







    </div>

  </section>

</PostLayout>
