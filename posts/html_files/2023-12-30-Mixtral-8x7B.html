<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Número-de-parámetros-index">
									<a class="anchor-link" href="#Número-de-parámetros">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Número de parámetros</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Mixture-of-Experts-(MoE)-index">
									<a class="anchor-link" href="#Mixture-of-Experts-(MoE)">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Mixture of Experts (MoE)</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Uso-de-Mixtral-8x7b-en-la-nube-index">
									<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-la-nube">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Uso de Mixtral-8x7b en la nube</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Uso-de-Mixtral-8x7b-en-huggingface-chat-index">
									<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-huggingface-chat">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Uso de Mixtral-8x7b en huggingface chat</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Uso-de-Mixtral-8x7b-en-Perplexity-Labs-index">
									<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-Perplexity-Labs">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Uso de Mixtral-8x7b en Perplexity Labs</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Uso-de-Mixtral-8x7b-en-local-a-traves-de-la-API-de-huggingface-index">
									<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-local-a-traves-de-la-API-de-huggingface">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Uso de Mixtral-8x7b en local a traves de la API de huggingface</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/2023-12-30-Mixtral-8x7B.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="Mixtral-8x7B-MoE">
								<a class="anchor-link" href="#Mixtral-8x7B-MoE">
									<p style="margin-left: 0px">Mixtral-8x7B MoE</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para mí la mejor descripción de <code><b>mixtral-8x7b</b></code> es la siguiente imagen</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/mixtral-gemini.webp" alt="mixtral-gemini"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Entre la salida de <code><b>gemini</b></code> y la salida de <code><b>mixtra-8x7b</b></code> hubo una diferencia de muy pocos días. Los dos primeros días después del lanzamiento de <code><b>gemini</b></code> se habló bastante de ese modelo, pero en cuanto salió <code><b>mixtral-8x7b</b></code>, <code><b>gemini</b></code> se olvidó por completo y toda la comunidad no paró de hablar de <code><b>mixtral-8x7b</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y no es para menos, viendo sus benchmarks, podemos ver que está al nivel de modelos como <code><b>llama2-70B</b></code> y <code><b>GPT3.5</b></code>, pero con la diferencia de que mientras que <code><b>mixtral-8x7b</b></code> tiene solo 46.7B de parámetros, <code><b>llama2-70B</b></code> tiene 70B y <code><b>GPT3.5</b></code> tiene 175B.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://mistral.ai/images/news/mixtral-of-experts/overview.png" alt="mixtral benchmarks"></p></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Número-de-parámetros">
								<a class="anchor-link" href="#Número-de-parámetros">
									<p style="margin-left: 10px">Número de parámetros</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como su nombre indica, <code><b>mixtral-8x7b</b></code> es un conjunto de 8 modelos de 7B de parámetros, por lo que podríamos pensar que tiene 56B de parámetros (7Bx8), pero no es así. Como explica <a href="https://twitter.com/karpathy/status/1734251375163511203" target="_blank">Andrej Karpathy</a> solo los bloques <code><b>Feed forward</b></code> de los transformers se multiplican por 8, el resto de parámetros se comparten entre los 8 modelos. Por lo que al final el modelo tiene 46.7B de parámetros.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Mixture-of-Experts-(MoE)">
								<a class="anchor-link" href="#Mixture-of-Experts-(MoE)">
									<p style="margin-left: 10px">Mixture of Experts (MoE)</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como hemos dicho, el modelo es un conjunto de 8 modelos de 7B de parámetros, de ahí <code><b>MoE</b></code>, que significa <code><b>Mixture of Experts</b></code>. Cada uno de los 8 modelos se entrena de forma independiente, pero cuando se hace la inferencia un router decide la salída de qué modelo es la que se va a usar.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En la siguiente imagen podemos ver cómo es la arquitectura de un <code><b>Transformer</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-scaled.webp" alt="transformer"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si no la conoces no pasa nada, lo importante es que esta arquitectura consiste en un encoder y un decoder</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-encoder-decoder.webp" alt="transformer-encoder-decoder"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Los LLMs son modelos que solo tienen el decoder, por lo que no tienen encoder. Puedes ver que en la arquitectura hay tres módulos de atención, uno de ellos de hecho conecta el encoder con el decoder. Pero como los LLMs no tienen encoder, no es necesario el módulo de atención que une el decoder y el decoder</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-decoder.webp" alt="transformer-decoder"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora que sabemos cómo es la arquitectura de un LLM, podemos ver cómo es la arquitectura de <code><b>mixtral-8x7b</b></code>. En la siguiente imagen podemos ver la arquitectura del modelo</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/MoE_architecture-scaled.webp" alt="MoE architecture"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver, la arquitectura consiste en el decoder de un <code><b>Transformer</b></code> de 7B de parámetros, solo que la capa <code><b>Feed forward</b></code> consiste en 8 capas <code><b>Feed forward</b></code> con un router que elige cuál de las 8 capas <code><b>Feed forward</b></code> se va a usar. En la imagen anterior solo se muestran cuatro capas <code><b>Feed forward</b></code>, supongo que es para simplificar el diagrama, pero en realidad hay 8 capas <code><b>Feed forward</b></code>. También se ven dos caminos para dos palabras distintas, la palabra <code><b>More</b></code> y la palabra <code><b>Parameters</b></code> y cómo el router elige qué <code><b>Feed forward</b></code> se va a usar para cada palabra.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Viendo la arquitectura podemos entender por qué el modelo tiene 46.7B de parámetros y no 56B. Como hemos dicho, solo los bloques <code><b>Feed forward</b></code> se multiplican por 8, el resto de parámetros se comparten entre los 8 modelos</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Uso-de-Mixtral-8x7b-en-la-nube">
								<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-la-nube">
									<p style="margin-left: 10px">Uso de Mixtral-8x7b en la nube</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por desgracia, para usar <code><b>mixtral-8x7b</b></code> en local es complicado ya que los requisitos de hardware son los siguientes</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> float32: VRAM > 180 GB, es decir, como cada parámetro ocupa 4 bytes, necesitamos 46.7B </em> 4 = 186.8 GB de VRAM solo para almacenar el modelo, además a eso hay que sumarle la VRAM que se necesita para almacenar los datos de entrada y salida</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> float16: VRAM > 90 GB, en este caso cada parámetro ocupa 2 bytes, por lo que necesitamos 46.7B </em> 2 = 93.4 GB de VRAM solo para almacenar el modelo, además a eso hay que sumarle la VRAM que se necesita para almacenar los datos de entrada y salida</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> 8-bit: VRAM > 45 GB, aquí cada parámetro ocupa 1 byte, por lo que necesitamos 46.7B </em> 1 = 46.7 GB de VRAM solo para almacenar el modelo, además a eso hay que sumarle la VRAM que se necesita para almacenar los datos de entrada y salida</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> 4-bit: VRAM > 23 GB, aquí cada parámetro ocupa 0.5 bytes, por lo que necesitamos 46.7B </em> 0.5 = 23.35 GB de VRAM solo para almacenar el modelo, además a eso hay que sumarle la VRAM que se necesita para almacenar los datos de entrada y salida</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Necesitamos unas GPUs muy potentes para poder ejecutarlo, incluso cuando usamos el modelo cuantizado a 4 bits.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por tanto, la forma más sencilla de usar <code><b>Mixtral-8x7B</b></code> es usandolo ya desplegado en la nube. He encontrado varios sitios donde lo puedes usar</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Uso-de-Mixtral-8x7b-en-huggingface-chat">
								<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-huggingface-chat">
									<p style="margin-left: 20px">Uso de Mixtral-8x7b en huggingface chat</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">El primero es en <a href="https://huggingface.co/chat" target="_blank">huggingface chat</a>. Para poder usarlo hay que darle a la rueda dentada dentro de la caja <code><b>Current Model</b></code> y seleccionar <code><b>Mistral AI - Mixtral-8x7B</b></code>. Una vez seleccionado, ya puedes empezar a hablar con el modelo.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/huggingface_chat_01.webp" alt="huggingface_chat_01"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez dentro seleccionar <code><b>mistralai/Mixtral-8x7B-Instruct-v0.1</b></code> y por último darle al botón <code><b>Activate</b></code>. Ahora podremos probar el modelo</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/huggingface_chat_02.webp" alt="huggingface_chat_02"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver le he preguntado en español qué es <code><b>MoE</b></code> y me lo ha explicado</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Uso-de-Mixtral-8x7b-en-Perplexity-Labs">
								<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-Perplexity-Labs">
									<p style="margin-left: 20px">Uso de Mixtral-8x7b en Perplexity Labs</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Otra opción es usar <a href="https://labs.perplexity.ai/" target="_blank">Perplexity Labs</a>. Una vez dentro hay que seleccionar <code><b>mixtral-8x7b-instruct</b></code> en un desplegable que hay en la parte inferior derecha</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/perplexity_labs.webp" alt="perplexity_labs"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver, también le he preguntado en español qué es <code><b>MoE</b></code> y me lo ha explicado</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Uso-de-Mixtral-8x7b-en-local-a-traves-de-la-API-de-huggingface">
								<a class="anchor-link" href="#Uso-de-Mixtral-8x7b-en-local-a-traves-de-la-API-de-huggingface">
									<p style="margin-left: 10px">Uso de Mixtral-8x7b en local a traves de la API de huggingface</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una manera de usarlo en local, tengas los recursos HW que tengas es a través de la API de huggingface. Para ello hay que instalar la librería <code><b>huggingface-hub</b></code> de huggingface</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%</span><span style="color: #6b97e8;">pip</span> <span style="color: #6b97e8;">install</span> <span style="color: #6b97e8;">huggingface</span><span>-</span><span style="color: #6b97e8;">hub</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aquí se muestra una implementación con <code><b>gradio</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">InferenceClient</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">gradio</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">gr</span></p>
<p></p>
<p><span style="color: #6b97e8;">client</span> <span>=</span> <span style="color: #6b97e8;">InferenceClient</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mistralai/Mixtral-8x7B-Instruct-v0.1&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">format_prompt</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">message</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">):</span></p>
<p>  <span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;&lt;s&gt;&quot;</span></p>
<p>  <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">user_prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bot_response</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;[INST] </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user_prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> [/INST]&quot;</span></p>
<p>    <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot; </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">bot_response</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&lt;/s&gt; &quot;</span></p>
<p>  <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;[INST] </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">message</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> [/INST]&quot;</span></p>
<p>  <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">prompt</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">generate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">system_prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #a09e19;">0.9</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #7e7a38;">256</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #a09e19;">0.95</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">repetition_penalty</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,):</span></p>
<p>    <span style="color: #6b97e8;">temperature</span> <span>=</span> <span style="color: #dfd84a;">float</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">temperature</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">temperature</span> <span>&lt;</span> <span style="color: #a09e19;">1e-2</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">temperature</span> <span>=</span> <span style="color: #a09e19;">1e-2</span></p>
<p>    <span style="color: #6b97e8;">top_p</span> <span>=</span> <span style="color: #dfd84a;">float</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">top_p</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">generate_kwargs</span> <span>=</span> <span style="color: #dfd84a;">dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #6b97e8;">temperature</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #6b97e8;">max_new_tokens</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #6b97e8;">top_p</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">repetition_penalty</span><span>=</span><span style="color: #6b97e8;">repetition_penalty</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">do_sample</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">seed</span><span>=</span><span style="color: #7e7a38;">42</span><span style="color: #e3e11d;">,)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">formatted_prompt</span> <span>=</span> <span style="color: #6b97e8;">format_prompt</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">system_prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">stream</span> <span>=</span> <span style="color: #6b97e8;">client</span><span>.</span><span style="color: #6b97e8;">text_generation</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">formatted_prompt</span><span style="color: #e3e11d;">,</span> <span>**</span><span style="color: #6b97e8;">generate_kwargs</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">stream</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">details</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_full_text</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #7e7a34;">&quot;&quot;</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">response</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">stream</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">output</span> <span>+=</span> <span style="color: #6b97e8;">response</span><span>.</span><span style="color: #6b97e8;">token</span><span>.</span><span style="color: #6b97e8;">text</span></p>
<p>        <span style="color: #a04cc1;">yield</span> <span style="color: #6b97e8;">output</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">output</span></p>
<p></p>
<p><span style="color: #6b97e8;">additional_inputs</span><span>=</span><span style="color: #e3e11d;">[</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Textbox</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;System Prompt&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_lines</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Temperature&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">0.9</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">0.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Higher values produce more diverse outputs&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Max new tokens&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #7e7a38;">256</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #7e7a38;">1048</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #7e7a38;">64</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;The maximum numbers of new tokens&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Top-p (nucleus sampling)&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">0.90</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">0.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Higher values sample more low-probability tokens&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Repetition penalty&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">1.2</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #a09e19;">2.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Penalize repeated tokens&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #e3e11d;">]</span></p>
<p></p>
<p><span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">ChatInterface</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">fn</span><span>=</span><span style="color: #6b97e8;">generate</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">chatbot</span><span>=</span><span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Chatbot</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">show_label</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">show_share_button</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">show_copy_button</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">likeable</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">layout</span><span>=</span><span style="color: #7e7a34;">&quot;panel&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">additional_inputs</span><span>=</span><span style="color: #6b97e8;">additional_inputs</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">title</span><span>=</span><span style="color: #7e7a34;">&quot;Mixtral 46.7B&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">concurrency_limit</span><span>=</span><span style="color: #7e7a38;">20</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">launch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">show_api</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/Mixtral-8x7B_huggingface_API-scaled.webp" alt="Mixtral-8x7B huggingface API"></p></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>
