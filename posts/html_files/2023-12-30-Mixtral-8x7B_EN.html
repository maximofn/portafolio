<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Mixture-of-Experts-(MoE)-index">
									<a class="anchor-link" href="#Mixture-of-Experts-(MoE)">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Mixture of Experts (MoE)</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Use-of-Mixtral-8x7b-in-the-cloud-index">
									<a class="anchor-link" href="#Use-of-Mixtral-8x7b-in-the-cloud">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Use of Mixtral-8x7b in the cloud</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Use-of-Mixtral-8x7b-in-huggingface-chat-index">
									<a class="anchor-link" href="#Use-of-Mixtral-8x7b-in-huggingface-chat">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Use of Mixtral-8x7b in huggingface chat</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Using-Mixtral-8x7b-in-Perplexity-Labs-index">
									<a class="anchor-link" href="#Using-Mixtral-8x7b-in-Perplexity-Labs">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Using Mixtral-8x7b in Perplexity Labs</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Using-Mixtral-8x7b-locally-via-the-huggingface-API-index">
									<a class="anchor-link" href="#Using-Mixtral-8x7b-locally-via-the-huggingface-API">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Using Mixtral-8x7b locally via the huggingface API</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/notebooks_translated/2023-12-30-Mixtral-8x7B_EN.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="Mixtral-8x7B-MoE">
								<a class="anchor-link" href="#Mixtral-8x7B-MoE">
									<p style="margin-left: 0px">Mixtral-8x7B MoE</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">For me the best description of <code><b>mixtral-8x7b</b></code> is the following picture</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/mixtral-gemini.webp" alt="mixtral-gemini"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Between the release of <code><b>gemini</b></code> and the release of <code><b>mixtra-8x7b</b></code> there was a difference of only a few days. The first two days after the release of <code><b>gemini</b></code> there was a lot of talk about that model, but as soon as <code><b>mixtral-8x7b</b></code> was released, <code><b>gemini</b></code> was completely forgotten and the whole community was talking about <code><b>mixtral-8x7b</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And no wonder, looking at its benchmarks, we can see that it is at the level of models such as <code><b>llama2-70B</b></code> and <code><b>GPT3.5</b></code>, but with the difference that while <code><b>mixtral-8x7b</b></code> has only 46.7B of parameters, <code><b>llama2-70B</b></code> has 70B and <code><b>GPT3.5</b></code> has 175B.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://mistral.ai/images/news/mixtral-of-experts/overview.png" alt="mixtral benchmarks"></p></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">This notebook has been automatically translated to make it accessible to more people, please let me know if you see any typos.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">## Number of parameters</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As the name suggests, <code><b>mixtral-8x7b</b></code> is a set of 8 models of 7B parameters, so we could think that it has 56B parameters (7Bx8), but it is not. As <a href="https://twitter.com/karpathy/status/1734251375163511203" target="_blank">Andrej Karpathy</a> explains, only the <code><b>Feed forward</b></code> blocks of the transformers are multiplied by 8, the rest of the parameters are shared among the 8 models. So in the end the model has 46.7B parameters.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Mixture-of-Experts-(MoE)">
								<a class="anchor-link" href="#Mixture-of-Experts-(MoE)">
									<p style="margin-left: 10px">Mixture of Experts (MoE)</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As we have said, the model is a set of 8 models of 7B parameters, hence <code><b>MoE</b></code>, which stands for <code><b>Mixture of Experts</b></code>. Each of the 8 models is trained independently, but when inference is done a router decides the output of which model is the one to be used.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">The following image shows the architecture of a <code><b>Transformer</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-scaled.webp" alt="transformer"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">If you don't know it, the important thing is that this architecture consists of an encoder and a decoder.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-encoder-decoder.webp" alt="transformer-encoder-decoder"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">LLMs are decoder-only models, so they do not have an encoder. You can see that in the architecture there are three attention modules, one of them actually connects the encoder to the decoder. But since LLMs do not have an encoder, there is no need for the attention module that connects the decoder and the decoder.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/transformer-decoder.webp" alt="transformer-decoder"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now that we know what the architecture of an LLM looks like, we can see what the architecture of <code><b>mixtral-8x7b</b></code> looks like. In the following image we can see the architecture of the model</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/MoE_architecture-scaled.webp" alt="MoE architecture"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, the architecture consists of a 7B parameter <code><b>Transformer</b></code> decoder, only the <code><b>Feed forward</b></code> layer consists of 8 <code><b>Feed forward</b></code> layers with a router that chooses which of the 8 <code><b>Feed forward</b></code> layers to use. In the above image only four <code><b>Feed forward</b></code> layers are shown, I suppose this is to simplify the diagram, but in reality there are 8 <code><b>Feed forward</b></code> layers. You can also see two paths for two different words, the word <code><b>More</b></code> and the word <code><b>Parameters</b></code> and how the router chooses which <code><b>Feed forward</b></code> to use for each word.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Looking at the architecture we can understand why the model has 46.7B parameters and not 56B. As we have said, only the <code><b>Feed forward</b></code> blocks are multiplied by 8, the rest of the parameters are shared among the 8 models.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Use-of-Mixtral-8x7b-in-the-cloud">
								<a class="anchor-link" href="#Use-of-Mixtral-8x7b-in-the-cloud">
									<p style="margin-left: 10px">Use of Mixtral-8x7b in the cloud</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Unfortunately, using <code><b>mixtral-8x7b</b></code> locally is complicated because the hardware requirements are as follows</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> float32: VRAM > 180 GB, i.e., since each parameter occupies 4 bytes, we need 46.7B </em> 4 = 186.8 GB of VRAM just to store the model, plus the VRAM needed to store the input and output data.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> float16: VRAM > 90 GB, in this case each parameter occupies 2 bytes, so we need 46.7B </em> 2 = 93.4 GB of VRAM just to store the model, plus the VRAM needed to store the input and output data.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> 8-bit: VRAM > 45 GB, here each parameter occupies 1 byte, so we need 46.7B </em> 1 = 46.7 GB of VRAM just to store the model, plus the VRAM needed to store the input and output data.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> <em> 4-bit: VRAM > 23 GB, here each parameter occupies 0.5 bytes, so we need 46.7B </em> 0.5 = 23.35 GB of VRAM just to store the model, plus the VRAM needed to store the input and output data.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We need very powerful GPUs to run it, even when using the 4-bit quantized model.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">So, the easiest way to use <code><b>Mixtral-8x7B</b></code> is to use it already deployed in the cloud. I have found several sites where you can use it</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Use-of-Mixtral-8x7b-in-huggingface-chat">
								<a class="anchor-link" href="#Use-of-Mixtral-8x7b-in-huggingface-chat">
									<p style="margin-left: 20px">Use of Mixtral-8x7b in huggingface chat</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">The first one is in <a href="https://huggingface.co/chat" target="_blank">huggingface chat</a>. To use it you have to click on the cogwheel inside the <code><b>Current Model</b></code> box and select <code><b>Mistral AI - Mixtral-8x7B</b></code>. Once selected, you can start talking to the model.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/huggingface_chat_01.webp" alt="huggingface_chat_01"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Once inside select <code><b>mistralai/Mixtral-8x7B-Instruct-v0.1</b></code> and finally click on the <code><b>Activate</b></code> button. Now we can test the model</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/huggingface_chat_02.webp" alt="huggingface_chat_02"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, I asked him in Spanish what <code><b>MoE</b></code> is and he explained it to me.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Using-Mixtral-8x7b-in-Perplexity-Labs">
								<a class="anchor-link" href="#Using-Mixtral-8x7b-in-Perplexity-Labs">
									<p style="margin-left: 20px">Using Mixtral-8x7b in Perplexity Labs</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Another option is to use <a href="https://labs.perplexity.ai/" target="_blank">Perplexity Labs</a>. Once inside you have to select <code><b>mixtral-8x7b-instruct</b></code> in a drop-down menu in the lower right corner.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/perplexity_labs.webp" alt="perplexity_labs"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, I also asked him in Spanish what <code><b>MoE</b></code> is and he explained it to me.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Using-Mixtral-8x7b-locally-via-the-huggingface-API">
								<a class="anchor-link" href="#Using-Mixtral-8x7b-locally-via-the-huggingface-API">
									<p style="margin-left: 10px">Using Mixtral-8x7b locally via the huggingface API</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">One way to use it locally, whatever HW resources you have, is through the huggingface API. To do this you have to install the <code><b>huggingface-hub</b></code> library of huggingface</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%</span><span style="color: #6b97e8;">pip</span> <span style="color: #6b97e8;">install</span> <span style="color: #6b97e8;">huggingface</span><span>-</span><span style="color: #6b97e8;">hub</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Here is an implementation with <code><b>gradio</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">InferenceClient</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">gradio</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">gr</span></p>
<p></p>
<p><span style="color: #6b97e8;">client</span> <span>=</span> <span style="color: #6b97e8;">InferenceClient</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mistralai/Mixtral-8x7B-Instruct-v0.1&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">format_prompt</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">message</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">):</span></p>
<p>  <span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;&lt;s&gt;&quot;</span></p>
<p>  <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">user_prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bot_response</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;[INST] </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user_prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> [/INST]&quot;</span></p>
<p>    <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot; </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">bot_response</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&lt;/s&gt; &quot;</span></p>
<p>  <span style="color: #6b97e8;">prompt</span> <span>+=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;[INST] </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">message</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> [/INST]&quot;</span></p>
<p>  <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">prompt</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">generate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">system_prompt</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #a09e19;">0.9</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #7e7a38;">256</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #a09e19;">0.95</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">repetition_penalty</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,):</span></p>
<p>    <span style="color: #6b97e8;">temperature</span> <span>=</span> <span style="color: #dfd84a;">float</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">temperature</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">temperature</span> <span>&lt;</span> <span style="color: #a09e19;">1e-2</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">temperature</span> <span>=</span> <span style="color: #a09e19;">1e-2</span></p>
<p>    <span style="color: #6b97e8;">top_p</span> <span>=</span> <span style="color: #dfd84a;">float</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">top_p</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">generate_kwargs</span> <span>=</span> <span style="color: #dfd84a;">dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #6b97e8;">temperature</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #6b97e8;">max_new_tokens</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #6b97e8;">top_p</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">repetition_penalty</span><span>=</span><span style="color: #6b97e8;">repetition_penalty</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">do_sample</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">seed</span><span>=</span><span style="color: #7e7a38;">42</span><span style="color: #e3e11d;">,)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">formatted_prompt</span> <span>=</span> <span style="color: #6b97e8;">format_prompt</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">system_prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">history</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">stream</span> <span>=</span> <span style="color: #6b97e8;">client</span><span>.</span><span style="color: #6b97e8;">text_generation</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">formatted_prompt</span><span style="color: #e3e11d;">,</span> <span>**</span><span style="color: #6b97e8;">generate_kwargs</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">stream</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">details</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_full_text</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #7e7a34;">&quot;&quot;</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">response</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">stream</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">output</span> <span>+=</span> <span style="color: #6b97e8;">response</span><span>.</span><span style="color: #6b97e8;">token</span><span>.</span><span style="color: #6b97e8;">text</span></p>
<p>        <span style="color: #a04cc1;">yield</span> <span style="color: #6b97e8;">output</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">output</span></p>
<p></p>
<p><span style="color: #6b97e8;">additional_inputs</span><span>=</span><span style="color: #e3e11d;">[</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Textbox</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;System Prompt&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_lines</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Temperature&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">0.9</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">0.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Higher values produce more diverse outputs&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Max new tokens&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #7e7a38;">256</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #7e7a38;">1048</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #7e7a38;">64</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;The maximum numbers of new tokens&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Top-p (nucleus sampling)&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">0.90</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">0.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Higher values sample more low-probability tokens&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Slider</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">label</span><span>=</span><span style="color: #7e7a34;">&quot;Repetition penalty&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">value</span><span>=</span><span style="color: #a09e19;">1.2</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">minimum</span><span>=</span><span style="color: #a09e19;">1.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">maximum</span><span>=</span><span style="color: #a09e19;">2.0</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">step</span><span>=</span><span style="color: #a09e19;">0.05</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">interactive</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">info</span><span>=</span><span style="color: #7e7a34;">&quot;Penalize repeated tokens&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #e3e11d;">]</span></p>
<p></p>
<p><span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">ChatInterface</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">fn</span><span>=</span><span style="color: #6b97e8;">generate</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">chatbot</span><span>=</span><span style="color: #6b97e8;">gr</span><span>.</span><span style="color: #6b97e8;">Chatbot</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">show_label</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">show_share_button</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">show_copy_button</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">likeable</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">layout</span><span>=</span><span style="color: #7e7a34;">&quot;panel&quot;</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #6b97e8;">additional_inputs</span><span>=</span><span style="color: #6b97e8;">additional_inputs</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">title</span><span>=</span><span style="color: #7e7a34;">&quot;Mixtral 46.7B&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">concurrency_limit</span><span>=</span><span style="color: #7e7a38;">20</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">launch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">show_api</span><span>=</span><span style="color: #7f6e38;">False</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="http://maximofn.com/wp-content/uploads/2023/12/Mixtral-8x7B_huggingface_API-scaled.webp" alt="Mixtral-8x7B huggingface API"></p></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>
