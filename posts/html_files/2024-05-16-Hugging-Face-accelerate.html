<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Instalación-index">
									<a class="anchor-link" href="#Instalación">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Instalación</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Configuración-index">
									<a class="anchor-link" href="#Configuración">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Configuración</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Entrenamiento-index">
									<a class="anchor-link" href="#Entrenamiento">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Entrenamiento</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Optimización-del-entrenamiento-index">
									<a class="anchor-link" href="#Optimización-del-entrenamiento">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Optimización del entrenamiento</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Código-base-index">
									<a class="anchor-link" href="#Código-base">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Código base</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Script-con-el-código-base-index">
									<a class="anchor-link" href="#Script-con-el-código-base">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Script con el código base</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Código-con-accelerate-index">
									<a class="anchor-link" href="#Código-con-accelerate">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Código con accelerate</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Ejecución-de-procesos-index">
									<a class="anchor-link" href="#Ejecución-de-procesos">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Ejecución de procesos</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Ejecución-de-código-en-un-único-proceso-index">
									<a class="anchor-link" href="#Ejecución-de-código-en-un-único-proceso">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Ejecución de código en un único proceso</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Ejecución-de-código-en-todos-los-procesos-index">
									<a class="anchor-link" href="#Ejecución-de-código-en-todos-los-procesos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Ejecución de código en todos los procesos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Ejecución-de-código-en-el-proceso-X-index">
									<a class="anchor-link" href="#Ejecución-de-código-en-el-proceso-X">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Ejecución de código en el proceso X</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Sincronizar-procesos-index">
									<a class="anchor-link" href="#Sincronizar-procesos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Sincronizar procesos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Guardar-y-cargar-el-state-dict-index">
									<a class="anchor-link" href="#Guardar-y-cargar-el-state-dict">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Guardar y cargar el state dict</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Guardar-el-modelo-index">
									<a class="anchor-link" href="#Guardar-el-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Guardar el modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Guardar-el-modelo-`pretrained`-index">
									<a class="anchor-link" href="#Guardar-el-modelo-`pretrained`">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Guardar el modelo <code><b>pretrained</b></code></p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Entrenamiento-en-notebooks-index">
									<a class="anchor-link" href="#Entrenamiento-en-notebooks">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Entrenamiento en notebooks</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Entrenamiento-en-FP16-index">
									<a class="anchor-link" href="#Entrenamiento-en-FP16">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Entrenamiento en FP16</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Entrenamiento-en-BF16-index">
									<a class="anchor-link" href="#Entrenamiento-en-BF16">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Entrenamiento en BF16</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Entrenamiento-en-FP8-index">
									<a class="anchor-link" href="#Entrenamiento-en-FP8">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Entrenamiento en FP8</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Inferencia-de-modelos-index">
									<a class="anchor-link" href="#Inferencia-de-modelos">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Inferencia de modelos</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Uso-del-ecosistema-de-Hugging-Face-index">
									<a class="anchor-link" href="#Uso-del-ecosistema-de-Hugging-Face">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Uso del ecosistema de Hugging Face</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inferencia-con-`pipeline`-index">
									<a class="anchor-link" href="#Inferencia-con-`pipeline`">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inferencia con <code><b>pipeline</b></code></p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inferencia-con-`AutoClass`-index">
									<a class="anchor-link" href="#Inferencia-con-`AutoClass`">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inferencia con <code><b>AutoClass</b></code></p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Uso-pytorch-index">
									<a class="anchor-link" href="#Uso-pytorch">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Uso pytorch</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Cómo-funciona-accelerate-por-debajo-index">
									<a class="anchor-link" href="#Cómo-funciona-accelerate-por-debajo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Cómo funciona accelerate por debajo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inicialización-de-un-modelo-vacío-index">
									<a class="anchor-link" href="#Inicialización-de-un-modelo-vacío">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inicialización de un modelo vacío</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Carga-de-los-pesos-index">
									<a class="anchor-link" href="#Carga-de-los-pesos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Carga de los pesos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/2024-05-16-Hugging-Face-accelerate.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="Hugging-Face-Accelerate">
								<a class="anchor-link" href="#Hugging-Face-Accelerate">
									<p style="margin-left: 0px">Hugging Face Accelerate</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><code><b>Accelerate</b></code> es una biblioteca de Hugging Face que permite ejecutar el mismo código PyTorch en cualquier configuración distribuida añadiendo sólo cuatro líneas de código.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Instalación">
								<a class="anchor-link" href="#Instalación">
									<p style="margin-left: 10px">Instalación</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para instalar <code><b>accelerate</b></code> con <code><b>pip</b></code> simplemente ejecuta:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>pip install accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y con <code><b>conda</b></code>:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>conda install -c conda-forge accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Configuración">
								<a class="anchor-link" href="#Configuración">
									<p style="margin-left: 10px">Configuración</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En cada entorno en el que se intale <code><b>accelerate</b></code> lo primero que se tiene que hacer es configurarlo, para ello ejecutamos en una terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate config<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>no</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En mi caso las respuestas han sido</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>In which compute environment are you running?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [x] "This machine"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] "AWS (Amazon SageMaker)"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Quiero configurarlo en mi ordenador</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Which type of machine are you using?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-CPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-XPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [x] multi-GPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-NPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] TPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Como tengo 2 GPUs y quiero ejecutar códigos distribuidos en ellas elijo <code><b>multi-GPU</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>How many different machines will you use (use more than 1 for multi-node training)? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Elijo <code><b>1</b></code> porque solo voy a ejecutar en mi ordenador</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Con esta opción, se puede elegir que <code><b>accelerate</b></code> chequee errores en la ejecución, pero haría que vaya más lento, así que elijo <code><b>no</b></code>, y en caso de que haya errores lo cambio a <code><b>yes</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Do you wish to optimize your script with torch dynamo?[yes/NO]:</li>
									<li>Do you want to use FullyShardedDataParallel? [yes/NO]:</li>
									<li>Do you want to use Megatron-LM ? [yes/NO]:</li>
									<li>How many GPU(s) should be used for distributed training? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 2</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Elijo <code><b>2</b></code> porque tengo 2 GPUs</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 0,1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Elijo <code><b>0,1</b></code> porque quiero usar las dos GPUs</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Do you wish to use FP16 or BF16 (mixed precision)?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [x] no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] bf16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp8</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > De momento elijo <code><b>no</b></code>, porque para simplificar el código cuando no uso <code><b>acelerate</b></code> vamos a entrenar en fp32, pero lo ideal sería usar fp16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">La configuración se guardará en <code><b>~/.cache/huggingface/accelerate/default_config.yaml</b></code> y se puede modificar en cualquier momento. Vamos a ver qué hay dentro</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">cat</span> <span>~/.</span><span style="color: #6b97e8;">cache</span><span>/</span><span style="color: #6b97e8;">huggingface</span><span>/</span><span style="color: #6b97e8;">accelerate</span><span>/</span><span style="color: #6b97e8;">default_config</span><span>.</span><span style="color: #6b97e8;">yaml</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>compute_environment: LOCAL_MACHINE</p><p>debug: false</p><p>distributed_type: MULTI_GPU</p><p>downcast_bf16: 'no'</p><p>gpu_ids: 0,1</p><p>machine_rank: 0</p><p>main_training_function: main</p><p>mixed_precision: fp16</p><p>num_machines: 1</p><p>num_processes: 2</p><p>rdzv_backend: static</p><p>same_network: true</p><p>tpu_env: []</p><p>tpu_use_cluster: false</p><p>tpu_use_sudo: false</p><p>use_cpu: false</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Otra forma de ver la configuración que tenemos es ejecutando en una terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate env<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">env</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Copy-and-paste the text below in your GitHub issue</p><p>- `Accelerate` version: 0.28.0</p><p>- Platform: Linux-5.15.0-105-generic-x86_64-with-glibc2.31</p><p>- Python version: 3.11.8</p><p>- Numpy version: 1.26.4</p><p>- PyTorch version (GPU?): 2.2.1+cu121 (True)</p><p>- PyTorch XPU available: False</p><p>- PyTorch NPU available: False</p><p>- System RAM: 31.24 GB</p><p>- GPU type: NVIDIA GeForce RTX 3090</p><p>- `Accelerate` default config:</p><p>	- compute_environment: LOCAL_MACHINE</p><p>	- distributed_type: MULTI_GPU</p><p>	- mixed_precision: fp16</p><p>	- use_cpu: False</p><p>	- debug: False</p><p>	- num_processes: 2</p><p>	- machine_rank: 0</p><p>	- num_machines: 1</p><p>	- gpu_ids: 0,1</p><p>	- rdzv_backend: static</p><p>	- same_network: True</p><p>	- main_training_function: main</p><p>	- downcast_bf16: no</p><p>	- tpu_use_cluster: False</p><p>	- tpu_use_sudo: False</p><p>	- tpu_env: []</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez hemos configurado <code><b>accelerate</b></code> podemos probar si lo hemos hecho bien ejecutando en una terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate test<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Running:  accelerate-launch ~/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/test_utils/scripts/test_script.py</p><p>stdout: **Initialization**</p><p>stdout: Testing, testing. 1, 2, 3.</p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 0</p><p>stdout: Local process index: 0</p><p>stdout: Device: cuda:0</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 1</p><p>stdout: Local process index: 1</p><p>stdout: Device: cuda:1</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: </p><p>stdout: **Test process execution**</p><p>stdout: </p><p>stdout: **Test split between processes as a list**</p><p>stdout: </p><p>stdout: **Test split between processes as a dict**</p><p>stdout: </p><p>stdout: **Test split between processes as a tensor**</p><p>stdout: </p><p>stdout: **Test random number generator synchronization**</p><p>stdout: All rng are properly synched.</p><p>stdout: </p><p>stdout: **DataLoader integration test**</p><p>stdout: 0 1 tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:1') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:0') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: Non-shuffled dataloader passing.</p><p>stdout: Shuffled dataloader passing.</p><p>stdout: Non-shuffled central dataloader passing.</p><p>stdout: Shuffled central dataloader passing.</p><p>stdout: </p><p>stdout: **Training integration test**</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: FP16 training check.</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: **Breakpoint trigger test**</p><p>Test is a success! You are ready for your distributed training!</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que termina diciendo <code><b>Test is a success! You are ready for your distributed training!</b></code> por lo que todo está correcto.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Entrenamiento">
								<a class="anchor-link" href="#Entrenamiento">
									<p style="margin-left: 10px">Entrenamiento</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Optimización-del-entrenamiento">
								<a class="anchor-link" href="#Optimización-del-entrenamiento">
									<p style="margin-left: 20px">Optimización del entrenamiento</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Código-base">
								<a class="anchor-link" href="#Código-base">
									<p style="margin-left: 30px">Código base</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a hacer primero un código de entrenamiento base y luego lo optimizaremos  para ver cómo se hace y cómo mejora</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero vamos a buscar un dataset, en mi caso voy a usar el dataset <a href="https://huggingface.co/datasets/tweet_eval" target="_blank">tweet_eval</a>, que es un dataset de clasificación de tweets, en concreto voy a descargar el subset <code><b>emoji</b></code> que clasifica los tweets con emoticonos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 45000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 50000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetInfo(description='', citation='', homepage='', license='', features={'text': Value(dtype='string', id=None), 'label': ClassLabel(names=['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜'], id=None)}, post_processed=None, supervised_keys=None, task_templates=None, builder_name='parquet', dataset_name='tweet_eval', config_name='emoji', version=0.0.0, splits={'train': SplitInfo(name='train', num_bytes=3808792, num_examples=45000, shard_lengths=None, dataset_name='tweet_eval'), 'test': SplitInfo(name='test', num_bytes=4262151, num_examples=50000, shard_lengths=None, dataset_name='tweet_eval'), 'validation': SplitInfo(name='validation', num_bytes=396704, num_examples=5000, shard_lengths=None, dataset_name='tweet_eval')}, download_checksums={'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/train-00000-of-00001.parquet': {'num_bytes': 2609973, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/test-00000-of-00001.parquet': {'num_bytes': 3047341, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/validation-00000-of-00001.parquet': {'num_bytes': 281994, 'checksum': None}}, download_size=5939308, post_processing_size=None, dataset_size=8467647, size_in_bytes=14406955)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver las clases</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜']</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y el número de clases</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>20</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que el dataset tiene 20 clases</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver la secuencia máxima de cada split</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;train&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;validation&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;test&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_test</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p></p>
<p><span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(142, 139, 167)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Así que definimos la secuencia máximo en general como 130 para la tokeniazción</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A nosotros nos interesa el dataset tokenizado, no las secuencias en crudo, así que creamos un tokenizador</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos una función de tokenización</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y ahora tokenizamos el dataset</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map:   0%|          | 0/50000 [00:00&lt;?, ? examples/s]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como vemos ahora tenemos los tokens (<code><b>input_ids</b></code>) y las máscaras de atención (<code><b>attention_mask</b></code>), pero vamos a ver qué tipo de datos tenemos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(list, list, int)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Tensor, torch.Tensor, torch.Tensor)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos un dataloader</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Cargamos el modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver cómo es el modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>RobertaForSequenceClassification(</p><p>  (roberta): RobertaModel(</p><p>    (embeddings): RobertaEmbeddings(</p><p>      (word_embeddings): Embedding(50265, 768, padding_idx=1)</p><p>      (position_embeddings): Embedding(514, 768, padding_idx=1)</p><p>      (token_type_embeddings): Embedding(1, 768)</p><p>      (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>      (dropout): Dropout(p=0.1, inplace=False)</p><p>    )</p><p>    (encoder): RobertaEncoder(</p><p>      (layer): ModuleList(</p><p>        (0-11): 12 x RobertaLayer(</p><p>          (attention): RobertaAttention(</p><p>            (self): RobertaSelfAttention(</p><p>              (query): Linear(in_features=768, out_features=768, bias=True)</p><p>              (key): Linear(in_features=768, out_features=768, bias=True)</p><p>              (value): Linear(in_features=768, out_features=768, bias=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>            (output): RobertaSelfOutput(</p><p>              (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>              (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>          )</p><p>          (intermediate): RobertaIntermediate(</p><p>            (dense): Linear(in_features=768, out_features=3072, bias=True)</p><p>            (intermediate_act_fn): GELUActivation()</p><p>          )</p><p>          (output): RobertaOutput(</p><p>            (dense): Linear(in_features=3072, out_features=768, bias=True)</p><p>            (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>            (dropout): Dropout(p=0.1, inplace=False)</p><p>          )</p><p>        )</p><p>      )</p><p>    )</p><p>  )</p><p>  (classifier): RobertaClassificationHead(</p><p>    (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>    (dropout): Dropout(p=0.1, inplace=False)</p><p>    (out_proj): Linear(in_features=768, out_features=2, bias=True)</p><p>  )</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver su última capa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=2, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">out_features</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(768, 2)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hemos visto que nuestro dataset tiene 20 clases, pero este modelo está entrenado para 2 clases, así que tenemos que modificar la última capa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=20, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora sí</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora creamos una función de loss</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Un optimizador</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y por último una métrica</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a comprobar que está todo bien con una muestra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span> <span>=</span> <span style="color: #dfd84a;">next</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">iter</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]))</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Size([64, 130]), torch.Size([64, 130]))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora esa muestra se la metemos al modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">ouputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">),</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64, 20])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que el modelo saca 64 batches, lo cual está bien, porque configuramos <code><b>BS = 20</b></code> y cada una con 20 salidas, lo cual está bien porque cambiamos el modelo para que a la salida de 20 valores</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtenemos la de mayor valor</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">predictions</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtenemos la loss</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">item</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>2.9990389347076416</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y el accuracy</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])[</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">accuracy</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>0.015625</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ya podemos crear un pequeño bucle de entrenamiento</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">epochs</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">epochs</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>&lt;IPython.core.display.HTML object&gt;</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Script-con-el-código-base">
								<a class="anchor-link" href="#Script-con-el-código-base">
									<p style="margin-left: 30px">Script con el código base</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En la mayoría de la documentación de <code><b>accelerate</b></code> se explica cómo usar <code><b>accelerate</b></code> con scripts, así que de momento vamos a hacerlo así y al final explicaremos cómo hacerlo con un notebook</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero vamos a crear una carpeta en la que vamos a guardar los scripts</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">mkdir</span> <span style="color: #6b97e8;">accelerate_scripts</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora escribimos el código base en un script</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/01_code_base.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y ahora lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112                                                               </p><p>CPU times: user 2.12 s, sys: 391 ms, total: 2.51 s</p><p>Wall time: 3min 36s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que en mi ordenador ha tardado unos 3 minutos y medio</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Código-con-accelerate">
								<a class="anchor-link" href="#Código-con-accelerate">
									<p style="margin-left: 30px">Código con accelerate</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora reemplazamos algunas cosas</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>En primer lugar importamos <code><b>Accelerator</b></code> y lo inicializamos</li>
									<li>Ya no hacemos el típico</li>
									<li>Sino que dejamos que sea <code><b>acelerate</b></code> el que elija el dispositivo mediante</li>
									<li>Pasamos los elementos relevantes para el entrenamiento por el método <code><b>prepare</b></code> y ya no hacemos <code><b>model.to(device)</b></code></li>
									<li>Ya no mandamos los datos y el modelo a la GPU con <code><b>.to(device)</b></code> ya que <code><b>accelerate</b></code> se ha encargado de ello con el método <code><b>prepare</b></code></li>
									<li>En vez de hacer el backpropagation con <code><b>loss.backward()</b></code> dejamos que lo haga <code><b>accelerate</b></code> con</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>from accelerate import Accelerator<br>accelerator = Accelerator()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>torch.device("cuda" if torch.cuda.is_available() else "cpu")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>device = accelerator.device<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model, optimizer, dataloader["train"], dataloader["validation"] = preprare(model, optimizer, dataloader["train"], dataloader["validation"])<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerator.backward(loss)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>A la hora de calcular la métrica en el bucle de validación, necesitamos recopilar los valores de todos los puntos, en caso de estar haciendo un entrenamiento distribuido, para ello hacemos</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>predictions = accelerator.gather_for_metrics(predictions)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of training epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of validation epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/02_accelerate_base_code.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si te fijas he añadido estas dos líneas <code><b>print(f"End of training epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code> y la línea <code><b>print(f"End of validation epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code>, las he añadido aposta porque nos van a revelar algo muy importante</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora lo ejecutamos, para ejecutar los scripts de <code><b>accelerate</b></code> se hace con el comando <code><b>accelerate launch</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate launch script.py<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>CPU times: user 1.6 s, sys: 272 ms, total: 1.88 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que antes tardó unos 3 minutos y medio y ahora tarda más o menos 2 minutos y medio. Bastante mejora. Además si vemos los <code><b>print</b></code>s podemos ver que se han impreso dos veces.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">¿Y esto cómo puede ser? pues porque <code><b>accelerate</b></code> ha paralelizado el entrenamiento en las dos GPUs que tengo, por lo que ha sido mucho más rápido.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Además, cuando ejecuté el primer script, esd ecir, cuando no usé <code><b>accelerate</b></code>, la GPU estaba casi llena, mientras que cuando he ejecutado el segundo, es decir, el que usa <code><b>accelerate</b></code>, las dos GPUs estaban muy poco utilizadas, por lo que podemos aumentar el batch size para intentar llenar las dos, vamos a ello!</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/03_accelerate_base_code_more_bs.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">He quitado los prints extra, porque ya hemos visto que el código se está ejecutando en las dos GPUs y he aunmentado el batch size de 64 a 128. Lo ejecutamos a ver</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.1052                                                               </p><p>Accuracy = 0.1052</p><p>CPU times: user 1.41 s, sys: 180 ms, total: 1.59 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aumentando el batch size ha bajado unos segundos el tiempo de ejecución</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Ejecución-de-procesos">
								<a class="anchor-link" href="#Ejecución-de-procesos">
									<p style="margin-left: 20px">Ejecución de procesos</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Ejecución-de-código-en-un-único-proceso">
								<a class="anchor-link" href="#Ejecución-de-código-en-un-único-proceso">
									<p style="margin-left: 30px">Ejecución de código en un único proceso</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes hemos visto que los <code><b>print</b></code>s se imprimían dos veces, esto es porque <code><b>accelerate</b></code> crea tantos procesos como dispositivos donde se ejecuta el código, en mi caso crea dos procesos por tener dos GPUs.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Sin embargo no todo el código debería ejecutarse en todos los procesos, por ejemplo los <code><b>print</b></code>s, ralentizan mucho el código, como para ejecutarlo varias veces, si se guardan los checkpoints, se guardarían dos veces, etc.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para poder ejecutar parte de un código en un único proceso se tiene que encapsular en una función y decorarla con <code><b>accelerator.on_local_main_process</b></code>, por ejemplo en el siguiente código vas a ver que he creado la siguiente función</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_main_process<br>def print_something(something):<br>    print(something)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Otra opción es meter el código dentro de un <code><b>if accelerator.is_local_main_process</b></code> como en el siguiente código</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>if accelerator.is_local_main_process:<br>    print("Something")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/04_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ejecutarlo a ver</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2098                                                               </p><p>End of script with 0.2098 accuracy</p><p>CPU times: user 1.38 s, sys: 197 ms, total: 1.58 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora solo se ha impreso el print una vez</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Sin embargo, aunque no se ve mucho, las barras de progreso se ejecutan en cada proceso.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No he encontrado una manera de evitar esto con las barras de progreso de <code><b>fastprogress</b></code>, pero sí con las de <code><b>tqdm</b></code>, así que voy a sustituir las barras de progreso de <code><b>fastprogress</b></code> por las de <code><b>tqdm</b></code> y para que se ejecuten en un único proceso hay que añadirle el argumento <code><b>disable=not accelerator.is_local_main_process</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/05_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [02:01&lt;00:00,  1.45it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.30it/s]</p><p>Accuracy = 0.2166</p><p>End of script with 0.2166 accuracy</p><p>CPU times: user 1.33 s, sys: 195 ms, total: 1.52 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hemos mostrado un ejemplo de cómo imprimir en un solo proceso, y esto ha sido una manera de ejecutar procesos en un solo proceso. Pero si lo que quieres es solo imprimir en un solo proceso se puede usar el método <code><b>print</b></code> de <code><b>accelerate</b></code>. Vamos a ver el mismo ejemplo de antes con este método</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/06_accelerate_base_code_print_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15433.52 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 11406.61 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15036.87 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14932.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14956.60 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.33it/s]</p><p>Accuracy = 0.2134</p><p>End of script with 0.2134 accuracy</p><p>CPU times: user 1.4 s, sys: 189 ms, total: 1.59 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Ejecución-de-código-en-todos-los-procesos">
								<a class="anchor-link" href="#Ejecución-de-código-en-todos-los-procesos">
									<p style="margin-left: 30px">Ejecución de código en todos los procesos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Sin embargo hay código que debe ejecutarse en todos los procesos, por ejemplo si subimos los checkpoints al hub, así que aquí tenemos dos opciones, encapsular el código en una función y decorarla con <code><b>accelerator.on_main_process</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_main_process<br>def do_my_thing():<br>    "Something done once per server"<br>    do_thing_once()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">o meter el código dentro de un <code><b>if accelerator.is_main_process</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>if accelerator.is_main_process:<br>    repo.push_to_hub()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como estamos haciendo entrenamientos solo para mostrar la librería <code><b>accelerate</b></code> y el modelo que estamos entrenando no es bueno, no tiene sentido ahora subir los checkpoints al hub, así que voy a hacer un ejemplo con <code><b>print</b></code>s</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/06_accelerate_base_code_some_code_in_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos a ver</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14518.44 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14368.77 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 16466.33 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14806.14 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14253.33 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14337.07 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.34it/s]</p><p>Accuracy = 0.2092</p><p>End of script with 0.2092 accuracy</p><p>All process: Accuracy = 0.2092</p><p>All process: End of script with 0.2092 accuracy</p><p>CPU times: user 1.42 s, sys: 216 ms, total: 1.64 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Ejecución-de-código-en-el-proceso-X">
								<a class="anchor-link" href="#Ejecución-de-código-en-el-proceso-X">
									<p style="margin-left: 30px">Ejecución de código en el proceso X</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por último podemos especificar en qué proceso queremos ejecutar código, para esto hay que crear una función y decorarla con <code><b>@accelerator.on_process(process_index=0)</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_process(process_index=0)<br>def do_my_thing():<br>    "Something done on process index 0"<br>    do_thing_on_index_zero()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">o decorarla con <code><b>@accelerator.on_local_process(local_process_idx=0)</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_process(local_process_index=0)<br>def do_my_thing():<br>    "Something done on process index 0 on each server"<br>    do_thing_on_index_zero_on_each_server()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aquí he puesto el proceso 0, pero se puede poner cualquier número</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/07_accelerate_base_code_some_code_in_some_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15735.58 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14906.20 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:02&lt;00:00,  1.44it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.27it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.2128</p><p>End of script with 0.2128 accuracy</p><p>All process: Accuracy = 0.2128</p><p>All process: End of script with 0.2128 accuracy</p><p>Process 0: End of process 0</p><p>CPU times: user 1.42 s, sys: 295 ms, total: 1.71 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Sincronizar-procesos">
								<a class="anchor-link" href="#Sincronizar-procesos">
									<p style="margin-left: 30px">Sincronizar procesos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si tenemos código que debe ejecutarse en todos los procesos, es interesante esperar a que termine en todos los procesos antes de hacer otra tarea, así que para ello usamos <code><b>accelerator.wait_for_everyone()</b></code></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para verlo vamos a meter un retardo en una de las funciones de imprimir en un proceso</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Además he puesto un break en el bucle de entrenamiento para que no esté mucho tiempo entrenando, que no es lo que ahora nos interesa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">time</span><span>.</span><span style="color: #6b97e8;">sleep</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #a04cc1;">break</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Printing with delay in process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of script&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/08_accelerate_base_code_sync_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14218.23 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14666.25 examples/s]</p><p>  0%|                                                   | 0/176 [00:00&lt;?, ?it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.58it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.212</p><p>End of script with 0.212 accuracy</p><p>All process: Accuracy = 0.212</p><p>All process: End of script with 0.212 accuracy</p><p>Printing with delay in process 0</p><p>Process 0: End of process 0</p><p>End of script</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver primero se ha impreso <code><b>Process 1: End of process 1</b></code> y luego el resto, esto es porque el resto de prints se hacen o en el proceso 0 o en todos los procesos, así que hasta que no termine el delay de 2 segundos que hemos puesto no se ejecuta el resto de código</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Guardar-y-cargar-el-state-dict">
								<a class="anchor-link" href="#Guardar-y-cargar-el-state-dict">
									<p style="margin-left: 20px">Guardar y cargar el state dict</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Cuando entrenamos, a veces guardamos el estado para poder seguir en otro momento</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para guardar el estado tendremos que usar los métodos <code><b>save_state()</b></code> y <code><b>load_state()</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos los pesos</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Cargamos los pesos</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">load_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_accelerate_save_and_load_checkpoints.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.40it/s]</p><p>Accuracy = 0.2142</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Guardar-el-modelo">
								<a class="anchor-link" href="#Guardar-el-modelo">
									<p style="margin-left: 20px">Guardar el modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Cuando se usó el método <code><b>prepare</b></code> se envolvió el modelo para poder guardarlo en los dispositivos necesarios. Por lo que a la hora de guardarlo tenemos que usar el método <code><b>save_model</b></code> que primero lo desenvuelve y luego lo guarda. Además si usamos el parámetro <code><b>safe_serialization=True</b></code> se guardará el modelo como un <code><b>safe tensor</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">safe_serialization</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_model.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.35it/s]</p><p>Accuracy = 0.214</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Guardar-el-modelo-`pretrained`">
								<a class="anchor-link" href="#Guardar-el-modelo-`pretrained`">
									<p style="margin-left: 20px">Guardar el modelo <code><b>pretrained</b></code></p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En modelos que usan la librería <code><b>transformers</b></code> debemos guardar el modelo con el método <code><b>save_pretrained</b></code> para poder cargarlo con el método <code><b>from_pretrained</b></code>. Antes de guardarlo hay que desenvolverlo con el método <code><b>unwrap_model</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo pretrained</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">unwrap_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span><span>.</span><span style="color: #6b97e8;">save_pretrained</span><span style="color: #e3e11d;">(</span></p>
<p>        <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">is_main_process</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">save_function</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_pretrained.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15152.47 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15119.13 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12724.70 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12397.49 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15247.21 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15138.03 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:59&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.37it/s]</p><p>Accuracy = 0.21</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora lo podríamos cargar</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModel</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoModel</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of RobertaModel were not initialized from the model checkpoint at accelerate_scripts/model_pretrained and are newly initialized: ['roberta.pooler.dense.bias', 'roberta.pooler.dense.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Entrenamiento-en-notebooks">
								<a class="anchor-link" href="#Entrenamiento-en-notebooks">
									<p style="margin-left: 20px">Entrenamiento en notebooks</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hasta ahora hemos visto cómo ejecutar scripts, pero si quieres ejecutar el código en un notebook, podemos escribir el mismo código de antes, pero encapsulado en una función</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero importamos las librerás</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p><span style="color: #7f6e38;"># from accelerate import Accelerator</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora creamos la función</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">train_code</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">batch_size</span><span style="color: #e3e11d;">:</span> <span style="color: #dfd84a;">int</span> <span>=</span> <span style="color: #7e7a38;">64</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #6b97e8;">batch_size</span></p>
<p>    <span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p>    <span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p>    <span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># model.to(device)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>            <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>                <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>        </p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para poder ejecutar el entrenamiento en el notebook usamos la funcion <code><b>notebook_launcher</b></code>, al que le pasamos la función que queremos ejecutar, los argumentos de esa función y el número de GPUs en las que vamos a entrenar con la variable <code><b>num_processes</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_launcher</span></p>
<p></p>
<p><span style="color: #6b97e8;">args</span> <span>=</span> <span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">128</span><span style="color: #e3e11d;">,)</span></p>
<p><span style="color: #6b97e8;">notebook_launcher</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">train_code</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">args</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_processes</span><span>=</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Entrenamiento-en-FP16">
								<a class="anchor-link" href="#Entrenamiento-en-FP16">
									<p style="margin-left: 20px">Entrenamiento en FP16</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Cuando al principio configuramos <code><b>accelerate</b></code> nos preguntó <code><b>Do you wish to use FP16 or BF16 (mixed precision)?</b></code> y dijimos que no, así que ahora vamos a decirle que sí, que queremos en FP16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hasta ahora hemos entrenado en FP32, lo que quiere decir que cada peso del modelo es un número en coma flotante de 32 bits, y ahora vamos a usar un número en coma flotante de 16 bits, es decir, el modelo va a ocupar menos. Por lo que van a pasar dos cosas, podremos usar un batch size mayor y además será más rápido</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero volvemos a lanzar <code><b>accelerate config</b></code> y le vamos a decir que queremos FP16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora creamos un script para entrenar, con el mismo batch size de antes, para ver si tarda menos en entrenar</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/12_accelerate_base_code_fp16_bs128.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos a ver cuanto tarda</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14983.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14315.47 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:01&lt;00:00,  2.88it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:02&lt;00:00,  6.84it/s]</p><p>Accuracy = 0.2094</p><p>CPU times: user 812 ms, sys: 163 ms, total: 976 ms</p><p>Wall time: 1min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Cuando ejecutamos este entrenamiento en FP32 tardó unos 2 minutos y medio, y ahora más o menos 1 minuto y medio. Vamos a ver si ahora en vez de entrenar con un batch size de 128, lo hacemos con uno de 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">256</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/13_accelerate_base_code_fp16_bs256.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15390.30 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14990.92 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:54&lt;00:00,  1.62it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:02&lt;00:00,  3.45it/s]</p><p>Accuracy = 0.2236</p><p>CPU times: user 670 ms, sys: 91.6 ms, total: 761 ms</p><p>Wall time: 1min 12s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ha bajado solo unos 15 segundos</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Entrenamiento-en-BF16">
								<a class="anchor-link" href="#Entrenamiento-en-BF16">
									<p style="margin-left: 20px">Entrenamiento en BF16</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes hemos entrenado en FP16 y ahora lo vamos a hacer en BF16, ¿Cuál es la diferencia?</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://pub-fb664c455eca46a2ba762a065ac900f7.r2.dev/FP32_FP16_BF16.webp" alt="FP32_FP16_BF16"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como podemos ver en la imagen, mientras que FP16 en comparación con FP32 tiene menos bits en la mantisa y el exponente, lo que hace que su rango sea mucho menor, BF16 en comparación con FP32 tiene el mismo número de bits del exponente pero menos en la mantisa, lo que hace que BF16 tenga el mismo rango de números que FP32, pero es menos preciso</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Esto es beneficioso porque en FP16 algunos cálculos podrían dar números muy altos, que en formato FP16 no se podrían representar. Además hay ciertos dispositivos HW que están optimizados para este formato</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Al igual que antes ejecutamos <code><b>accelerate config</b></code> y le indicamos que queremos BF16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>bf16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora ejecutamos el último script que habíamos creado, es decir con un batch size de 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14814.95 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14506.83 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:51&lt;00:00,  1.70it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:03&lt;00:00,  3.21it/s]</p><p>Accuracy = 0.2112</p><p>CPU times: user 688 ms, sys: 144 ms, total: 832 ms</p><p>Wall time: 1min 17s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ha tardado un tiempo similar a lo que tardó antes, lo cual es normal, ya que hemos entrenado un modelo con pesos de 16 bits, al igual que antes</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Entrenamiento-en-FP8">
								<a class="anchor-link" href="#Entrenamiento-en-FP8">
									<p style="margin-left: 20px">Entrenamiento en FP8</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora vamos a entrenar en formato FP8, que como su nombre indica, es un formato de coma flotante, donde cada peso tiene 8 bits, por lo que ejecutamos <code><b>accelerate config</b></code> para decirle que queremos FP8</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp8</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora ejecutamos el último script, el de batch size de 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>[2024-05-13 21:40:56,455] torch.distributed.elastic.multiprocessing.api: [ERROR] failed (exitcode: 1) local_rank: 0 (pid: 501480) of binary: /home/wallabot/miniconda3/envs/nlp/bin/python</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/miniconda3/envs/nlp/bin/accelerate", line 8, in &lt;module&gt;</p><p>    sys.exit(main())</p><p>             ^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/accelerate_cli.py", line 46, in main</p><p>    args.func(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 1048, in launch_command</p><p>    multi_gpu_launcher(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 702, in multi_gpu_launcher</p><p>    distrib_run.run(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/run.py", line 803, in run</p><p>    elastic_launch(</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 135, in __call__</p><p>    return launch_agent(self._config, self._entrypoint, list(args))</p><p>           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 268, in launch_agent</p><p>    raise ChildFailedError(</p><p>torch.distributed.elastic.multiprocessing.errors.ChildFailedError: </p><p>============================================================</p><p>accelerate_scripts/13_accelerate_base_code_fp16_bs256.py FAILED</p><p>------------------------------------------------------------</p><p>Failures:</p><p>[1]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 1 (local_rank: 1)</p><p>  exitcode  : 1 (pid: 501481)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>------------------------------------------------------------</p><p>Root Cause (first observed failure):</p><p>[0]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 0 (local_rank: 0)</p><p>  exitcode  : 1 (pid: 501480)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>============================================================</p><p>CPU times: user 65.1 ms, sys: 14.5 ms, total: 79.6 ms</p><p>Wall time: 7.24 s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como los pesos ahora son de 8 bits y ocupan la mitad de memoria vamos a subir el batch size a 512</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">512</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/15_accelerate_base_code_fp8_bs512.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo ejecutamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Inferencia-de-modelos">
								<a class="anchor-link" href="#Inferencia-de-modelos">
									<p style="margin-left: 10px">Inferencia de modelos</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Uso-del-ecosistema-de-Hugging-Face">
								<a class="anchor-link" href="#Uso-del-ecosistema-de-Hugging-Face">
									<p style="margin-left: 20px">Uso del ecosistema de Hugging Face</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver cómo hacer inferencia de grandes modelos con la librería <code><b>transformers</b></code> de hugging face.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inferencia-con-`pipeline`">
								<a class="anchor-link" href="#Inferencia-con-`pipeline`">
									<p style="margin-left: 30px">Inferencia con <code><b>pipeline</b></code></p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si usamos el ecosistema de Hugging Face es muy sencillo, ya que todo se produce por debajo sin tener que hacer nosotros mucho. En el caso de usar <code><b>pipeline</b></code>, que es la manera más sencilla de hacer inferencia con la librería <code><b>transformers</b></code>, simplemente tenemos que decirle el modelo que queremos usar y muy importante, pasarle <code><b>device_map="auto"</b></code>. Esto hará que por debajo <code><b>accelerate</b></code> distribuya el modelo entre las distintas GPUs, RAM de la CPU o disco duro si es necesario</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hay más posibles valores para <code><b>device_map</b></code>, que los veremos más adelante, pero de momento quédate con <code><b>"auto"</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a usar el modelo <code><b>Llama3 8B</b></code>, que como su nombre indica es un modelo de unos 8 mil millones de parámetros, como cada parámetro por defecto está en formato FP32, que corresponde a 4 bytes (32 bits), eso quiere decir que si multiplicamos 8 mil millones de parámetros por 4 bytes, nos queda que necesitaría una GPU con unos 32 GB de VRAM.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En mi caso tengo 2 GPUs de 24 GB de VRAM, por lo que no entraría en una sola GPU. Pero gracias a poner <code><b>device_map="auto"</b></code>, accelerate desitribuirá el modelo entre las dos GPUs y podré realizar la inferencia</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_inference_with_pipeline.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora lo ejecutamos, solo que como pipeline usa por debajo accelerate, no necesitamos ejecutarlo con <code><b>acelerate launch script.py</b></code> sino que con <code><b>python script.py</b></code> vale</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.27s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>[{'generated_text': 'Conoces accelerate de hugging face? ¿Qué es el modelo de lenguaje de transformers y cómo se utiliza en el marco de hugging face? ¿Cómo puedo utilizar modelos de lenguaje de transformers en mi aplicación? ¿Qué son los tokenizers y cómo se utilizan en el marco de hugging face? ¿Cómo puedo crear un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los datasets y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar datasets para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning'}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver, no ha respondido, sino que ha seguido haciendo preguntas. Esto es porque Llama3 es un modelo de lenguaje que lo que hace es predecir el siguiente token, así que con el prompt que le he pasado, ha considerado que los siguientes mejores tokens son unos que corresponden a más preguntas. Lo cual tiene sentido, porque hay veces que la gente tiene dudas sobre un tema y genera muchas preguntas, así que para que nos conteste a la pregunta hay que condicionarle un poco</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">messages</span> <span>=</span> <span style="color: #e3e11d;">[</span></p>
<p>    <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;system&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;Eres un chatbot amigable que siempre intenta solucionar las dudas&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">},</span></p>
<p>    <span style="color: #e3e11d;">{</span><span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;user&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">},</span></p>
<p><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">messages</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #8d783e;">&#39;generated_text&#39;</span><span style="color: #e3e11d;">][</span><span>-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/10_inference_with_pipeline_condition.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como ves se ha generado un mensaje con roles, condicionando el modelo y con el prompt</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.41s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>{'role': 'assistant', 'content': '¡Hola!\n\nSí, conozco Accelerate de Hugging Face. Accelerate es una biblioteca de Python desarrollada por Hugging Face que se enfoca en simplificar y acelerar el entrenamiento y la evaluación de modelos de lenguaje en diferentes dispositivos y entornos.\n\nCon Accelerate, puedes entrenar modelos de lenguaje en diferentes plataformas y dispositivos, como GPUs, TPUs, CPUs y servidores, sin necesidad de cambiar el código de tu modelo. Esto te permite aprovechar al máximo la potencia de cálculo de tus dispositivos y reducir el tiempo de entrenamiento.\n\nAccelerate también ofrece varias características adicionales, como:\n\n* Soporte para diferentes frameworks de machine learning, como TensorFlow, PyTorch y JAX.\n* Integración con diferentes sistemas de almacenamiento y procesamiento de datos, como Amazon S3 y Google Cloud Storage.\n* Soporte para diferentes protocolos de comunicación, como HTTP y gRPC.\n* Herramientas para monitorear y depurar tus modelos en tiempo real.\n\nEn resumen, Accelerate es una herramienta muy útil para desarrolladores de modelos de lenguaje que buscan simplificar y acelerar el proceso de entrenamiento y evaluación de sus modelos.\n\n¿Tienes alguna pregunta específica sobre Accelerate o necesitas ayuda para implementarlo en tu proyecto?'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora la respuesta si responde nuestro prompt</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inferencia-con-`AutoClass`">
								<a class="anchor-link" href="#Inferencia-con-`AutoClass`">
									<p style="margin-left: 30px">Inferencia con <code><b>AutoClass</b></code></p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por último vamos a ver cómo hacer la inferencia solo con <code><b>AutoClass</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TextStreamer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">streamer</span> <span>=</span> <span style="color: #6b97e8;">TextStreamer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">tokens_input</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">([</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">_</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">generate</span><span style="color: #e3e11d;">(</span><span>**</span><span style="color: #6b97e8;">tokens_input</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">streamer</span><span>=</span><span style="color: #6b97e8;">streamer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #7e7a38;">500</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">do_sample</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">50</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #a09e19;">0.95</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #a09e19;">0.7</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/11_inference_with_autoclass.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como se puede ver, se ha creado el objeto <code><b>streamer</b></code> que luego se le pasa al método <code><b>generate</b></code> del modelo. Esto es útil para que se vaya imprimiendo cada palabra a medida que se va generando y no haya que esperar a que se genere toda la salida para imprimirla</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.28s/it]</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>&lt;|begin_of_text|&gt;Conoces accelerate de hugging face? Si es así, puedes utilizar la biblioteca `transformers` de Hugging Face para crear un modelo de lenguaje que pueda predecir la siguiente palabra en una secuencia de texto.</p><p>Aquí te muestro un ejemplo de cómo hacerlo:</p><p>```</p><p>import pandas as pd</p><p>import torch</p><p>from transformers import AutoModelForSequenceClassification, AutoTokenizer</p><p># Cargar el modelo y el tokenizador</p><p>model_name = "bert-base-uncased"</p><p>model = AutoModelForSequenceClassification.from_pretrained(model_name)</p><p>tokenizer = AutoTokenizer.from_pretrained(model_name)</p><p># Cargar el conjunto de datos</p><p>train_df = pd.read_csv("train.csv")</p><p>test_df = pd.read_csv("test.csv")</p><p># Preprocesar los datos</p><p>train_texts = train_df["text"]</p><p>train_labels = train_df["label"]</p><p>test_texts = test_df["text"]</p><p># Convertir los textos en entradas para el modelo</p><p>train_encodings = tokenizer.batch_encode_plus(train_texts, </p><p>                                              add_special_tokens=True, </p><p>                                              max_length=512, </p><p>                                              return_attention_mask=True, </p><p>                                              return_tensors='pt')</p><p>test_encodings = tokenizer.batch_encode_plus(test_texts, </p><p>                                             add_special_tokens=True, </p><p>                                             max_length=512, </p><p>                                             return_attention_mask=True, </p><p>                                             return_tensors='pt')</p><p># Crear un dataloader para entrenar el modelo</p><p>train_dataset = torch.utils.data.TensorDataset(train_encodings["input_ids"], </p><p>                                               train_encodings["attention_mask"], </p><p>                                               torch.tensor(train_labels))</p><p>train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=32, shuffle=True)</p><p># Entrenar el modelo</p><p>device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</p><p>model.to(device)</p><p>criterion = torch.nn.CrossEntropyLoss()</p><p>optimizer = torch.optim.Adam(model.parameters(), lr=1e-5)</p><p>for epoch in range(5):</p><p>    model.train()</p><p>    total_loss = 0</p><p>    for batch in train_loader:</p><p>        input_ids = batch[0].to(device)</p><p>        attention_mask = batch[1].to(device)</p><p>        labels = batch[2].to(device)</p><p>        optimizer.zero_grad()</p><p>        outputs = model(input_ids, attention_mask=attention_mask, labels=labels)</p><p>        loss = criterion(outputs, labels)</p><p>        loss.backward()</p><p>        optimizer.step()</p><p>        total_loss += loss.item()</p><p>    print(f"Epoch {epoch+1}, Loss: {total</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Uso-pytorch">
								<a class="anchor-link" href="#Uso-pytorch">
									<p style="margin-left: 20px">Uso pytorch</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Normalmente la manera de hacer inferencias con pytorch es crear un modelo con los pesos inicializados aleatoriamente y a continuación cargar un <code><b>state dict</b></code> con los pesos del modelo preentrenado, así que para obtener ese <code><b>state dict</b></code> vamos a hacer primero una pequeña trampa y nos los vamos a descargar</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">weights</span><span>=</span><span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">ResNet152_Weights</span><span>.</span><span style="color: #6b97e8;">IMAGENET1K_V1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">(),</span> <span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Downloading: "https://download.pytorch.org/models/resnet152-394f9c45.pth" to /home/maximo.fernandez/.cache/torch/hub/checkpoints/resnet152-394f9c45.pth</p><p>100%|██████████| 230M/230M [02:48&lt;00:00, 1.43MB/s] </p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora que tenemos el <code><b>state dict</b></code> vamos a hacer inferencia como se hace normalmente en pytorch</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span>     <span style="color: #7f6e38;"># Set device</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Create model with random weights and move to device</span></p>
<p><span style="color: #6b97e8;">state_dict</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">map_location</span><span>=</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load pretrained weights into device memory</span></p>
<p><span style="color: #6b97e8;">resnet152</span><span>.</span><span style="color: #6b97e8;">load_state_dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load this weights into the model</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a explicar qué ha pasado</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Cuando hemos hecho <code><b>resnet152 = models.resnet152().to(device)</b></code> se ha cargado una resnet152 con pesos aleatorios en la memoria de la GPU</li>
									<li>Cuando hemos hecho <code><b>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)</b></code> se ha cargado un diccionario con los pesos entrenados en la memoria de la GPU</li>
									<li>Cuando hemos hecho <code><b>resnet152.load_state_dict(state_dict)</b></code> se han asignado esos pesos preentrenados al modelo</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Es decir se ha cargado dos veces el modelo en la memoria de la GPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Te puedes estar preguntando por qué hemos hecho primero </p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br>torch.save(model.state_dict(), 'accelerate_scripts/resnet152_pretrained.pth')<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para luego hacer</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>resnet152 = models.resnet152().to(device)<br>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)<br>resnet152.load_state_dict(state_dict)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y por que no usamos directamente</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y nos dejamos de guardar el <code><b>state dict</b></code> para luego cargarlo. Bueno, pues porque Pytorch, por edbajo hace lo mismo que hemos hecho. Así que para poder ver todo el proceso hemos hecho en varias lineas lo que Pytorch hace en una</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Esta manera de trabajar ha funcionado bien hasta ahora, mientras que los modelos tenían un tamaño manejable por las GPUs de usuario. Pero desde la llegada de los LLMs este enfoque no tiene sentido</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por ejemplo un modelo de 6B de parámetros ocuparía en la memoria 24 GB, y como se carga dos veces con esta manera de trabajar haría falta tener una GPU de 48 GB.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Así que para arreglar esto, la manera de cargar un modelo preentrenado de Pytorch es:</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Crear un modelo vacío con <code><b>init_empty_weights</b></code> que no ocupará RAM</li>
									<li>Luego cargar los pesos con <code><b>load_checkpoint_and_dispatch</b></code> que cargará un punto de control dentro del modelo vacío y distribuirá los pesos para cada capa en todos los dispositivos que se tenga disponibles (GPU, CPU RAM y disco duro), gracias a poner <code><b>device_map="auto"</b></code></li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">checkpoint</span><span>=</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Cómo-funciona-accelerate-por-debajo">
								<a class="anchor-link" href="#Cómo-funciona-accelerate-por-debajo">
									<p style="margin-left: 20px">Cómo funciona accelerate por debajo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En este vídeo se puede ver gráficamente cómo funciona accelerate por debajo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><iframe width="1280" height="720" src="https://www.youtube.com/embed/MWCSGj9jEAo" title="Accelerate Big Model Inference: How Does it Work?" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inicialización-de-un-modelo-vacío">
								<a class="anchor-link" href="#Inicialización-de-un-modelo-vacío">
									<p style="margin-left: 30px">Inicialización de un modelo vacío</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><code><b>Accelerate</b></code> crea el esqueleto de un modelo vacío mediante <code><b>init_empty_weights</b></code> para que ocupe la menor cantidad de memoria posible</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por ejemplo, veamos cuanta RAM tengo ahora disponible en mi ordenador</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">psutil</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">get_ram_info</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">ram</span> <span>=</span> <span style="color: #dfd84a;">dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">psutil</span><span>.</span><span style="color: #6b97e8;">virtual_memory</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">_asdict</span><span style="color: #e3e11d;">())</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;total&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Available RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;available&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Used RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;used&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.62 GB, Used RAM: 7.82 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Tengo unos 22 GB de RAM disponibles</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora vamos a intentar crear un modelo 5000x1000x1000 parámetros, es decir de 5B de parámetros, si cada parámetro está en FP32, supone 20 GB de RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">nn</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si volvemos a ver la RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 3.77 GB, Used RAM: 26.70 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como vemos ahora solo tenemos 3 GB de RAM disponibles</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora vamos a eliminar el modelo para liberar RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">del</span> <span style="color: #6b97e8;">model</span></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.44 GB, Used RAM: 8.03 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Volvemos a tener unos 22 GB de RAM disponibles</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ahora a usar <code><b>init_empty_weights</b></code> de <code><b>accelerate</b></code> y luego vemos la RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.32 GB, Used RAM: 8.16 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes teníamos exactamente 22.44 GB libres y tras crear el modelo con <code><b>init_empty_weights</b></code> tenemos 22.32 GB. El ahorro en RAM es enorme! Casi no se ha ocupado RAM para crear el modelo.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Esto se basa en el metadispositivo introducido en PyTorch 1.9, por lo que es importante que para usar <code><b>accelerate</b></code> tengamos una versión de Pytorch posterior</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Carga-de-los-pesos">
								<a class="anchor-link" href="#Carga-de-los-pesos">
									<p style="margin-left: 30px">Carga de los pesos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez hemos inicializado el modelo tenemos que cargarle los pesos que lo hacemos mediante <code><b>load_checkpoint_and_dispatch</b></code> que como su nombre indica carga los pesos y los envía al dispositivo o dispositivos que sea necesario</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>

