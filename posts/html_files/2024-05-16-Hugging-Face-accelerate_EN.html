<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Configuration-index">
									<a class="anchor-link" href="#Configuration">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Configuration</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Training-index">
									<a class="anchor-link" href="#Training">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Training</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Training-optimization-index">
									<a class="anchor-link" href="#Training-optimization">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Training optimization</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Base-code-index">
									<a class="anchor-link" href="#Base-code">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Base code</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Script-with-the-code-base-index">
									<a class="anchor-link" href="#Script-with-the-code-base">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Script with the code base</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Code-with-accelerate-index">
									<a class="anchor-link" href="#Code-with-accelerate">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Code with accelerate</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Process-execution-index">
									<a class="anchor-link" href="#Process-execution">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Process execution</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Execution-of-code-in-a-single-process-index">
									<a class="anchor-link" href="#Execution-of-code-in-a-single-process">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Execution of code in a single process</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Code-execution-in-all-processes-index">
									<a class="anchor-link" href="#Code-execution-in-all-processes">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Code execution in all processes</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Execution-of-code-in-the-process-X-index">
									<a class="anchor-link" href="#Execution-of-code-in-the-process-X">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Execution of code in the process X</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Synchronize-processes-index">
									<a class="anchor-link" href="#Synchronize-processes">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Synchronize processes</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Save-and-load-the-state-dict-index">
									<a class="anchor-link" href="#Save-and-load-the-state-dict">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Save and load the state dict</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Save-the-model-index">
									<a class="anchor-link" href="#Save-the-model">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Save the model</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Save-the-`pretrained`-model-index">
									<a class="anchor-link" href="#Save-the-`pretrained`-model">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Save the <code><b>pretrained</b></code> model</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Training-on-notebooks-index">
									<a class="anchor-link" href="#Training-on-notebooks">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Training on notebooks</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Training-in-FP16-index">
									<a class="anchor-link" href="#Training-in-FP16">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Training in FP16</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="BF16-Training-index">
									<a class="anchor-link" href="#BF16-Training">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">BF16 Training</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Training-in-FP8-index">
									<a class="anchor-link" href="#Training-in-FP8">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Training in FP8</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Model-inference-index">
									<a class="anchor-link" href="#Model-inference">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Model inference</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Using-the-Hugging-Face-Ecosystem-index">
									<a class="anchor-link" href="#Using-the-Hugging-Face-Ecosystem">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Using the Hugging Face Ecosystem</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inference-with-`pipeline`.-index">
									<a class="anchor-link" href="#Inference-with-`pipeline`.">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inference with <code><b>pipeline</b></code>.</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inference-with-`AutoClass`-index">
									<a class="anchor-link" href="#Inference-with-`AutoClass`">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inference with <code><b>AutoClass</b></code></p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Use-pytorch-index">
									<a class="anchor-link" href="#Use-pytorch">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Use pytorch</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="How-accelerate-works-below-index">
									<a class="anchor-link" href="#How-accelerate-works-below">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">How accelerate works below</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Initialization-of-an-empty-model-index">
									<a class="anchor-link" href="#Initialization-of-an-empty-model">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Initialization of an empty model</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Loading-weights-index">
									<a class="anchor-link" href="#Loading-weights">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Loading weights</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/notebooks_translated/2024-05-16-Hugging-Face-accelerate_EN.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="Hugging-Face-Accelerate">
								<a class="anchor-link" href="#Hugging-Face-Accelerate">
									<p style="margin-left: 0px">Hugging Face Accelerate</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Accelerate is a Hugging Face library that allows you to run the same PyTorch code in any distributed configuration by adding only four lines of code.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">This notebook has been automatically translated to make it accessible to more people, please let me know if you see any typos.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">## Installation</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">To install <code><b>accelerate</b></code> with <code><b>pip</b></code> simply run:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>pip install accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And with <code><b>conda</b></code>:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>conda install -c conda-forge accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Configuration">
								<a class="anchor-link" href="#Configuration">
									<p style="margin-left: 10px">Configuration</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In every environment in which <code><b>accelerate</b></code> is installed, the first thing to do is to configure it, for that we execute in a terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate config<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>no</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In my case the answers have been</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>In which compute environment are you running?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [x] "This machine"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] "AWS (Amazon SageMaker)"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > I want to configure it on my computer</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Which type of machine are you using?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-CPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-XPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - x] multi-GPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-NPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] TPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > As I have 2 GPUs and I want to run distributed codes on them I choose <code><b>multi-GPU</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>How many different machines will you use (use more than 1 for multi-node training)? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > I choose <code><b>1</b></code> because I am only going to run on my computer.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > With this option, you can choose to have <code><b>accelerate</b></code> check for errors on execution, but it would slow it down, so I choose <code><b>no</b></code>, and in case there are errors I change it to <code><b>yes</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Do you wish to optimize your script with torch dynamo? [yes/NO]:</li>
									<li>Do you want to use FullyShardedDataParallel? [yes/NO]:</li>
									<li>Do you want to use Megatron-LM ? [yes/NO]:</li>
									<li>How many GPU(s) should be used for distributed training? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > I choose <code><b>2</b></code> because I have 2 GPUs</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 0,1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > I choose <code><b>0,1</b></code> because I want to use both GPUs.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Do you wish to use FP16 or BF16 (mixed precision)?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - x] no</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] bf16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp8</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > For the moment I choose <code><b>no</b></code>, because to simplify the code when not using <code><b>accelerate</b></code> we are going to train on fp32, but ideally we should use fp16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">The configuration will be stored in <code><b>~/.cache/huggingface/accelerate/default_config.yaml</b></code> and can be modified at any time. Let's see what's inside</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">cat</span> <span>~/.</span><span style="color: #6b97e8;">cache</span><span>/</span><span style="color: #6b97e8;">huggingface</span><span>/</span><span style="color: #6b97e8;">accelerate</span><span>/</span><span style="color: #6b97e8;">default_config</span><span>.</span><span style="color: #6b97e8;">yaml</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>compute_environment: LOCAL_MACHINE</p><p>debug: false</p><p>distributed_type: MULTI_GPU</p><p>downcast_bf16: 'no'</p><p>gpu_ids: 0,1</p><p>machine_rank: 0</p><p>main_training_function: main</p><p>mixed_precision: fp16</p><p>num_machines: 1</p><p>num_processes: 2</p><p>rdzv_backend: static</p><p>same_network: true</p><p>tpu_env: []</p><p>tpu_use_cluster: false</p><p>tpu_use_sudo: false</p><p>use_cpu: false</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Another way to see the configuration we have is to run it in a terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate env<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">env</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Copy-and-paste the text below in your GitHub issue</p><p>- `Accelerate` version: 0.28.0</p><p>- Platform: Linux-5.15.0-105-generic-x86_64-with-glibc2.31</p><p>- Python version: 3.11.8</p><p>- Numpy version: 1.26.4</p><p>- PyTorch version (GPU?): 2.2.1+cu121 (True)</p><p>- PyTorch XPU available: False</p><p>- PyTorch NPU available: False</p><p>- System RAM: 31.24 GB</p><p>- GPU type: NVIDIA GeForce RTX 3090</p><p>- `Accelerate` default config:</p><p>	- compute_environment: LOCAL_MACHINE</p><p>	- distributed_type: MULTI_GPU</p><p>	- mixed_precision: fp16</p><p>	- use_cpu: False</p><p>	- debug: False</p><p>	- num_processes: 2</p><p>	- machine_rank: 0</p><p>	- num_machines: 1</p><p>	- gpu_ids: 0,1</p><p>	- rdzv_backend: static</p><p>	- same_network: True</p><p>	- main_training_function: main</p><p>	- downcast_bf16: no</p><p>	- tpu_use_cluster: False</p><p>	- tpu_use_sudo: False</p><p>	- tpu_env: []</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Once we have configured <code><b>accelerate</b></code> we can test if we have done it right by running it in a terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate test<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Running:  accelerate-launch ~/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/test_utils/scripts/test_script.py</p><p>stdout: **Initialization**</p><p>stdout: Testing, testing. 1, 2, 3.</p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 0</p><p>stdout: Local process index: 0</p><p>stdout: Device: cuda:0</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 1</p><p>stdout: Local process index: 1</p><p>stdout: Device: cuda:1</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: </p><p>stdout: **Test process execution**</p><p>stdout: </p><p>stdout: **Test split between processes as a list**</p><p>stdout: </p><p>stdout: **Test split between processes as a dict**</p><p>stdout: </p><p>stdout: **Test split between processes as a tensor**</p><p>stdout: </p><p>stdout: **Test random number generator synchronization**</p><p>stdout: All rng are properly synched.</p><p>stdout: </p><p>stdout: **DataLoader integration test**</p><p>stdout: 0 1 tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:1') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:0') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: Non-shuffled dataloader passing.</p><p>stdout: Shuffled dataloader passing.</p><p>stdout: Non-shuffled central dataloader passing.</p><p>stdout: Shuffled central dataloader passing.</p><p>stdout: </p><p>stdout: **Training integration test**</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: FP16 training check.</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: **Breakpoint trigger test**</p><p>Test is a success! You are ready for your distributed training!</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We see that it ends saying <code><b>Test is a success! You are ready for your distributed training!</b></code> so everything is correct.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Training">
								<a class="anchor-link" href="#Training">
									<p style="margin-left: 10px">Training</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Training-optimization">
								<a class="anchor-link" href="#Training-optimization">
									<p style="margin-left: 20px">Training optimization</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Base-code">
								<a class="anchor-link" href="#Base-code">
									<p style="margin-left: 30px">Base code</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We will first make a base training code and then optimize it to see how it is done and how it improves.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">First let's look for a dataset, in my case I will use the dataset <a href="https://huggingface.co/datasets/tweet_eval" target="_blank">tweet_eval</a>, which is a tweet classification dataset, specifically I will download the subset <code><b>emoji</b></code> which classifies tweets with emoticons.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 45000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 50000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetInfo(description='', citation='', homepage='', license='', features={'text': Value(dtype='string', id=None), 'label': ClassLabel(names=['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜'], id=None)}, post_processed=None, supervised_keys=None, task_templates=None, builder_name='parquet', dataset_name='tweet_eval', config_name='emoji', version=0.0.0, splits={'train': SplitInfo(name='train', num_bytes=3808792, num_examples=45000, shard_lengths=None, dataset_name='tweet_eval'), 'test': SplitInfo(name='test', num_bytes=4262151, num_examples=50000, shard_lengths=None, dataset_name='tweet_eval'), 'validation': SplitInfo(name='validation', num_bytes=396704, num_examples=5000, shard_lengths=None, dataset_name='tweet_eval')}, download_checksums={'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/train-00000-of-00001.parquet': {'num_bytes': 2609973, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/test-00000-of-00001.parquet': {'num_bytes': 3047341, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/validation-00000-of-00001.parquet': {'num_bytes': 281994, 'checksum': None}}, download_size=5939308, post_processing_size=None, dataset_size=8467647, size_in_bytes=14406955)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's take a look at the classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜']</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And the number of classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>20</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We see that the dataset has 20 classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's see the maximum sequence of each split</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;train&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;validation&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;test&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_test</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p></p>
<p><span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(142, 139, 167)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">So we define the maximum sequence in general as 130 for tokeniaztion</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We are interested in the tokenized dataset, not the raw sequences, so we create a tokenizer</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We create a tokenization function</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And now we tokenize the dataset</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map:   0%|          | 0/50000 [00:00&lt;?, ? examples/s]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As we see now we have the tokens (<code><b>input_ids</b></code>) and the attention masks (<code><b>attention_mask</b></code>), but let's see what kind of data we have</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(list, list, int)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Tensor, torch.Tensor, torch.Tensor)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We create a dataloader</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We load the model</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's see what the model looks like</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>RobertaForSequenceClassification(</p><p>  (roberta): RobertaModel(</p><p>    (embeddings): RobertaEmbeddings(</p><p>      (word_embeddings): Embedding(50265, 768, padding_idx=1)</p><p>      (position_embeddings): Embedding(514, 768, padding_idx=1)</p><p>      (token_type_embeddings): Embedding(1, 768)</p><p>      (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>      (dropout): Dropout(p=0.1, inplace=False)</p><p>    )</p><p>    (encoder): RobertaEncoder(</p><p>      (layer): ModuleList(</p><p>        (0-11): 12 x RobertaLayer(</p><p>          (attention): RobertaAttention(</p><p>            (self): RobertaSelfAttention(</p><p>              (query): Linear(in_features=768, out_features=768, bias=True)</p><p>              (key): Linear(in_features=768, out_features=768, bias=True)</p><p>              (value): Linear(in_features=768, out_features=768, bias=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>            (output): RobertaSelfOutput(</p><p>              (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>              (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>          )</p><p>          (intermediate): RobertaIntermediate(</p><p>            (dense): Linear(in_features=768, out_features=3072, bias=True)</p><p>            (intermediate_act_fn): GELUActivation()</p><p>          )</p><p>          (output): RobertaOutput(</p><p>            (dense): Linear(in_features=3072, out_features=768, bias=True)</p><p>            (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>            (dropout): Dropout(p=0.1, inplace=False)</p><p>          )</p><p>        )</p><p>      )</p><p>    )</p><p>  )</p><p>  (classifier): RobertaClassificationHead(</p><p>    (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>    (dropout): Dropout(p=0.1, inplace=False)</p><p>    (out_proj): Linear(in_features=768, out_features=2, bias=True)</p><p>  )</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's take a look at its last layer</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=2, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">out_features</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(768, 2)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We have seen that our dataset has 20 classes, but this model is trained for 2 classes, so we have to modify the last layer</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=20, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now it is</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we create a loss function</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">An optimizer</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And finally a metric</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's check that everything is all right with a sample</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span> <span>=</span> <span style="color: #dfd84a;">next</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">iter</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]))</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Size([64, 130]), torch.Size([64, 130]))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we put that sample into the model</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">ouputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">),</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64, 20])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We see that the model outputs 64 batches, which is fine, because we set <code><b>BS = 20</b></code> and each with 20 outputs, which is fine because we changed the model to output 20 values.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We obtain the one with the highest value</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">predictions</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We obtain the loss</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">item</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>2.9990389347076416</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And the accuracy</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])[</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">accuracy</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>0.015625</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We can now create a small training loop</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">epochs</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">epochs</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>&lt;IPython.core.display.HTML object&gt;</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Script-with-the-code-base">
								<a class="anchor-link" href="#Script-with-the-code-base">
									<p style="margin-left: 30px">Script with the code base</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In most of the <code><b>accelerate</b></code> documentation it is explained how to use <code><b>accelerate</b></code> with scripts, so for the moment we will do it like this and at the end we will explain how to do it with a notebook</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">First we are going to create a folder where we are going to save the scripts</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">mkdir</span> <span style="color: #6b97e8;">accelerate_scripts</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we write the base code in a script</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/01_code_base.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And now we run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112                                                               </p><p>CPU times: user 2.12 s, sys: 391 ms, total: 2.51 s</p><p>Wall time: 3min 36s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We can see that on my computer it took about 3.5 minutes.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Code-with-accelerate">
								<a class="anchor-link" href="#Code-with-accelerate">
									<p style="margin-left: 30px">Code with accelerate</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we replace some things</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>First we import <code><b>Accelerator</b></code> and initialize it.</li>
									<li>We no longer do the typical</li>
									<li>Instead, we let <code><b>accelerate</b></code> choose the device by means of</li>
									<li>We pass the relevant elements for training through the <code><b>prepare</b></code> method and no longer do <code><b>model.to(device)</b></code>.</li>
									<li>We no longer send the data and the model to the GPU with <code><b>.to(device)</b></code> since <code><b>accelerate</b></code> has taken care of it with the <code><b>prepare</b></code> method.</li>
									<li>Instead of doing the backpropagation with <code><b>loss.backward()</b></code> we let <code><b>accelerate</b></code> do it with <code><b>loss.backward()</b></code>.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>from accelerate import Accelerator<br>accelerator = Accelerator()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>torch.device("cuda" if torch.cuda.is_available() else "cpu")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>device = accelerator.device<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model, optimizer, dataloader["train"], dataloader["validation"] = preprare(model, optimizer, dataloader["train"], dataloader["validation"])<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerator.backward(loss)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>When calculating the metric in the validation loop, we need to collect the values of all the points, in case we are doing a distributed training.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>predictions = accelerator.gather_for_metrics(predictions)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of training epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of validation epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/02_accelerate_base_code.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">If you notice I have added these two lines <code><b>print(f "End of training epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code> and the line <code><b>print(f "End of validation epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code>, I added them on purpose because they will reveal something very important</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we execute it, to execute the <code><b>accelerate</b></code> scripts it is done with the command <code><b>accelerate launch</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerate launch script.py<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>CPU times: user 1.6 s, sys: 272 ms, total: 1.88 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We see that before it took about 3 and a half minutes and now it takes about 2 and a half minutes. Quite an improvement. Also if we look at the <code><b>print</b></code>s we can see that they have been printed twice.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And how can this be? Because <code><b>accelerate</b></code> has parallelized the training on the two GPUs I have, so it has been much faster.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Also, when I ran the first script, that is, when I did not use <code><b>accelerate</b></code>, the GPU was almost full, while when I ran the second one, that is, the one using <code><b>accelerate</b></code>, the two GPUs were very little used, so we can increase the batch size to try to fill both of them, let's go for it!</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/03_accelerate_base_code_more_bs.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">I have removed the extra prints, because we have already seen that the code is running on both GPUs, and I have increased the batch size from 64 to 128.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.1052                                                               </p><p>Accuracy = 0.1052</p><p>CPU times: user 1.41 s, sys: 180 ms, total: 1.59 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Increasing the batch size has reduced the execution time by a few seconds.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Process-execution">
								<a class="anchor-link" href="#Process-execution">
									<p style="margin-left: 20px">Process execution</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Execution-of-code-in-a-single-process">
								<a class="anchor-link" href="#Execution-of-code-in-a-single-process">
									<p style="margin-left: 30px">Execution of code in a single process</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Before we have seen that the <code><b>print</b></code>s were printed twice, this is because <code><b>accelerate</b></code> creates as many processes as devices where the code is executed, in my case it creates two processes because I have two GPUs.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">However, not all code should be executed in all processes, for example, the <code><b>print</b></code>s slow down the code too much to execute it several times, if checkpoints are saved, they would be saved twice, etc.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In order to execute part of a code in a single process you have to encapsulate it in a function and decorate it with <code><b>accelerator.on_local_main_process</b></code>, for example in the following code you will see that I created the following function</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_main_process<br>def print_something(something):<br>    print(something)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Another option is to put the code inside an <code><b>if accelerator.is_local_main_process</b></code> as in the following code</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>if accelerator.is_local_main_process:<br>    print("Something")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/04_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's run it and see</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2098                                                               </p><p>End of script with 0.2098 accuracy</p><p>CPU times: user 1.38 s, sys: 197 ms, total: 1.58 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now the print has only been printed once</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">However, although you don't see much, progress bars are executed in each process.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">I have not found a way to avoid this with <code><b>fastprogress</b></code> progress bars, but with <code><b>tqdm</b></code> progress bars, so I will replace <code><b>fastprogress</b></code> progress bars with <code><b>tqdm</b></code> progress bars and to make them run in a single process add the argument <code><b>disable=not accelerator.is_local_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/05_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [02:01&lt;00:00,  1.45it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.30it/s]</p><p>Accuracy = 0.2166</p><p>End of script with 0.2166 accuracy</p><p>CPU times: user 1.33 s, sys: 195 ms, total: 1.52 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We have shown an example of how to print in a single process, and this has been a way to execute processes in a single process. But if you just want to print in a single process you can use the <code><b>print</b></code> method of <code><b>accelerate</b></code>. Let's see the same example of before with this method</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/06_accelerate_base_code_print_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15433.52 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 11406.61 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15036.87 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14932.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14956.60 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.33it/s]</p><p>Accuracy = 0.2134</p><p>End of script with 0.2134 accuracy</p><p>CPU times: user 1.4 s, sys: 189 ms, total: 1.59 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Code-execution-in-all-processes">
								<a class="anchor-link" href="#Code-execution-in-all-processes">
									<p style="margin-left: 30px">Code execution in all processes</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">However there is code that must be executed in all processes, for example if we upload the checkpoints to the hub, so here we have two options, encapsulate the code in a function and decorate it with <code><b>accelerator.on_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_main_process<br>def do_my_thing():<br>    "Something done once per server"<br>    do_thing_once()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">or put the code inside an <code><b>if accelerator.is_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>if accelerator.is_main_process:<br>    repo.push_to_hub()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As we are training just to show the <code><b>accelerate</b></code> library and the model we are training is not good, there is no sense now to upload the checkpoints to the hub, so I am going to make an example with <code><b>print</b></code>s</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/06_accelerate_base_code_some_code_in_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it to see</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14518.44 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14368.77 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 16466.33 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14806.14 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14253.33 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14337.07 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.34it/s]</p><p>Accuracy = 0.2092</p><p>End of script with 0.2092 accuracy</p><p>All process: Accuracy = 0.2092</p><p>All process: End of script with 0.2092 accuracy</p><p>CPU times: user 1.42 s, sys: 216 ms, total: 1.64 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Execution-of-code-in-the-process-X">
								<a class="anchor-link" href="#Execution-of-code-in-the-process-X">
									<p style="margin-left: 30px">Execution of code in the process X</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Finally we can specify in which process we want to execute code, for this we must create a function and decorate it with <code><b>@accelerator.on_process(process_index=0)</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_process(process_index=0)<br>def do_my_thing():<br>    "Something done on process index 0"<br>    do_thing_on_index_zero()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">or decorate it with <code><b>@accelerator.on_local_process(local_process_idx=0)</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_process(local_process_index=0)<br>def do_my_thing():<br>    "Something done on process index 0 on each server".<br>    do_thing_on_index_zero_on_each_server()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Here I have put the process 0, but you can put any number</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/07_accelerate_base_code_some_code_in_some_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15735.58 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14906.20 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:02&lt;00:00,  1.44it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.27it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.2128</p><p>End of script with 0.2128 accuracy</p><p>All process: Accuracy = 0.2128</p><p>All process: End of script with 0.2128 accuracy</p><p>Process 0: End of process 0</p><p>CPU times: user 1.42 s, sys: 295 ms, total: 1.71 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Synchronize-processes">
								<a class="anchor-link" href="#Synchronize-processes">
									<p style="margin-left: 30px">Synchronize processes</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">If we have code that must be executed in all processes, it is interesting to wait for it to finish in all processes before doing another task, so for this we use <code><b>accelerator.wait_for_everyone()</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">To see this we are going to put a delay in one of the print functions in a process</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">I've also put a break in the training loop so that he doesn't spend too much time training, which is not what we're interested in right now.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">time</span><span>.</span><span style="color: #6b97e8;">sleep</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #a04cc1;">break</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Printing with delay in process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of script&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/08_accelerate_base_code_sync_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14218.23 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14666.25 examples/s]</p><p>  0%|                                                   | 0/176 [00:00&lt;?, ?it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.58it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.212</p><p>End of script with 0.212 accuracy</p><p>All process: Accuracy = 0.212</p><p>All process: End of script with 0.212 accuracy</p><p>Printing with delay in process 0</p><p>Process 0: End of process 0</p><p>End of script</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see first we have printed <code><b>Process 1: End of process 1</b></code> and then the rest, this is because the rest of the prints are made either in process 0 or in all processes, so until the 2 seconds delay we have set is not finished the rest of the code is not executed.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Save-and-load-the-state-dict">
								<a class="anchor-link" href="#Save-and-load-the-state-dict">
									<p style="margin-left: 20px">Save and load the state dict</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">When we train, we sometimes save the state so that we can continue at a later time.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">To save the state we will have to use the <code><b>save_state()</b></code> and <code><b>load_state()</b></code> methods.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos los pesos</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Cargamos los pesos</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">load_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_accelerate_save_and_load_checkpoints.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.40it/s]</p><p>Accuracy = 0.2142</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Save-the-model">
								<a class="anchor-link" href="#Save-the-model">
									<p style="margin-left: 20px">Save the model</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">When the <code><b>prepare</b></code> method was used, the model was wrapped in order to save it to the necessary devices. So when saving it we have to use the <code><b>save_model</b></code> method which first unwraps it and then saves it. Also if we use the <code><b>safe_serialization=True</b></code> parameter the model will be saved as a <code><b>safe tensor</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">safe_serialization</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_model.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.35it/s]</p><p>Accuracy = 0.214</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Save-the-`pretrained`-model">
								<a class="anchor-link" href="#Save-the-`pretrained`-model">
									<p style="margin-left: 20px">Save the <code><b>pretrained</b></code> model</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In models that use the <code><b>transformers</b></code> library we must save the model with the <code><b>save_pretrained</b></code> method to be able to load it with the <code><b>from_pretrained</b></code> method. Before saving it we must unwrap it with the <code><b>unwrap_model</b></code> method.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo pretrained</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">unwrap_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span><span>.</span><span style="color: #6b97e8;">save_pretrained</span><span style="color: #e3e11d;">(</span></p>
<p>        <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">is_main_process</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">save_function</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_pretrained.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15152.47 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15119.13 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12724.70 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12397.49 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15247.21 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15138.03 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:59&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.37it/s]</p><p>Accuracy = 0.21</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we could load it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModel</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoModel</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of RobertaModel were not initialized from the model checkpoint at accelerate_scripts/model_pretrained and are newly initialized: ['roberta.pooler.dense.bias', 'roberta.pooler.dense.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Training-on-notebooks">
								<a class="anchor-link" href="#Training-on-notebooks">
									<p style="margin-left: 20px">Training on notebooks</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">So far we have seen how to run scripts, but if you want to run the code on a notebook, we can write the same code as before, but encapsulated in a function</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">First we import the libraries</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p><span style="color: #7f6e38;"># from accelerate import Accelerator</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we create the function</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">train_code</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">batch_size</span><span style="color: #e3e11d;">:</span> <span style="color: #dfd84a;">int</span> <span>=</span> <span style="color: #7e7a38;">64</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #6b97e8;">batch_size</span></p>
<p>    <span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p>    <span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p>    <span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># model.to(device)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>            <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>                <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>        </p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In order to run the training on the notebook we use the <code><b>notebook_launcher</b></code> function, to which we pass the function we want to run, the arguments of that function and the number of GPUs on which we are going to train with the variable <code><b>num_processes</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_launcher</span></p>
<p></p>
<p><span style="color: #6b97e8;">args</span> <span>=</span> <span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">128</span><span style="color: #e3e11d;">,)</span></p>
<p><span style="color: #6b97e8;">notebook_launcher</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">train_code</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">args</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_processes</span><span>=</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Training-in-FP16">
								<a class="anchor-link" href="#Training-in-FP16">
									<p style="margin-left: 20px">Training in FP16</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">When we first set up <code><b>accelerate</b></code> it asked us <code><b>Do you wish to use FP16 or BF16 (mixed precision)?</b></code> and we said no, so now we are going to say yes, we want to use FP16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">So far we have trained in FP32, which means that each weight of the model is a 32-bit floating point number, and now we are going to use a 16-bit floating point number, that is, the model will occupy less space. So two things will happen, we will be able to use a larger batch size and it will also be faster.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">First we re-launch <code><b>accelerate config</b></code> and we will tell it that we want FP16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we create a script to train, with the same batch size as before, to see if it takes less time to train</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/12_accelerate_base_code_fp16_bs128.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it and see how long it takes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14983.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14315.47 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:01&lt;00:00,  2.88it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:02&lt;00:00,  6.84it/s]</p><p>Accuracy = 0.2094</p><p>CPU times: user 812 ms, sys: 163 ms, total: 976 ms</p><p>Wall time: 1min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">When we ran this training in FP32 it took about 2 minutes and a half, and now it takes about 1 minute and a half. Let's see if now instead of training with a batch size of 128, we do it with a batch size of 256.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">256</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/13_accelerate_base_code_fp16_bs256.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15390.30 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14990.92 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:54&lt;00:00,  1.62it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:02&lt;00:00,  3.45it/s]</p><p>Accuracy = 0.2236</p><p>CPU times: user 670 ms, sys: 91.6 ms, total: 761 ms</p><p>Wall time: 1min 12s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">It has dropped only about 15 seconds</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="BF16-Training">
								<a class="anchor-link" href="#BF16-Training">
									<p style="margin-left: 20px">BF16 Training</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Before we have trained in FP16 and now we are going to train in BF16, what is the difference?</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/05/FP32_FP16_BF16.webp" alt="FP32_FP16_BF16"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As we can see in the picture, while FP16 compared to FP32 has fewer bits in the mantissa and exponent, which makes its range much smaller, BF16 compared to FP32 has the same number of bits in the exponent but fewer in the mantissa, which makes BF16 have the same range of numbers as FP32, but it is less accurate.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">This is beneficial because in FP16 some calculations could give very high numbers, which in FP16 format could not be represented. In addition there are certain HW devices that are optimized for this format.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As before, we execute <code><b>accelerate config</b></code> and indicate that we want BF16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>bf16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we run the last script we created, i.e. with a batch size of 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14814.95 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14506.83 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:51&lt;00:00,  1.70it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:03&lt;00:00,  3.21it/s]</p><p>Accuracy = 0.2112</p><p>CPU times: user 688 ms, sys: 144 ms, total: 832 ms</p><p>Wall time: 1min 17s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">It took a similar time to what it took before, which is normal, since we have trained a model with 16-bit weights, just like before.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Training-in-FP8">
								<a class="anchor-link" href="#Training-in-FP8">
									<p style="margin-left: 20px">Training in FP8</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we are going to train in FP8 format, which as its name suggests, is a floating point format, where each weight has 8 bits, so we run <code><b>accelerate config</b></code> to tell it that we want FP8</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp8</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we execute the last script, the batch size of 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>[2024-05-13 21:40:56,455] torch.distributed.elastic.multiprocessing.api: [ERROR] failed (exitcode: 1) local_rank: 0 (pid: 501480) of binary: /home/wallabot/miniconda3/envs/nlp/bin/python</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/miniconda3/envs/nlp/bin/accelerate", line 8, in &lt;module&gt;</p><p>    sys.exit(main())</p><p>             ^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/accelerate_cli.py", line 46, in main</p><p>    args.func(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 1048, in launch_command</p><p>    multi_gpu_launcher(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 702, in multi_gpu_launcher</p><p>    distrib_run.run(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/run.py", line 803, in run</p><p>    elastic_launch(</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 135, in __call__</p><p>    return launch_agent(self._config, self._entrypoint, list(args))</p><p>           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 268, in launch_agent</p><p>    raise ChildFailedError(</p><p>torch.distributed.elastic.multiprocessing.errors.ChildFailedError: </p><p>============================================================</p><p>accelerate_scripts/13_accelerate_base_code_fp16_bs256.py FAILED</p><p>------------------------------------------------------------</p><p>Failures:</p><p>[1]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 1 (local_rank: 1)</p><p>  exitcode  : 1 (pid: 501481)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>------------------------------------------------------------</p><p>Root Cause (first observed failure):</p><p>[0]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 0 (local_rank: 0)</p><p>  exitcode  : 1 (pid: 501480)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>============================================================</p><p>CPU times: user 65.1 ms, sys: 14.5 ms, total: 79.6 ms</p><p>Wall time: 7.24 s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As the weights are now 8 bits and occupy half of the memory, we will increase the batch size to 512.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">512</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/15_accelerate_base_code_fp8_bs512.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We run it</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Model-inference">
								<a class="anchor-link" href="#Model-inference">
									<p style="margin-left: 10px">Model inference</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Using-the-Hugging-Face-Ecosystem">
								<a class="anchor-link" href="#Using-the-Hugging-Face-Ecosystem">
									<p style="margin-left: 20px">Using the Hugging Face Ecosystem</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's see how to do large model inference with the <code><b>transformers</b></code> library of hugging face.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inference-with-`pipeline`.">
								<a class="anchor-link" href="#Inference-with-`pipeline`.">
									<p style="margin-left: 30px">Inference with <code><b>pipeline</b></code>.</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">If we use the Hugging Face ecosystem it is very simple, since everything is produced underneath without us having to do much. In the case of using <code><b>pipeline</b></code>, which is the easiest way to do inference with the <code><b>transformers</b></code> library, we simply have to tell it the model we want to use and very important, pass <code><b>device_map="auto"</b></code>. This will cause <code><b>accelerate</b></code> to distribute the model among the different GPUs, CPU RAM or hard disk if necessary.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">There are more possible values for <code><b>device_map</b></code>, which we will see later, but for now stay with <code><b>"auto"</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We are going to use the <code><b>Llama3 8B</b></code> model, which as its name indicates is a model of about 8 billion parameters, as each parameter by default is in FP32 format, which corresponds to 4 bytes (32 bits), that means that if we multiply 8 billion parameters by 4 bytes, we would need a GPU with about 32 GB of VRAM.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In my case I have 2 GPUs with 24 GB of VRAM, so it would not fit on a single GPU. But thanks to put <code><b>device_map="auto"</b></code>, accelerate will distribute the model between the two GPUs and I will be able to make the inference.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_inference_with_pipeline.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now we run it, but since pipeline uses accelerate below, we don't need to run it with <code><b>accelerate launch script.py</b></code> but with <code><b>python script.py</b></code> will do.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.27s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>[{'generated_text': 'Conoces accelerate de hugging face? ¿Qué es el modelo de lenguaje de transformers y cómo se utiliza en el marco de hugging face? ¿Cómo puedo utilizar modelos de lenguaje de transformers en mi aplicación? ¿Qué son los tokenizers y cómo se utilizan en el marco de hugging face? ¿Cómo puedo crear un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los datasets y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar datasets para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning'}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, it did not answer, but kept asking questions. This is because Llama3 is a language model that predicts the next token, so with the prompt that I have passed it, it has considered that the next best tokens are those that correspond to more questions. Which makes sense, because there are times when people have doubts about a topic and generates many questions, so to answer the question we have to condition it a little bit</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">messages</span> <span>=</span> <span style="color: #e3e11d;">[</span></p>
<p>    <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;system&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;Eres un chatbot amigable que siempre intenta solucionar las dudas&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">},</span></p>
<p>    <span style="color: #e3e11d;">{</span><span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;user&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">},</span></p>
<p><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">messages</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #8d783e;">&#39;generated_text&#39;</span><span style="color: #e3e11d;">][</span><span>-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/10_inference_with_pipeline_condition.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, a message has been generated with roles, conditioning the model and with the following prompt</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.41s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>{'role': 'assistant', 'content': '¡Hola!\n\nSí, conozco Accelerate de Hugging Face. Accelerate es una biblioteca de Python desarrollada por Hugging Face que se enfoca en simplificar y acelerar el entrenamiento y la evaluación de modelos de lenguaje en diferentes dispositivos y entornos.\n\nCon Accelerate, puedes entrenar modelos de lenguaje en diferentes plataformas y dispositivos, como GPUs, TPUs, CPUs y servidores, sin necesidad de cambiar el código de tu modelo. Esto te permite aprovechar al máximo la potencia de cálculo de tus dispositivos y reducir el tiempo de entrenamiento.\n\nAccelerate también ofrece varias características adicionales, como:\n\n* Soporte para diferentes frameworks de machine learning, como TensorFlow, PyTorch y JAX.\n* Integración con diferentes sistemas de almacenamiento y procesamiento de datos, como Amazon S3 y Google Cloud Storage.\n* Soporte para diferentes protocolos de comunicación, como HTTP y gRPC.\n* Herramientas para monitorear y depurar tus modelos en tiempo real.\n\nEn resumen, Accelerate es una herramienta muy útil para desarrolladores de modelos de lenguaje que buscan simplificar y acelerar el proceso de entrenamiento y evaluación de sus modelos.\n\n¿Tienes alguna pregunta específica sobre Accelerate o necesitas ayuda para implementarlo en tu proyecto?'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now the answer if it responds to our prompt</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inference-with-`AutoClass`">
								<a class="anchor-link" href="#Inference-with-`AutoClass`">
									<p style="margin-left: 30px">Inference with <code><b>AutoClass</b></code></p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Finally we will see how to do the inference only with <code><b>AutoClass</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TextStreamer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">streamer</span> <span>=</span> <span style="color: #6b97e8;">TextStreamer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">tokens_input</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">([</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">_</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">generate</span><span style="color: #e3e11d;">(</span><span>**</span><span style="color: #6b97e8;">tokens_input</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">streamer</span><span>=</span><span style="color: #6b97e8;">streamer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #7e7a38;">500</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">do_sample</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">50</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #a09e19;">0.95</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #a09e19;">0.7</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/11_inference_with_autoclass.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As you can see, the <code><b>streamer</b></code> object has been created and then passed to the <code><b>generate</b></code> method of the model. This is useful so that each word is printed as it is generated and you don't have to wait for all the output to be generated before printing it.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.28s/it]</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>&lt;|begin_of_text|&gt;Conoces accelerate de hugging face? Si es así, puedes utilizar la biblioteca `transformers` de Hugging Face para crear un modelo de lenguaje que pueda predecir la siguiente palabra en una secuencia de texto.</p><p>Aquí te muestro un ejemplo de cómo hacerlo:</p><p>```</p><p>import pandas as pd</p><p>import torch</p><p>from transformers import AutoModelForSequenceClassification, AutoTokenizer</p><p># Cargar el modelo y el tokenizador</p><p>model_name = "bert-base-uncased"</p><p>model = AutoModelForSequenceClassification.from_pretrained(model_name)</p><p>tokenizer = AutoTokenizer.from_pretrained(model_name)</p><p># Cargar el conjunto de datos</p><p>train_df = pd.read_csv("train.csv")</p><p>test_df = pd.read_csv("test.csv")</p><p># Preprocesar los datos</p><p>train_texts = train_df["text"]</p><p>train_labels = train_df["label"]</p><p>test_texts = test_df["text"]</p><p># Convertir los textos en entradas para el modelo</p><p>train_encodings = tokenizer.batch_encode_plus(train_texts, </p><p>                                              add_special_tokens=True, </p><p>                                              max_length=512, </p><p>                                              return_attention_mask=True, </p><p>                                              return_tensors='pt')</p><p>test_encodings = tokenizer.batch_encode_plus(test_texts, </p><p>                                             add_special_tokens=True, </p><p>                                             max_length=512, </p><p>                                             return_attention_mask=True, </p><p>                                             return_tensors='pt')</p><p># Crear un dataloader para entrenar el modelo</p><p>train_dataset = torch.utils.data.TensorDataset(train_encodings["input_ids"], </p><p>                                               train_encodings["attention_mask"], </p><p>                                               torch.tensor(train_labels))</p><p>train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=32, shuffle=True)</p><p># Entrenar el modelo</p><p>device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</p><p>model.to(device)</p><p>criterion = torch.nn.CrossEntropyLoss()</p><p>optimizer = torch.optim.Adam(model.parameters(), lr=1e-5)</p><p>for epoch in range(5):</p><p>    model.train()</p><p>    total_loss = 0</p><p>    for batch in train_loader:</p><p>        input_ids = batch[0].to(device)</p><p>        attention_mask = batch[1].to(device)</p><p>        labels = batch[2].to(device)</p><p>        optimizer.zero_grad()</p><p>        outputs = model(input_ids, attention_mask=attention_mask, labels=labels)</p><p>        loss = criterion(outputs, labels)</p><p>        loss.backward()</p><p>        optimizer.step()</p><p>        total_loss += loss.item()</p><p>    print(f"Epoch {epoch+1}, Loss: {total</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Use-pytorch">
								<a class="anchor-link" href="#Use-pytorch">
									<p style="margin-left: 20px">Use pytorch</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Normally the way to make inferences with pytorch is to create a model with the weights initialized randomly and then load a <code><b>state dict</b></code> with the weights of the pre-trained model, so to get that <code><b>state dict</b></code> we are going to make a little trick first and download them</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">weights</span><span>=</span><span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">ResNet152_Weights</span><span>.</span><span style="color: #6b97e8;">IMAGENET1K_V1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">(),</span> <span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Downloading: "https://download.pytorch.org/models/resnet152-394f9c45.pth" to /home/maximo.fernandez/.cache/torch/hub/checkpoints/resnet152-394f9c45.pth</p><p>100%|██████████| 230M/230M [02:48&lt;00:00, 1.43MB/s] </p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now that we have the <code><b>state dict</b></code> let's do inference as it is normally done in pytorch</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span>     <span style="color: #7f6e38;"># Set device</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Create model with random weights and move to device</span></p>
<p><span style="color: #6b97e8;">state_dict</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">map_location</span><span>=</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load pretrained weights into device memory</span></p>
<p><span style="color: #6b97e8;">resnet152</span><span>.</span><span style="color: #6b97e8;">load_state_dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load this weights into the model</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let us explain what happened</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>When we did <code><b>resnet152 = models.resnet152().to(device)</b></code> a resnet152 with random weights was loaded into GPU memory.</li>
									<li>When we did <code><b>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)</b></code> a dictionary with the trained weights was loaded into GPU memory.</li>
									<li>When we have done <code><b>resnet152.load_state_dict(state_dict)</b></code> these pre-trained weights have been assigned to the model.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In other words, the model has been loaded twice in the GPU memory.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">You may be wondering why we have done this first.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br>torch.save(model.state_dict(), 'accelerate_scripts/resnet152_pretrained.pth')<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">To then make</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>resnet152 = models.resnet152().to(device)<br>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)<br>resnet152.load_state_dict(state_dict)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And why don't we use directly</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">And we stop saving the <code><b>state dict</b></code> to load it later. Well, because Pytorch, by edbajo does the same thing that we have done. So to be able to see the whole process we have done in several lines what Pytorch does in one line</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">This way of working has worked well until now, as long as the models had a manageable size for user GPUs. But since the advent of LLMs this approach does not make sense.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">For example, a 6B model of parameters would occupy 24 GB of memory, and since it is loaded twice with this way of working, a 48 GB GPU would be required.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">So to fix this, the way to load a pre-trained Pytorch model is:</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Create an empty model with <code><b>init_empty_weights</b></code> that will not occupy RAM.</li>
									<li>Then load the weights with <code><b>load_checkpoint_and_dispatch</b></code> which will load a checkpoint inside the empty model and distribute the weights for each layer on all available devices (GPU, CPU RAM and hard disk), thanks to setting <code><b>device_map="auto"</b></code>.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">checkpoint</span><span>=</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="How-accelerate-works-below">
								<a class="anchor-link" href="#How-accelerate-works-below">
									<p style="margin-left: 20px">How accelerate works below</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">In this video you can see graphically how accelerate works below</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><iframe width="1280" height="720" src="https://www.youtube.com/embed/MWCSGj9jEAo" title="Accelerate Big Model Inference: How Does it Work?" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Initialization-of-an-empty-model">
								<a class="anchor-link" href="#Initialization-of-an-empty-model">
									<p style="margin-left: 30px">Initialization of an empty model</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Accelerate creates the skeleton of an empty model using <code><b>init_empty_weights</b></code> to occupy as little memory as possible.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">For example, let's see how much RAM I now have available on my computer</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">psutil</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">get_ram_info</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">ram</span> <span>=</span> <span style="color: #dfd84a;">dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">psutil</span><span>.</span><span style="color: #6b97e8;">virtual_memory</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">_asdict</span><span style="color: #e3e11d;">())</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;total&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Available RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;available&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Used RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;used&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.62 GB, Used RAM: 7.82 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">I have about 22 GB of RAM available</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now let's try to create a model 5000x1000x1000 parameters, i.e. 5B parameters, if each parameter is in FP32, it means 20 GB of RAM.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">nn</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">If we look at RAM again</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 3.77 GB, Used RAM: 26.70 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As we can see now we only have 3 GB of RAM available.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Now let's delete the model to free RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">del</span> <span style="color: #6b97e8;">model</span></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.44 GB, Used RAM: 8.03 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">We again have about 22 GB of RAM available.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Let's now use <code><b>init_empty_weights</b></code> from <code><b>accelerate</b></code> and then we see the RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.32 GB, Used RAM: 8.16 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Before we had exactly 22.44 GB free and after creating the model with <code><b>init_empty_weights</b></code> we have 22.32 GB. The saving in RAM is enormous! Almost no RAM has been used to create the model.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">This is based on the metadevice introduced in PyTorch 1.9, so it is important that to use <code><b>accelerate</b></code> we have a later version of Pytorch.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Loading-weights">
								<a class="anchor-link" href="#Loading-weights">
									<p style="margin-left: 30px">Loading weights</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Once we have initialized the model we have to load the weights using <code><b>load_checkpoint_and_dispatch</b></code> which, as its name indicates, loads the weights and sends them to the device or devices required.</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>

