<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Configuração-index">
									<a class="anchor-link" href="#Configuração">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Configuração</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Treinamento-index">
									<a class="anchor-link" href="#Treinamento">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Treinamento</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Otimização-do-treinamento-index">
									<a class="anchor-link" href="#Otimização-do-treinamento">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Otimização do treinamento</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Código-base-index">
									<a class="anchor-link" href="#Código-base">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Código base</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Script-com-a-base-de-código-index">
									<a class="anchor-link" href="#Script-com-a-base-de-código">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Script com a base de código</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Código-com-aceleração-index">
									<a class="anchor-link" href="#Código-com-aceleração">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Código com aceleração</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Execução-do-processo-index">
									<a class="anchor-link" href="#Execução-do-processo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Execução do processo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Execução-de-código-em-um-único-processo-index">
									<a class="anchor-link" href="#Execução-de-código-em-um-único-processo">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Execução de código em um único processo</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Execução-de-código-em-todos-os-processos-index">
									<a class="anchor-link" href="#Execução-de-código-em-todos-os-processos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Execução de código em todos os processos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Execução-de-código-no-processo-X-index">
									<a class="anchor-link" href="#Execução-de-código-no-processo-X">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Execução de código no processo X</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Sincronizar-processos-index">
									<a class="anchor-link" href="#Sincronizar-processos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Sincronizar processos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Salvar-e-carregar-o-ditado-de-estado-index">
									<a class="anchor-link" href="#Salvar-e-carregar-o-ditado-de-estado">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Salvar e carregar o ditado de estado</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Salvar-o-modelo-index">
									<a class="anchor-link" href="#Salvar-o-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Salvar o modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Salvar-o-modelo-"pré-treinado-index">
									<a class="anchor-link" href="#Salvar-o-modelo-"pré-treinado">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Salvar o modelo "pré-treinado</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-em-notebooks-index">
									<a class="anchor-link" href="#Treinamento-em-notebooks">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento em notebooks</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-em-FP16-index">
									<a class="anchor-link" href="#Treinamento-em-FP16">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento em FP16</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-em-BF16-index">
									<a class="anchor-link" href="#Treinamento-em-BF16">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento em BF16</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-em-FP8-index">
									<a class="anchor-link" href="#Treinamento-em-FP8">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento em FP8</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Inferência-de-modelo-index">
									<a class="anchor-link" href="#Inferência-de-modelo">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Inferência de modelo</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Uso-do-ecossistema-de-rosto-abraçado-index">
									<a class="anchor-link" href="#Uso-do-ecossistema-de-rosto-abraçado">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Uso do ecossistema de rosto abraçado</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inferência-com-`pipeline`.-index">
									<a class="anchor-link" href="#Inferência-com-`pipeline`.">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inferência com <code><b>pipeline</b></code>.</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inferência-com-`AutoClass`.-index">
									<a class="anchor-link" href="#Inferência-com-`AutoClass`.">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inferência com <code><b>AutoClass</b></code>.</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Use-pytorch-index">
									<a class="anchor-link" href="#Use-pytorch">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Use pytorch</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Como-a-aceleração-funciona-abaixo-index">
									<a class="anchor-link" href="#Como-a-aceleração-funciona-abaixo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Como a aceleração funciona abaixo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Inicialização-de-um-modelo-vazio-index">
									<a class="anchor-link" href="#Inicialização-de-um-modelo-vazio">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Inicialização de um modelo vazio</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Carregamento-de-pesos-index">
									<a class="anchor-link" href="#Carregamento-de-pesos">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Carregamento de pesos</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/notebooks_translated/2024-05-16-Hugging-Face-accelerate_PT.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="Aceleração-do-rosto-do-abraço">
								<a class="anchor-link" href="#Aceleração-do-rosto-do-abraço">
									<p style="margin-left: 0px">Aceleração do rosto do abraço</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O Accelerate é uma biblioteca Hugging Face que permite executar o mesmo código PyTorch em qualquer configuração distribuída, adicionando apenas quatro linhas de código.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Este caderno foi traduzido automaticamente para torná-lo acessível a mais pessoas, por favor me avise se você vir algum erro de digitação..</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">## Instalação</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para instalar o <code><b>accelerate</b></code> com o <code><b>pip</b></code>, basta executar:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>pip install accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E com <code><b>conda</b></code>:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>conda install -c conda-forge accelerate<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Configuração">
								<a class="anchor-link" href="#Configuração">
									<p style="margin-left: 10px">Configuração</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Em todos os ambientes em que o <code><b>accelerate</b></code> está instalado, a primeira coisa a fazer é configurá-lo. Para isso, executamos em um terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>acelerar a configuração<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>no</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No meu caso, as respostas foram</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Em qual ambiente de computação você está executando?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [x] "Esta máquina"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] "AWS (Amazon SageMaker)" [_] "AWS (Amazon SageMaker)" [_] "AWS (Amazon SageMaker)"</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Quero configurá-lo em meu computador</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Que tipo de máquina você está usando?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-CPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-XPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - x] multi-GPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] multi-NPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] TPU</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Como tenho 2 GPUs e quero executar código distribuído nelas, escolhi <code><b>multi-GPU</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Quantas máquinas diferentes você usará (use mais de uma para treinamento com vários nós)? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Escolhi <code><b>1</b></code> porque só vou executar em meu computador.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>As operações distribuídas devem ser verificadas durante a execução em busca de erros? Isso pode evitar problemas de tempo limite, mas será mais lento. [yes/NO]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - não</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Com essa opção, você pode optar por fazer com que o <code><b>accelerate</b></code> verifique se há erros na execução, mas isso tornaria a execução mais lenta, então eu escolho <code><b>no</b></code> e, caso haja erros, altero para <code><b>yes</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Deseja otimizar seu script com o torch dynamo? [yes/NO]:</li>
									<li>Você deseja usar o FullyShardedDataParallel? [yes/NO]:</li>
									<li>Você quer usar o Megatron-LM? [sim/não]:</li>
									<li>Quantas GPUs devem ser usadas para treinamento distribuído? [1]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - não</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - não</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - não</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Escolhi <code><b>2</b></code> porque tenho 2 GPUs</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Quais GPUs (por id) devem ser usadas para treinamento nesta máquina como uma lista separada por vírgulas? [all]:</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - 0,1</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > Escolhi <code><b>0,1</b></code> porque quero usar as duas GPUs.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Você deseja usar FP16 ou BF16 (precisão mista)?</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - x] não</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] bf16</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">    - [_] fp8</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> > No momento, escolhi <code><b>no</b></code>, pois, para simplificar o código, quando não estivermos usando o <code><b>accelerate</b></code>, treinaremos em fp32, mas o ideal seria usar fp16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A configuração será armazenada em <code><b>~/.cache/huggingface/accelerate/default_config.yaml</b></code> e poderá ser modificada a qualquer momento. Vamos ver o que há dentro dele</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">cat</span> <span>~/.</span><span style="color: #6b97e8;">cache</span><span>/</span><span style="color: #6b97e8;">huggingface</span><span>/</span><span style="color: #6b97e8;">accelerate</span><span>/</span><span style="color: #6b97e8;">default_config</span><span>.</span><span style="color: #6b97e8;">yaml</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>compute_environment: LOCAL_MACHINE</p><p>debug: false</p><p>distributed_type: MULTI_GPU</p><p>downcast_bf16: 'no'</p><p>gpu_ids: 0,1</p><p>machine_rank: 0</p><p>main_training_function: main</p><p>mixed_precision: fp16</p><p>num_machines: 1</p><p>num_processes: 2</p><p>rdzv_backend: static</p><p>same_network: true</p><p>tpu_env: []</p><p>tpu_use_cluster: false</p><p>tpu_use_sudo: false</p><p>use_cpu: false</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Outra maneira de ver a configuração que temos é executá-la em um terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>acelerar o ambiente<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">env</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Copy-and-paste the text below in your GitHub issue</p><p>- `Accelerate` version: 0.28.0</p><p>- Platform: Linux-5.15.0-105-generic-x86_64-with-glibc2.31</p><p>- Python version: 3.11.8</p><p>- Numpy version: 1.26.4</p><p>- PyTorch version (GPU?): 2.2.1+cu121 (True)</p><p>- PyTorch XPU available: False</p><p>- PyTorch NPU available: False</p><p>- System RAM: 31.24 GB</p><p>- GPU type: NVIDIA GeForce RTX 3090</p><p>- `Accelerate` default config:</p><p>	- compute_environment: LOCAL_MACHINE</p><p>	- distributed_type: MULTI_GPU</p><p>	- mixed_precision: fp16</p><p>	- use_cpu: False</p><p>	- debug: False</p><p>	- num_processes: 2</p><p>	- machine_rank: 0</p><p>	- num_machines: 1</p><p>	- gpu_ids: 0,1</p><p>	- rdzv_backend: static</p><p>	- same_network: True</p><p>	- main_training_function: main</p><p>	- downcast_bf16: no</p><p>	- tpu_use_cluster: False</p><p>	- tpu_use_sudo: False</p><p>	- tpu_env: []</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de configurar o <code><b>accelerate</b></code>, podemos testar se fizemos tudo certo executando-o em um terminal:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>teste de aceleração<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Running:  accelerate-launch ~/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/test_utils/scripts/test_script.py</p><p>stdout: **Initialization**</p><p>stdout: Testing, testing. 1, 2, 3.</p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 0</p><p>stdout: Local process index: 0</p><p>stdout: Device: cuda:0</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: Distributed environment: DistributedType.MULTI_GPU  Backend: nccl</p><p>stdout: Num processes: 2</p><p>stdout: Process index: 1</p><p>stdout: Local process index: 1</p><p>stdout: Device: cuda:1</p><p>stdout: </p><p>stdout: Mixed precision type: fp16</p><p>stdout: </p><p>stdout: </p><p>stdout: **Test process execution**</p><p>stdout: </p><p>stdout: **Test split between processes as a list**</p><p>stdout: </p><p>stdout: **Test split between processes as a dict**</p><p>stdout: </p><p>stdout: **Test split between processes as a tensor**</p><p>stdout: </p><p>stdout: **Test random number generator synchronization**</p><p>stdout: All rng are properly synched.</p><p>stdout: </p><p>stdout: **DataLoader integration test**</p><p>stdout: 0 1 tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:1') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: tensor([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16, 17,</p><p>stdout:         18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,</p><p>stdout:         36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53,</p><p>stdout:         54, 55, 56, 57, 58, 59, 60, 61, 62, 63], device='cuda:0') &lt;class 'accelerate.data_loader.DataLoaderShard'&gt;</p><p>stdout: Non-shuffled dataloader passing.</p><p>stdout: Shuffled dataloader passing.</p><p>stdout: Non-shuffled central dataloader passing.</p><p>stdout: Shuffled central dataloader passing.</p><p>stdout: </p><p>stdout: **Training integration test**</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: Training yielded the same results on one CPU or distributed setup with no batch split.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: FP16 training check.</p><p>stdout: Training yielded the same results on one CPU or distributes setup with batch split.</p><p>stdout: FP16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: Keep fp32 wrapper check.</p><p>stdout: BF16 training check.</p><p>stdout: BF16 training check.</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: Model dtype: torch.float32, torch.float32. Input dtype: torch.float32</p><p>stdout: </p><p>stdout: **Breakpoint trigger test**</p><p>Test is a success! You are ready for your distributed training!</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que ele termina dizendo `O teste foi um sucesso! Você está pronto para seu treinamento distribuído, portanto, tudo está correto.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Treinamento">
								<a class="anchor-link" href="#Treinamento">
									<p style="margin-left: 10px">Treinamento</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Otimização-do-treinamento">
								<a class="anchor-link" href="#Otimização-do-treinamento">
									<p style="margin-left: 20px">Otimização do treinamento</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Código-base">
								<a class="anchor-link" href="#Código-base">
									<p style="margin-left: 30px">Código base</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, criaremos um código de treinamento básico e, em seguida, o otimizaremos para ver como ele é feito e como melhora.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, vamos procurar um conjunto de dados; no meu caso, usarei o conjunto de dados <a href="https://huggingface.co/datasets/tweet_eval" target="_blank">tweet_eval</a>, que é um conjunto de dados de classificação de tweets; em particular, farei o download do subconjunto <code><b>emoji</b></code>, que classifica tweets com emoticons.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 45000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 50000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['text', 'label'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetInfo(description='', citation='', homepage='', license='', features={'text': Value(dtype='string', id=None), 'label': ClassLabel(names=['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜'], id=None)}, post_processed=None, supervised_keys=None, task_templates=None, builder_name='parquet', dataset_name='tweet_eval', config_name='emoji', version=0.0.0, splits={'train': SplitInfo(name='train', num_bytes=3808792, num_examples=45000, shard_lengths=None, dataset_name='tweet_eval'), 'test': SplitInfo(name='test', num_bytes=4262151, num_examples=50000, shard_lengths=None, dataset_name='tweet_eval'), 'validation': SplitInfo(name='validation', num_bytes=396704, num_examples=5000, shard_lengths=None, dataset_name='tweet_eval')}, download_checksums={'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/train-00000-of-00001.parquet': {'num_bytes': 2609973, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/test-00000-of-00001.parquet': {'num_bytes': 3047341, 'checksum': None}, 'hf://datasets/tweet_eval@b3a375baf0f409c77e6bc7aa35102b7b3534f8be/emoji/validation-00000-of-00001.parquet': {'num_bytes': 281994, 'checksum': None}}, download_size=5939308, post_processing_size=None, dataset_size=8467647, size_in_bytes=14406955)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos dar uma olhada nas classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>['❤', '😍', '😂', '💕', '🔥', '😊', '😎', '✨', '💙', '😘', '📷', '🇺🇸', '☀', '💜', '😉', '💯', '😁', '🎄', '📸', '😜']</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E o número de classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>20</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que o conjunto de dados tem 20 classes</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos dar uma olhada na sequência máxima de cada divisão</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p><span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #7e7a38;">0</span></p>
<p></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;train&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_train</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;validation&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_val</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p><span style="color: #6b97e8;">split</span> <span>=</span> <span style="color: #7e7a34;">&quot;test&quot;</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">])):</span></p>
<p>    <span style="color: #6b97e8;">len_i</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">split</span><span style="color: #e3e11d;">][</span><span style="color: #6b97e8;">i</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">len_i</span> <span>&gt;</span> <span style="color: #6b97e8;">max_len_test</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">max_len_test</span> <span>=</span> <span style="color: #6b97e8;">len_i</span></p>
<p></p>
<p><span style="color: #6b97e8;">max_len_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_val</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_len_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(142, 139, 167)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Portanto, definimos a sequência máxima em geral como 130 para a tokenização.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Estamos interessados no conjunto de dados tokenizado, não nas sequências brutas, portanto, criamos um tokenizador</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função de tokenização</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E agora vamos tokenizar o conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map:   0%|          | 0/50000 [00:00&lt;?, ? examples/s]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como podemos ver agora, temos os tokens (<code><b>input_ids</b></code>) e as máscaras de atenção (<code><b>attention_mask</b></code>), mas vamos ver que tipo de dados temos.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(list, list, int)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]),</span> <span style="color: #dfd84a;">type</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Tensor, torch.Tensor, torch.Tensor)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um carregador de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Carregamos o modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ver como é o modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>RobertaForSequenceClassification(</p><p>  (roberta): RobertaModel(</p><p>    (embeddings): RobertaEmbeddings(</p><p>      (word_embeddings): Embedding(50265, 768, padding_idx=1)</p><p>      (position_embeddings): Embedding(514, 768, padding_idx=1)</p><p>      (token_type_embeddings): Embedding(1, 768)</p><p>      (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>      (dropout): Dropout(p=0.1, inplace=False)</p><p>    )</p><p>    (encoder): RobertaEncoder(</p><p>      (layer): ModuleList(</p><p>        (0-11): 12 x RobertaLayer(</p><p>          (attention): RobertaAttention(</p><p>            (self): RobertaSelfAttention(</p><p>              (query): Linear(in_features=768, out_features=768, bias=True)</p><p>              (key): Linear(in_features=768, out_features=768, bias=True)</p><p>              (value): Linear(in_features=768, out_features=768, bias=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>            (output): RobertaSelfOutput(</p><p>              (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>              (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>              (dropout): Dropout(p=0.1, inplace=False)</p><p>            )</p><p>          )</p><p>          (intermediate): RobertaIntermediate(</p><p>            (dense): Linear(in_features=768, out_features=3072, bias=True)</p><p>            (intermediate_act_fn): GELUActivation()</p><p>          )</p><p>          (output): RobertaOutput(</p><p>            (dense): Linear(in_features=3072, out_features=768, bias=True)</p><p>            (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>            (dropout): Dropout(p=0.1, inplace=False)</p><p>          )</p><p>        )</p><p>      )</p><p>    )</p><p>  )</p><p>  (classifier): RobertaClassificationHead(</p><p>    (dense): Linear(in_features=768, out_features=768, bias=True)</p><p>    (dropout): Dropout(p=0.1, inplace=False)</p><p>    (out_proj): Linear(in_features=768, out_features=2, bias=True)</p><p>  )</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos dar uma olhada em sua última camada</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=2, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">out_features</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(768, 2)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vimos que nosso conjunto de dados tem 20 classes, mas esse modelo foi treinado para 2 classes, portanto, temos que modificar a última camada</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Linear(in_features=768, out_features=20, bias=True)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora é</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora criamos uma função de perda</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Um otimizador</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E, finalmente, uma métrica</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos verificar se está tudo certo com uma amostra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span> <span>=</span> <span style="color: #dfd84a;">next</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">iter</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]))</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(torch.Size([64, 130]), torch.Size([64, 130]))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, colocamos essa amostra no modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">ouputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">),</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64, 20])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que o modelo produz 64 lotes, o que é bom, porque definimos <code><b>BS = 20</b></code> e cada um com 20 saídas, o que é bom porque alteramos o modelo para produzir 20 valores.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtemos aquele com o valor mais alto</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">predictions</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([64])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtemos a perda</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ouputs</span><span>.</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">item</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>2.9990389347076416</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E a precisão</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">sample</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">])[</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">accuracy</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>0.015625</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora podemos criar um pequeno loop de treinamento</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">epochs</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">epochs</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>&lt;IPython.core.display.HTML object&gt;</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Script-com-a-base-de-código">
								<a class="anchor-link" href="#Script-com-a-base-de-código">
									<p style="margin-left: 30px">Script com a base de código</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A maior parte da documentação do <code><b>accelerate</b></code> explica como usar o <code><b>accelerate</b></code> com scripts, portanto, faremos isso por enquanto e explicaremos como fazer isso com um notebook no final.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, vamos criar uma pasta na qual salvaremos os scripts.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">mkdir</span> <span style="color: #6b97e8;">accelerate_scripts</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora escrevemos o código base em um script</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">loss</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/01_code_base.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E agora vamos executá-lo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">01</span><span style="color: #6b97e8;">_code_base</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112                                                               </p><p>CPU times: user 2.12 s, sys: 391 ms, total: 2.51 s</p><p>Wall time: 3min 36s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Em meu computador, levou cerca de 3 minutos e meio.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Código-com-aceleração">
								<a class="anchor-link" href="#Código-com-aceleração">
									<p style="margin-left: 30px">Código com aceleração</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos substituir alguns itens</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Primeiro, importamos o <code><b>Accelerator</b></code> e o inicializamos.</li>
									<li>Não fazemos mais o típico</li>
									<li>Em vez disso, deixamos o <code><b>accelerate</b></code> escolher o dispositivo por meio de</li>
									<li>Passamos os elementos relevantes para treinamento por meio do método <code><b>prepare</b></code> e não fazemos mais <code><b>model.to(device)</b></code>.</li>
									<li>Não enviamos mais os dados e o modelo para a GPU com <code><b>.to(device)</b></code>, pois o <code><b>accelerate</b></code> cuidou disso com o método <code><b>prepare</b></code>.</li>
									<li>Em vez de fazer a retropropagação com <code><b>loss.backward()</b></code>, deixamos que o <code><b>accelerate</b></code> faça isso com <code><b>loss.backward()</b></code>.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>from accelerate import Accelerator<br>acelerador = Acelerador()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>torch.device("cuda" if torch.cuda.is_available() else "cpu")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>dispositivo = accelerator.device<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model, optimizer, dataloader["train"], dataloader["validation"] = preprare(model, optimizer, dataloader["train"], dataloader["validation"])<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"> </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>accelerator.backward(loss)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Ao calcular a métrica no loop de validação, precisamos coletar os valores de todos os pontos, caso estejamos fazendo um treinamento distribuído.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>previsões = accelerator.gather_for_metrics(previsões)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">64</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of training epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of validation epoch </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">i</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, outputs[&#39;logits&#39;].shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">, labels.shape: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">labels</span><span>.</span><span style="color: #6b97e8;">shape</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/02_accelerate_base_code.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se você notar que adicionei essas duas linhas <code><b>print(f "End of training epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code> e a linha <code><b>print(f "End of validation epoch {i}, outputs['logits'].shape: {outputs['logits'].shape}, labels.shape: {labels.shape}")</b></code>, eu as adicionei de propósito porque elas revelarão algo muito importante</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos executá-lo. Para executar os scripts do <code><b>accelerate</b></code>, usamos o comando <code><b>accelerate launch</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>acelerar o lançamento do <script>.py<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">02</span><span style="color: #6b97e8;">_accelerate_base_code</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of training epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([64])</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>End of validation epoch 0, outputs['logits'].shape: torch.Size([64, 20]), labels.shape: torch.Size([8])</p><p>Accuracy = 0.206</p><p>CPU times: user 1.6 s, sys: 272 ms, total: 1.88 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que antes levava cerca de 3 minutos e meio e agora leva cerca de 2 minutos e meio. Uma melhora significativa. Além disso, se observarmos as impressões, veremos que elas foram impressas duas vezes.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E como isso é possível? Porque o <code><b>accelerate</b></code> paralelizou o treinamento nas duas GPUs que tenho, de modo que ele ficou muito mais rápido.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Além disso, quando executei o primeiro script, ou seja, quando não usei o <code><b>accelerate</b></code>, a GPU estava quase cheia, enquanto que quando executei o segundo, ou seja, o que usava o <code><b>accelerate</b></code>, as duas GPUs foram muito pouco usadas, portanto, podemos aumentar o tamanho do lote para tentar preencher ambas.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/03_accelerate_base_code_more_bs.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Removi as impressões extras, pois já vimos que o código está sendo executado em ambas as GPUs e aumentei o tamanho do lote de 64 para 128.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">03</span><span style="color: #6b97e8;">_accelerate_base_code_more_bs</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.1052                                                               </p><p>Accuracy = 0.1052</p><p>CPU times: user 1.41 s, sys: 180 ms, total: 1.59 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O aumento do tamanho do lote reduziu o tempo de execução em alguns segundos.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Execução-do-processo">
								<a class="anchor-link" href="#Execução-do-processo">
									<p style="margin-left: 20px">Execução do processo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Execução-de-código-em-um-único-processo">
								<a class="anchor-link" href="#Execução-de-código-em-um-único-processo">
									<p style="margin-left: 30px">Execução de código em um único processo</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Anteriormente, vimos que o <code><b>print</b></code> foi impresso duas vezes, isso ocorre porque o <code><b>accelerate</b></code> cria tantos processos quanto os dispositivos em que o código é executado; no meu caso, ele cria dois processos porque tenho duas GPUs.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No entanto, nem todo código deve ser executado em todos os processos, por exemplo, o <code><b>print</b></code> torna o código muito lento para ser executado várias vezes, se os pontos de verificação forem salvos, eles serão salvos duas vezes etc.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para executar parte de um código em um único processo, é necessário encapsulá-lo em uma função e decorá-la com <code><b>accelerator.on_local_main_process</b></code>. Por exemplo, no código a seguir, você verá que criei a seguinte função</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_main_process<br>def print_something(something):<br>    print(something)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Outra opção é colocar o código dentro de um <code><b>if accelerator.is_local_main_process</b></code>, como o código a seguir</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>se accelerator.is_local_main_process:<br>    print("Algo")<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">fastprogress.fastprogress</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">progress_bar</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">master_progress_bar</span> <span>=</span> <span style="color: #6b97e8;">master_bar</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">child</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #8d783e;">&#39;loss: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">loss</span><span style="color: #3b75c2;">}</span><span style="color: #8d783e;">&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">progress_bar</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">parent</span><span>=</span><span style="color: #6b97e8;">master_progress_bar</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p>    <span style="color: #6b97e8;">master_progress_bar</span><span>.</span><span style="color: #6b97e8;">main_bar</span><span>.</span><span style="color: #6b97e8;">comment</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Validation accuracy: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #a6a831;">\n</span><span style="color: #7e7a34;">&quot;</span></p>
<p></p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/04_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos executá-lo e ver</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">04</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2098                                                               </p><p>End of script with 0.2098 accuracy</p><p>CPU times: user 1.38 s, sys: 197 ms, total: 1.58 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, a impressão foi feita apenas uma vez</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No entanto, embora você não veja muito, as barras de progresso são executadas em cada processo.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Não encontrei uma maneira de contornar isso com as barras de progresso <code><b>fastprogress</b></code>, mas encontrei com as barras de progresso <code><b>tqdm</b></code>, portanto, substituirei as barras de progresso <code><b>fastprogress</b></code> pelas barras de progresso <code><b>tqdm</b></code> e, para que sejam executadas em um único processo, adicionarei o argumento <code><b>disable=not accelerator.is_local_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/05_accelerate_base_code_some_code_in_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">05</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [02:01&lt;00:00,  1.45it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.30it/s]</p><p>Accuracy = 0.2166</p><p>End of script with 0.2166 accuracy</p><p>CPU times: user 1.33 s, sys: 195 ms, total: 1.52 s</p><p>Wall time: 2min 22s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mostramos um exemplo de como imprimir em um único processo, e essa foi uma maneira de executar processos em um único processo. Mas se você quiser imprimir em um único processo, poderá usar o método <code><b>print</b></code> do <code><b>accelerate</b></code>. Vejamos o mesmo exemplo anterior com esse método</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_train = progress_bar(dataloader[&quot;train&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># master_progress_bar.child.comment = f&#39;loss: {loss}&#39;</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #7f6e38;"># progress_bar_validation = progress_bar(dataloader[&quot;validation&quot;], parent=master_progress_bar)</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #7f6e38;"># print(f&quot;Accuracy = {accuracy[&#39;accuracy&#39;]}&quot;)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/06_accelerate_base_code_print_one_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">06</span><span style="color: #6b97e8;">_accelerate_base_code_print_one_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15433.52 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 11406.61 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15036.87 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14932.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14956.60 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.33it/s]</p><p>Accuracy = 0.2134</p><p>End of script with 0.2134 accuracy</p><p>CPU times: user 1.4 s, sys: 189 ms, total: 1.59 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Execução-de-código-em-todos-os-processos">
								<a class="anchor-link" href="#Execução-de-código-em-todos-os-processos">
									<p style="margin-left: 30px">Execução de código em todos os processos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No entanto, há um código que deve ser executado em todos os processos, por exemplo, se fizermos o upload dos pontos de verificação para o hub, portanto, temos duas opções: encapsular o código em uma função e decorá-lo com <code><b>accelerator.on_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_main_process<br>def do_my_thing():<br>    "Algo feito uma vez por servidor<br>    do_thing_once()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ou colocar o código dentro de um <code><b>if accelerator.is_main_process</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>se accelerator.is_main_process:<br>    repo.push_to_hub()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como estamos treinando apenas para mostrar a biblioteca <code><b>accelerate</b></code> e o modelo que estamos treinando não é bom, não faz sentido carregar os pontos de verificação no hub, portanto, farei um exemplo com <code><b>print</b></code>s.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/06_accelerate_base_code_some_code_in_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos para ver</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">07</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14518.44 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:03&lt;00:00, 14368.77 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 16466.33 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14806.14 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14253.33 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14337.07 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:00&lt;00:00,  1.46it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.34it/s]</p><p>Accuracy = 0.2092</p><p>End of script with 0.2092 accuracy</p><p>All process: Accuracy = 0.2092</p><p>All process: End of script with 0.2092 accuracy</p><p>CPU times: user 1.42 s, sys: 216 ms, total: 1.64 s</p><p>Wall time: 2min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Execução-de-código-no-processo-X">
								<a class="anchor-link" href="#Execução-de-código-no-processo-X">
									<p style="margin-left: 30px">Execução de código no processo X</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por fim, podemos especificar em qual processo queremos executar o código. Para isso, precisamos criar uma função e decorá-la com <code><b>@accelerator.on_process(process_index=0)</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_process(process_index=0)<br>def do_my_thing():<br>    "Algo feito no índice de processo 0".<br>    do_thing_on_index_zero()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ou decorá-lo com <code><b>@accelerator.on_local_process(local_process_idx=0)</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>@accelerator.on_local_process(local_process_index=0)<br>def do_my_thing():<br>    "Algo feito no índice de processo 0 em cada servidor".<br>    do_thing_on_index_zero_on_each_server()<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aqui eu coloquei o processo 0, mas você pode colocar qualquer número.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/07_accelerate_base_code_some_code_in_some_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">08</span><span style="color: #6b97e8;">_accelerate_base_code_some_code_in_some_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15735.58 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14906.20 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [02:02&lt;00:00,  1.44it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:06&lt;00:00,  3.27it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.2128</p><p>End of script with 0.2128 accuracy</p><p>All process: Accuracy = 0.2128</p><p>All process: End of script with 0.2128 accuracy</p><p>Process 0: End of process 0</p><p>CPU times: user 1.42 s, sys: 295 ms, total: 1.71 s</p><p>Wall time: 2min 37s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Sincronizar-processos">
								<a class="anchor-link" href="#Sincronizar-processos">
									<p style="margin-left: 30px">Sincronizar processos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se tivermos um código que precisa ser executado em todos os processos, é interessante esperar que ele termine em todos os processos antes de executar outra tarefa, portanto, usamos <code><b>accelerator.wait_for_everyone()</b></code> para isso.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para ver isso, vamos colocar um atraso em uma das funções de impressão em um processo.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Também coloquei um intervalo no ciclo de treinamento para que ele não passe muito tempo treinando, o que não é o que nos interessa no momento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">process_index</span><span>=</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">time</span><span>.</span><span style="color: #6b97e8;">sleep</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 0: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_process</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">local_process_index</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Process 1: &quot;</span> <span>+</span> <span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #a04cc1;">break</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_all_processes</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">:</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;All process: End of script with </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;Printing with delay in process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_0</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 0&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">print_in_process_1</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of process 1&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_in_one_process</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;End of script&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/08_accelerate_base_code_sync_all_process.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">09</span><span style="color: #6b97e8;">_accelerate_base_code_sync_all_process</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14218.23 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14666.25 examples/s]</p><p>  0%|                                                   | 0/176 [00:00&lt;?, ?it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.58it/s]</p><p>Process 1: End of process 1</p><p>Accuracy = 0.212</p><p>End of script with 0.212 accuracy</p><p>All process: Accuracy = 0.212</p><p>All process: End of script with 0.212 accuracy</p><p>Printing with delay in process 0</p><p>Process 0: End of process 0</p><p>End of script</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como você pode ver, primeiro imprimimos <code><b>Process 1: End of process 1</b></code> e depois o restante, porque o restante das impressões é feito no processo 0 ou em todos os processos, portanto, até que o atraso de 2 segundos que colocamos não seja concluído, o restante do código não é executado.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Salvar-e-carregar-o-ditado-de-estado">
								<a class="anchor-link" href="#Salvar-e-carregar-o-ditado-de-estado">
									<p style="margin-left: 20px">Salvar e carregar o ditado de estado</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Quando treinamos, às vezes salvamos o estado para que possamos continuar em outro momento.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para salvar o estado, teremos que usar os métodos <code><b>save_state()</b></code> e <code><b>load_state()</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos los pesos</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Cargamos los pesos</span></p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">load_state</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accelerate_scripts/checkpoints&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_accelerate_save_and_load_checkpoints.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">10</span><span style="color: #6b97e8;">_accelerate_save_and_load_checkpoints</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.40it/s]</p><p>Accuracy = 0.2142</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Salvar-o-modelo">
								<a class="anchor-link" href="#Salvar-o-modelo">
									<p style="margin-left: 20px">Salvar o modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Quando o método <code><b>prepare</b></code> foi usado, o modelo foi empacotado para que pudesse ser salvo nos dispositivos necessários. Portanto, ao salvá-lo, temos que usar o método <code><b>save_model</b></code> que primeiro o desembrulha e depois o salva. Além disso, se usarmos o parâmetro <code><b>safe_serialization=True</b></code>, o modelo será salvo como um tensor <code><b>safe</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">wait_for_everyone</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">safe_serialization</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_model.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">11</span><span style="color: #6b97e8;">_accelerate_save_model</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>100%|█████████████████████████████████████████| 176/176 [01:58&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.35it/s]</p><p>Accuracy = 0.214</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Salvar-o-modelo-"pré-treinado">
								<a class="anchor-link" href="#Salvar-o-modelo-"pré-treinado">
									<p style="margin-left: 20px">Salvar o modelo "pré-treinado</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nos modelos que usam a biblioteca <code><b>transformers</b></code>, devemos salvar o modelo com o método <code><b>save_pretrained</b></code> para carregá-lo com o método <code><b>from_pretrained</b></code>. Antes de salvar, o modelo deve ser desempacotado com o método <code><b>unwrap_model</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #7f6e38;">@accelerator</span><span>.</span><span style="color: #6b97e8;">on_local_main_process</span></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">something</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># Guardamos el modelo pretrained</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">unwrap_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">unwrapped_model</span><span>.</span><span style="color: #6b97e8;">save_pretrained</span><span style="color: #e3e11d;">(</span></p>
<p>        <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">is_main_process</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_main_process</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #6b97e8;">save_function</span><span>=</span><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">print_something</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/11_accelerate_save_pretrained.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">12</span><span style="color: #6b97e8;">_accelerate_save_pretrained</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15152.47 examples/s]</p><p>Map: 100%|██████████████████████| 45000/45000 [00:02&lt;00:00, 15119.13 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12724.70 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 12397.49 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15247.21 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 15138.03 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:59&lt;00:00,  1.48it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:05&lt;00:00,  3.37it/s]</p><p>Accuracy = 0.21</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora podemos carregá-lo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModel</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;accelerate_scripts/model_pretrained&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoModel</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of RobertaModel were not initialized from the model checkpoint at accelerate_scripts/model_pretrained and are newly initialized: ['roberta.pooler.dense.bias', 'roberta.pooler.dense.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento-em-notebooks">
								<a class="anchor-link" href="#Treinamento-em-notebooks">
									<p style="margin-left: 20px">Treinamento em notebooks</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Até agora, vimos como executar scripts, mas se quiser executar o código em um notebook, podemos escrever o mesmo código de antes, mas encapsulado em uma função</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, importamos as bibliotecas</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">time</span></p>
<p><span style="color: #7f6e38;"># from accelerate import Accelerator</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora criamos a função</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">train_code</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">batch_size</span><span style="color: #e3e11d;">:</span> <span style="color: #dfd84a;">int</span> <span>=</span> <span style="color: #7e7a38;">64</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p>    <span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p>    <span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #6b97e8;">batch_size</span></p>
<p>    <span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>        <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #e3e11d;">}</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p>    <span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p>    <span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p>    <span style="color: #7f6e38;"># model.to(device)</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>            <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>            <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>                <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>            <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>            <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>            <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>        </p>
<p>    <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para executar o treinamento no notebook, usamos a função <code><b>notebook_launcher</b></code>, para a qual passamos a função que queremos executar, os argumentos dessa função e o número de GPUs nas quais vamos treinar com a variável <code><b>num_processes</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_launcher</span></p>
<p></p>
<p><span style="color: #6b97e8;">args</span> <span>=</span> <span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">128</span><span style="color: #e3e11d;">,)</span></p>
<p><span style="color: #6b97e8;">notebook_launcher</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">train_code</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">args</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_processes</span><span>=</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Accuracy = 0.2112</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento-em-FP16">
								<a class="anchor-link" href="#Treinamento-em-FP16">
									<p style="margin-left: 20px">Treinamento em FP16</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Quando configuramos o <code><b>accelerate</b></code> pela primeira vez, ele nos perguntou <code><b>Do you wish to use FP16 or BF16 (mixed precision)?</b></code> e dissemos que não, então agora vamos dizer que sim, que queremos usar FP16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Até agora, treinamos em FP32, o que significa que cada peso do modelo é um número de ponto flutuante de 32 bits, e agora vamos usar um número de ponto flutuante de 16 bits, ou seja, o modelo ocupará menos espaço. Portanto, duas coisas acontecerão: poderemos usar um tamanho de lote maior e ele também será mais rápido.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, reiniciamos o <code><b>accelerate config</b></code> e informamos que queremos o FP16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, criamos um script para treinar, com o mesmo tamanho de lote de antes, para ver se o tempo de treinamento é menor.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">128</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/12_accelerate_base_code_fp16_bs128.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos executá-lo e ver quanto tempo leva</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">13</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs128</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14983.76 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14315.47 examples/s]</p><p>100%|█████████████████████████████████████████| 176/176 [01:01&lt;00:00,  2.88it/s]</p><p>100%|███████████████████████████████████████████| 20/20 [00:02&lt;00:00,  6.84it/s]</p><p>Accuracy = 0.2094</p><p>CPU times: user 812 ms, sys: 163 ms, total: 976 ms</p><p>Wall time: 1min 27s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Quando executamos esse treinamento em FP32, demorou cerca de 2 minutos e meio, e agora demora cerca de 1 minuto e meio. Vamos ver se agora, em vez de treinar com um tamanho de lote de 128, o fazemos com um tamanho de lote de 256.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">256</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/13_accelerate_base_code_fp16_bs256.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 15390.30 examples/s]</p><p>Map: 100%|████████████████████████| 5000/5000 [00:00&lt;00:00, 14990.92 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:54&lt;00:00,  1.62it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:02&lt;00:00,  3.45it/s]</p><p>Accuracy = 0.2236</p><p>CPU times: user 670 ms, sys: 91.6 ms, total: 761 ms</p><p>Wall time: 1min 12s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A queda foi de apenas 15 segundos</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento-em-BF16">
								<a class="anchor-link" href="#Treinamento-em-BF16">
									<p style="margin-left: 20px">Treinamento em BF16</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes treinávamos no FP16 e agora vamos treinar no BF16, qual é a diferença?</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/05/FP32_FP16_BF16.webp" alt="FP32_FP16_BF16"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como podemos ver na figura, enquanto o FP16 comparado ao FP32 tem menos bits na mantissa e no expoente, o que torna seu intervalo muito menor, o BF16 comparado ao FP32 tem o mesmo número de bits no expoente, mas menos na mantissa, o que faz com que o BF16 tenha o mesmo intervalo de números que o FP32, mas seja menos preciso.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Isso é vantajoso porque, no FP16, alguns cálculos podem gerar números muito altos, que não poderiam ser representados no formato FP16. Além disso, há determinados dispositivos HW que são otimizados para esse formato.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como antes, executamos o <code><b>accelerate config</b></code> e indicamos que queremos o BF16.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>bf16</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, executamos o último script que criamos, ou seja, com um tamanho de lote de 256</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14814.95 examples/s]</p><p>Map: 100%|██████████████████████| 50000/50000 [00:03&lt;00:00, 14506.83 examples/s]</p><p>100%|███████████████████████████████████████████| 88/88 [00:51&lt;00:00,  1.70it/s]</p><p>100%|███████████████████████████████████████████| 10/10 [00:03&lt;00:00,  3.21it/s]</p><p>Accuracy = 0.2112</p><p>CPU times: user 688 ms, sys: 144 ms, total: 832 ms</p><p>Wall time: 1min 17s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Levou um tempo semelhante ao anterior, o que é normal, pois treinamos um modelo com pesos de 16 bits, como antes.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento-em-FP8">
								<a class="anchor-link" href="#Treinamento-em-FP8">
									<p style="margin-left: 20px">Treinamento em FP8</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos treinar no formato FP8, que, como o nome sugere, é um formato de ponto flutuante, em que cada peso tem 8 bits, portanto, executamos o <code><b>accelerate config</b></code> para informar que queremos o FP8.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">config</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>--------------------------------------------------------------------------------</p><p>In which compute environment are you running?</p><p>This machine</p><p>--------------------------------------------------------------------------------</p><p>multi-GPU</p><p>How many different machines will you use (use more than 1 for multi-node training)? [1]: 1</p><p>Should distributed operations be checked while running for errors? This can avoid timeout issues but will be slower. [yes/NO]: no</p><p>Do you wish to optimize your script with torch dynamo?[yes/NO]:no</p><p>Do you want to use DeepSpeed? [yes/NO]: no</p><p>Do you want to use FullyShardedDataParallel? [yes/NO]: no</p><p>Do you want to use Megatron-LM ? [yes/NO]: no</p><p>How many GPU(s) should be used for distributed training? [1]:2</p><p>What GPU(s) (by id) should be used for training on this machine as a comma-seperated list? [all]:0,1</p><p>--------------------------------------------------------------------------------</p><p>Do you wish to use FP16 or BF16 (mixed precision)?</p><p>fp8</p><p>accelerate configuration saved at ~/.cache/huggingface/accelerate/default_config.yaml</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, executamos o último script, o script de tamanho de lote de 256.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">14</span><span style="color: #6b97e8;">_accelerate_base_code_fp16_bs256</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/Documentos/web/portafolio/posts/accelerate_scripts/13_accelerate_base_code_fp16_bs256.py", line 12, in &lt;module&gt;</p><p>    accelerator = Accelerator()</p><p>                  ^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/accelerator.py", line 371, in __init__</p><p>    self.state = AcceleratorState(</p><p>                 ^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/state.py", line 790, in __init__</p><p>    raise ValueError(</p><p>ValueError: Using `fp8` precision requires `transformer_engine` or `MS-AMP` to be installed.</p><p>[2024-05-13 21:40:56,455] torch.distributed.elastic.multiprocessing.api: [ERROR] failed (exitcode: 1) local_rank: 0 (pid: 501480) of binary: /home/wallabot/miniconda3/envs/nlp/bin/python</p><p>Traceback (most recent call last):</p><p>  File "/home/wallabot/miniconda3/envs/nlp/bin/accelerate", line 8, in &lt;module&gt;</p><p>    sys.exit(main())</p><p>             ^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/accelerate_cli.py", line 46, in main</p><p>    args.func(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 1048, in launch_command</p><p>    multi_gpu_launcher(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/accelerate/commands/launch.py", line 702, in multi_gpu_launcher</p><p>    distrib_run.run(args)</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/run.py", line 803, in run</p><p>    elastic_launch(</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 135, in __call__</p><p>    return launch_agent(self._config, self._entrypoint, list(args))</p><p>           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p><p>  File "/home/wallabot/miniconda3/envs/nlp/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 268, in launch_agent</p><p>    raise ChildFailedError(</p><p>torch.distributed.elastic.multiprocessing.errors.ChildFailedError: </p><p>============================================================</p><p>accelerate_scripts/13_accelerate_base_code_fp16_bs256.py FAILED</p><p>------------------------------------------------------------</p><p>Failures:</p><p>[1]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 1 (local_rank: 1)</p><p>  exitcode  : 1 (pid: 501481)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>------------------------------------------------------------</p><p>Root Cause (first observed failure):</p><p>[0]:</p><p>  time      : 2024-05-13_21:40:56</p><p>  host      : wallabot</p><p>  rank      : 0 (local_rank: 0)</p><p>  exitcode  : 1 (pid: 501480)</p><p>  error_file: &lt;N/A&gt;</p><p>  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html</p><p>============================================================</p><p>CPU times: user 65.1 ms, sys: 14.5 ms, total: 79.6 ms</p><p>Wall time: 7.24 s</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como os pesos agora são de 8 bits e ocupam metade da memória, aumentaremos o tamanho do lote para 512.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.utils.data</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">DataLoader</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch.optim</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Adam</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">evaluate</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">tqdm</span></p>
<p></p>
<p><span style="color: #7f6e38;"># Importamos e inicializamos Accelerator</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Accelerator</span></p>
<p><span style="color: #6b97e8;">accelerator</span> <span>=</span> <span style="color: #6b97e8;">Accelerator</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;tweet_eval&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;emoji&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">info</span><span>.</span><span style="color: #6b97e8;">features</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">names</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">max_len</span> <span>=</span> <span style="color: #7e7a38;">130</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;cardiffnlp/twitter-roberta-base-irony&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #6b97e8;">max_len</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">]),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">set_format</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">type</span><span>=</span><span style="color: #7e7a34;">&quot;torch&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;input_ids&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;attention_mask&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">BS</span> <span>=</span> <span style="color: #7e7a38;">512</span></p>
<p><span style="color: #6b97e8;">dataloader</span> <span>=</span> <span style="color: #e3e11d;">{</span></p>
<p>    <span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p>    <span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #6b97e8;">DataLoader</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenized_dataset</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;test&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">batch_size</span><span>=</span><span style="color: #6b97e8;">BS</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">shuffle</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">),</span></p>
<p><span style="color: #e3e11d;">}</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_features</span><span>=</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">classifier</span><span>.</span><span style="color: #6b97e8;">out_proj</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_features</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">loss_function</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">CrossEntropyLoss</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">optimizer</span> <span>=</span> <span style="color: #6b97e8;">Adam</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">(),</span> <span style="color: #6b97e8;">lr</span><span>=</span><span style="color: #a09e19;">5e-4</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">evaluate</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p><span style="color: #7f6e38;"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">device</span></p>
<p></p>
<p><span style="color: #7f6e38;"># model.to(device)</span></p>
<p><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">prepare</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">optimizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">i</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_train</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;train&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_train</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">zero_grad</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">loss</span> <span>=</span> <span style="color: #6b97e8;">loss_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #7f6e38;"># loss.backward()</span></p>
<p>        <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">backward</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">loss</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">optimizer</span><span>.</span><span style="color: #6b97e8;">step</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p>    <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">progress_bar_validation</span> <span>=</span> <span style="color: #6b97e8;">tqdm</span><span>.</span><span style="color: #6b97e8;">tqdm</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataloader</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;validation&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">disable</span><span>=</span><span style="color: #7f6e38;">not</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">is_local_main_process</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">batch</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">progress_bar_validation</span><span style="color: #e3e11d;">:</span></p>
<p>        <span style="color: #6b97e8;">input_ids</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;input_ids&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">attention_mask</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;attention_mask&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">batch</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;label&quot;</span><span style="color: #e3e11d;">]</span><span style="color: #7f6e38;">#.to(device)</span></p>
<p></p>
<p>        <span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>            <span style="color: #6b97e8;">outputs</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">input_ids</span><span>=</span><span style="color: #6b97e8;">input_ids</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">attention_mask</span><span>=</span><span style="color: #6b97e8;">attention_mask</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">outputs</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;logits&#39;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">axis</span><span>=-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #7f6e38;"># Recopilamos las predicciones de todos los dispositivos</span></p>
<p>        <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">gather_for_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p>        <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">add_batch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">accuracy</span> <span>=</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">()</span></p>
<p>    </p>
<p><span style="color: #6b97e8;">accelerator</span><span>.</span><span style="color: #6b97e8;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Accuracy = </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">accuracy</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;accuracy&#39;</span><span style="color: #e3e11d;">]</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Writing accelerate_scripts/15_accelerate_base_code_fp8_bs512.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o executamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">time</span></p>
<p></p>
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">accelerate</span> <span style="color: #6b97e8;">launch</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">15</span><span style="color: #6b97e8;">_accelerate_base_code_fp8_bs512</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Inferência-de-modelo">
								<a class="anchor-link" href="#Inferência-de-modelo">
									<p style="margin-left: 10px">Inferência de modelo</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Uso-do-ecossistema-de-rosto-abraçado">
								<a class="anchor-link" href="#Uso-do-ecossistema-de-rosto-abraçado">
									<p style="margin-left: 20px">Uso do ecossistema de rosto abraçado</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ver como fazer a inferência de modelos grandes com a biblioteca de faces de abraço <code><b>transformers</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inferência-com-`pipeline`.">
								<a class="anchor-link" href="#Inferência-com-`pipeline`.">
									<p style="margin-left: 30px">Inferência com <code><b>pipeline</b></code>.</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se usarmos o ecossistema Hugging Face, é muito simples, pois tudo é produzido por baixo sem que tenhamos que fazer muito. No caso de usar o <code><b>pipeline</b></code>, que é a maneira mais fácil de fazer inferência com a biblioteca <code><b>transformers</b></code>, basta informar o modelo que queremos usar e, o que é muito importante, passar <code><b>device_map="auto"</b></code>. Isso fará com que o <code><b>accelerate</b></code> distribua o modelo entre as diferentes GPUs, a RAM da CPU ou o disco rígido, se necessário.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Há mais valores possíveis para <code><b>device_map</b></code>, que veremos mais adiante, mas, por enquanto, mantenha o <code><b>"auto"</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos usar o modelo <code><b>Llama3 8B</b></code>, que, como o nome sugere, é um modelo com cerca de 8 bilhões de parâmetros, já que cada parâmetro, por padrão, está no formato FP32, que corresponde a 4 bytes (32 bits), o que significa que, se multiplicarmos 8 bilhões de parâmetros por 4 bytes, teremos uma GPU com cerca de 32 GB de VRAM.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No meu caso, tenho duas GPUs com 24 GB de VRAM, portanto, não caberia em uma única GPU. Mas ao definir <code><b>device_map="auto"</b></code>, a aceleração distribuirá o modelo entre as duas GPUs e eu poderei realizar a inferência.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/09_inference_with_pipeline.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos executá-lo, mas como o pipeline usa o accelerate abaixo, não precisamos executá-lo com <code><b>accelerate launch script.py</b></code>, mas com <code><b>python script.py</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">16</span><span style="color: #6b97e8;">_inference_with_pipeline</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.27s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>[{'generated_text': 'Conoces accelerate de hugging face? ¿Qué es el modelo de lenguaje de transformers y cómo se utiliza en el marco de hugging face? ¿Cómo puedo utilizar modelos de lenguaje de transformers en mi aplicación? ¿Qué son los tokenizers y cómo se utilizan en el marco de hugging face? ¿Cómo puedo crear un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los datasets y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar datasets para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar finetuning para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los checkpoints y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar checkpoints para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los evaluadores y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar evaluadores para evaluar el rendimiento de un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los pre-trainados y cómo se utilizan en el marco de hugging face? ¿Cómo puedo utilizar pre-trainados para entrenar un modelo de lenguaje personalizado utilizando transformers y hugging face? ¿Qué son los finetuning'}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como você pode ver, ele não respondeu, mas continuou fazendo perguntas. Isso ocorre porque o Llama3 é um modelo de linguagem que prevê o próximo token, portanto, com o prompt que eu dei a ele, ele considerou que os próximos melhores tokens são aqueles que correspondem a mais perguntas. O que faz sentido, pois há momentos em que as pessoas têm dúvidas sobre um tópico e isso gera muitas perguntas, portanto, para que ele responda à pergunta, temos de condicioná-lo um pouco.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p><span style="color: #6b97e8;">generator</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">messages</span> <span>=</span> <span style="color: #e3e11d;">[</span></p>
<p>    <span style="color: #e3e11d;">{</span></p>
<p>        <span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;system&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>        <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;Eres un chatbot amigable que siempre intenta solucionar las dudas&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #e3e11d;">},</span></p>
<p>    <span style="color: #e3e11d;">{</span><span style="color: #7e7a34;">&quot;role&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #7e7a34;">&quot;user&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;content&quot;</span><span style="color: #e3e11d;">:</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">prompt</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">},</span></p>
<p><span style="color: #e3e11d;">]</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">generator</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">messages</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">output</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">][</span><span style="color: #8d783e;">&#39;generated_text&#39;</span><span style="color: #e3e11d;">][</span><span>-</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/10_inference_with_pipeline_condition.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como você pode ver, foi gerada uma mensagem com funções, condicionando o modelo e o prompt</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">17</span><span style="color: #6b97e8;">_inference_with_pipeline_condition</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.41s/it]</p><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>{'role': 'assistant', 'content': '¡Hola!\n\nSí, conozco Accelerate de Hugging Face. Accelerate es una biblioteca de Python desarrollada por Hugging Face que se enfoca en simplificar y acelerar el entrenamiento y la evaluación de modelos de lenguaje en diferentes dispositivos y entornos.\n\nCon Accelerate, puedes entrenar modelos de lenguaje en diferentes plataformas y dispositivos, como GPUs, TPUs, CPUs y servidores, sin necesidad de cambiar el código de tu modelo. Esto te permite aprovechar al máximo la potencia de cálculo de tus dispositivos y reducir el tiempo de entrenamiento.\n\nAccelerate también ofrece varias características adicionales, como:\n\n* Soporte para diferentes frameworks de machine learning, como TensorFlow, PyTorch y JAX.\n* Integración con diferentes sistemas de almacenamiento y procesamiento de datos, como Amazon S3 y Google Cloud Storage.\n* Soporte para diferentes protocolos de comunicación, como HTTP y gRPC.\n* Herramientas para monitorear y depurar tus modelos en tiempo real.\n\nEn resumen, Accelerate es una herramienta muy útil para desarrolladores de modelos de lenguaje que buscan simplificar y acelerar el proceso de entrenamiento y evaluación de sus modelos.\n\n¿Tienes alguna pregunta específica sobre Accelerate o necesitas ayuda para implementarlo en tu proyecto?'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora a resposta, se ela responder ao nosso prompt</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inferência-com-`AutoClass`.">
								<a class="anchor-link" href="#Inferência-com-`AutoClass`.">
									<p style="margin-left: 30px">Inferência com <code><b>AutoClass</b></code>.</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por fim, veremos como fazer a inferência somente com o <code><b>AutoClass</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span>%%</span><span style="color: #6b97e8;">writefile</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
<p></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TextStreamer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #7e7a34;">&quot;meta-llama/Meta-Llama-3-8B-Instruct&quot;</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForCausalLM</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">streamer</span> <span>=</span> <span style="color: #6b97e8;">TextStreamer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">prompt</span> <span>=</span> <span style="color: #7e7a34;">&quot;Conoces accelerate de hugging face?&quot;</span></p>
<p><span style="color: #6b97e8;">tokens_input</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">([</span><span style="color: #6b97e8;">prompt</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">_</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">generate</span><span style="color: #e3e11d;">(</span><span>**</span><span style="color: #6b97e8;">tokens_input</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">streamer</span><span>=</span><span style="color: #6b97e8;">streamer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_new_tokens</span><span>=</span><span style="color: #7e7a38;">500</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">do_sample</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">50</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_p</span><span>=</span><span style="color: #a09e19;">0.95</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">temperature</span><span>=</span><span style="color: #a09e19;">0.7</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Overwriting accelerate_scripts/11_inference_with_autoclass.py</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como você pode ver, o objeto <code><b>streamer</b></code> foi criado e, em seguida, é passado para o método <code><b>generate</b></code> do modelo. Isso é útil para que cada palavra seja impressa à medida que é gerada e você não precise esperar que toda a saída seja gerada antes de imprimi-la.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #7f6e38;">!</span><span style="color: #6b97e8;">python</span> <span style="color: #6b97e8;">accelerate_scripts</span><span>/</span><span style="color: #7e7a38;">18</span><span style="color: #6b97e8;">_inference_with_autoclass</span><span>.</span><span style="color: #6b97e8;">py</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.</p><p>Loading checkpoint shards: 100%|██████████████████| 4/4 [00:09&lt;00:00,  2.28s/it]</p><p>Setting `pad_token_id` to `eos_token_id`:128001 for open-end generation.</p><p>&lt;|begin_of_text|&gt;Conoces accelerate de hugging face? Si es así, puedes utilizar la biblioteca `transformers` de Hugging Face para crear un modelo de lenguaje que pueda predecir la siguiente palabra en una secuencia de texto.</p><p>Aquí te muestro un ejemplo de cómo hacerlo:</p><p>```</p><p>import pandas as pd</p><p>import torch</p><p>from transformers import AutoModelForSequenceClassification, AutoTokenizer</p><p># Cargar el modelo y el tokenizador</p><p>model_name = "bert-base-uncased"</p><p>model = AutoModelForSequenceClassification.from_pretrained(model_name)</p><p>tokenizer = AutoTokenizer.from_pretrained(model_name)</p><p># Cargar el conjunto de datos</p><p>train_df = pd.read_csv("train.csv")</p><p>test_df = pd.read_csv("test.csv")</p><p># Preprocesar los datos</p><p>train_texts = train_df["text"]</p><p>train_labels = train_df["label"]</p><p>test_texts = test_df["text"]</p><p># Convertir los textos en entradas para el modelo</p><p>train_encodings = tokenizer.batch_encode_plus(train_texts, </p><p>                                              add_special_tokens=True, </p><p>                                              max_length=512, </p><p>                                              return_attention_mask=True, </p><p>                                              return_tensors='pt')</p><p>test_encodings = tokenizer.batch_encode_plus(test_texts, </p><p>                                             add_special_tokens=True, </p><p>                                             max_length=512, </p><p>                                             return_attention_mask=True, </p><p>                                             return_tensors='pt')</p><p># Crear un dataloader para entrenar el modelo</p><p>train_dataset = torch.utils.data.TensorDataset(train_encodings["input_ids"], </p><p>                                               train_encodings["attention_mask"], </p><p>                                               torch.tensor(train_labels))</p><p>train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=32, shuffle=True)</p><p># Entrenar el modelo</p><p>device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</p><p>model.to(device)</p><p>criterion = torch.nn.CrossEntropyLoss()</p><p>optimizer = torch.optim.Adam(model.parameters(), lr=1e-5)</p><p>for epoch in range(5):</p><p>    model.train()</p><p>    total_loss = 0</p><p>    for batch in train_loader:</p><p>        input_ids = batch[0].to(device)</p><p>        attention_mask = batch[1].to(device)</p><p>        labels = batch[2].to(device)</p><p>        optimizer.zero_grad()</p><p>        outputs = model(input_ids, attention_mask=attention_mask, labels=labels)</p><p>        loss = criterion(outputs, labels)</p><p>        loss.backward()</p><p>        optimizer.step()</p><p>        total_loss += loss.item()</p><p>    print(f"Epoch {epoch+1}, Loss: {total</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Use-pytorch">
								<a class="anchor-link" href="#Use-pytorch">
									<p style="margin-left: 20px">Use pytorch</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Normalmente, a maneira de fazer inferências com o pytorch é criar um modelo com os pesos inicializados aleatoriamente e, em seguida, carregar um <code><b>state dict</b></code> com os pesos do modelo pré-treinado.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">weights</span><span>=</span><span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">ResNet152_Weights</span><span>.</span><span style="color: #6b97e8;">IMAGENET1K_V1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">save</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">(),</span> <span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Downloading: "https://download.pytorch.org/models/resnet152-394f9c45.pth" to /home/maximo.fernandez/.cache/torch/hub/checkpoints/resnet152-394f9c45.pth</p><p>100%|██████████| 230M/230M [02:48&lt;00:00, 1.43MB/s] </p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora que temos o <code><b>state dict</b></code>, vamos fazer a inferência como normalmente fazemos no pytorch.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span>     <span style="color: #7f6e38;"># Set device</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Create model with random weights and move to device</span></p>
<p><span style="color: #6b97e8;">state_dict</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">map_location</span><span>=</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load pretrained weights into device memory</span></p>
<p><span style="color: #6b97e8;">resnet152</span><span>.</span><span style="color: #6b97e8;">load_state_dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">state_dict</span><span style="color: #e3e11d;">)</span> <span style="color: #7f6e38;"># Load this weights into the model</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos explicar o que aconteceu</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Quando usamos <code><b>resnet152 = models.resnet152().to(device)</b></code>, um resnet152 com pesos aleatórios foi carregado na memória da GPU.</li>
									<li>Quando fizemos <code><b>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)</b></code>, um dicionário com os pesos treinados foi carregado na memória da GPU.</li>
									<li>Quando fizemos <code><b>resnet152.load_state_dict(state_dict)</b></code>, esses pesos pré-treinados foram atribuídos ao modelo.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ou seja, o modelo foi carregado duas vezes na memória da GPU.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Você pode estar se perguntando por que fizemos primeiro</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br>torch.save(model.state_dict(), 'accelerate_scripts/resnet152_pretrained.pth')<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para então fazer</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>resnet152 = models.resnet152().to(device)<br>state_dict = torch.load('accelerate_scripts/resnet152_pretrained.pth', map_location=device)<br>resnet152.load_state_dict(state_dict)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E por que não usamos diretamente</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>model = models.resnet152(weights=models.ResNet152_Weights.IMAGENET1K_V1)<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E paramos de salvar o <code><b>state dict</b></code> para carregá-lo mais tarde. Bem, porque o Pytorch, por exemplo, faz a mesma coisa que nós fizemos. Portanto, para poder ver todo o processo, fizemos em várias linhas o que o Pytorch faz em uma linha</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Essa maneira de trabalhar funcionou bem até agora, desde que os modelos tivessem um tamanho gerenciável para as GPUs dos usuários. Porém, desde o advento dos LLMs, essa abordagem não faz mais sentido.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por exemplo, um modelo de 6B parâmetros ocuparia 24 GB de memória e, como é carregado duas vezes com essa forma de trabalho, seria necessária uma GPU de 48 GB.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Portanto, para corrigir isso, a maneira de carregar um modelo pré-treinado do Pytorch é:</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Crie um modelo vazio com <code><b>init_empty_weights</b></code> que não ocupará a RAM.</li>
									<li>Em seguida, carregue os pesos com <code><b>load_checkpoint_and_dispatch</b></code>, que carregará um ponto de verificação dentro do modelo vazio e distribuirá os pesos de cada camada em todos os dispositivos disponíveis (GPU, CPU, RAM e disco rígido), graças à configuração <code><b>device_map="auto"</b></code>.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torchvision.models</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">models</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">models</span><span>.</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p><span style="color: #6b97e8;">resnet152</span> <span>=</span> <span style="color: #6b97e8;">load_checkpoint_and_dispatch</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">checkpoint</span><span>=</span><span style="color: #8d783e;">&#39;accelerate_scripts/resnet152_pretrained.pth&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">device_map</span><span>=</span><span style="color: #7e7a34;">&quot;auto&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">device</span> <span>=</span> <span style="color: #7e7a34;">&quot;cuda&quot;</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_available</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #7e7a34;">&quot;cpu&quot;</span></p>
<p></p>
<p><span style="color: #dfd84a;">input</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">rand</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">224</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span>  <span style="color: #7f6e38;"># Random image with batch size 1</span></p>
<p><span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">resnet152</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">input</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">shape</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>torch.Size([1, 1000])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Como-a-aceleração-funciona-abaixo">
								<a class="anchor-link" href="#Como-a-aceleração-funciona-abaixo">
									<p style="margin-left: 20px">Como a aceleração funciona abaixo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Neste vídeo, você pode ver graficamente como a aceleração funciona por baixo.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><iframe width="1280" height="720" src="https://www.youtube.com/embed/MWCSGj9jEAo" title="Accelerate Big Model Inference: How Does it Work?" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Inicialização-de-um-modelo-vazio">
								<a class="anchor-link" href="#Inicialização-de-um-modelo-vazio">
									<p style="margin-left: 30px">Inicialização de um modelo vazio</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O Accelerate cria o esqueleto de um modelo vazio usando <code><b>init_empty_weights</b></code> para que ele ocupe o mínimo de memória possível.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por exemplo, vamos ver quanta RAM eu tenho disponível em meu computador.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">psutil</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">get_ram_info</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">ram</span> <span>=</span> <span style="color: #dfd84a;">dict</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">psutil</span><span>.</span><span style="color: #6b97e8;">virtual_memory</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">_asdict</span><span style="color: #e3e11d;">())</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;total&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Available RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;available&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB, Used RAM: </span><span style="color: #3b75c2;">{</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">ram</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;used&#39;</span><span style="color: #e3e11d;">]</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span>/</span><span style="color: #7e7a38;">1024</span><span style="color: #e3e11d;">)</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.62 GB, Used RAM: 7.82 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Tenho cerca de 22 GB de RAM disponíveis</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos tentar criar um modelo de 5000x1000x1000 parâmetros, ou seja, 5B parâmetros, se cada parâmetro estiver em FP32, o que significa 20 GB de RAM.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">torch</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">nn</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se olharmos para a RAM novamente</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 3.77 GB, Used RAM: 26.70 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como podemos ver, agora temos apenas 3 GB de RAM disponíveis.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, vamos excluir o modelo para liberar a RAM</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">del</span> <span style="color: #6b97e8;">model</span></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.44 GB, Used RAM: 8.03 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Voltamos a ter cerca de 22 GB de RAM disponíveis.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos agora usar o <code><b>init_empty_weights</b></code> do <code><b>accelerate</b></code> e, em seguida, examinar a RAM.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">accelerate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">init_empty_weights</span></p>
<p></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">init_empty_weights</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Sequential</span><span style="color: #e3e11d;">(</span><span>*</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">5000</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">_</span> <span style="color: #7f6e38;">in</span> <span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1000</span><span style="color: #e3e11d;">)])</span></p>
<p></p>
<p><span style="color: #6b97e8;">get_ram_info</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total RAM: 31.24 GB, Available RAM: 22.32 GB, Used RAM: 8.16 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes, tínhamos exatamente 22,44 GB livres e, depois de criar o modelo com <code><b>init_empty_weights</b></code>, temos 22,32 GB. A economia de RAM é enorme! Quase nenhuma RAM foi usada para criar o modelo.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Isso se baseia no metadevice introduzido no PyTorch 1.9, portanto, é importante que, para usar o <code><b>accelerate</b></code>, tenhamos uma versão mais recente do Pytorch.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Carregamento-de-pesos">
								<a class="anchor-link" href="#Carregamento-de-pesos">
									<p style="margin-left: 30px">Carregamento de pesos</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de inicializar o modelo, precisamos carregar os pesos, o que é feito pelo <code><b>load_checkpoint_and_dispatch</b></code> que, como o nome sugere, carrega os pesos e os envia para os dispositivos necessários.</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>

