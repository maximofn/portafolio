<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Explicação-do-LoRA-index">
									<a class="anchor-link" href="#Explicação-do-LoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Explicação do LoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Atualização-de-pesos-em-uma-rede-neural-index">
									<a class="anchor-link" href="#Atualização-de-pesos-em-uma-rede-neural">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Atualização de pesos em uma rede neural</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Implementação-de-LoRA-em-transformadores-index">
									<a class="anchor-link" href="#Implementação-de-LoRA-em-transformadores">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Implementação de LoRA em transformadores</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Tamanho-do-intervalo-r-index">
									<a class="anchor-link" href="#Tamanho-do-intervalo-r">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Tamanho do intervalo r</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Inicialização-das-matrizes-A-e-B-index">
									<a class="anchor-link" href="#Inicialização-das-matrizes-A-e-B">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Inicialização das matrizes A e B</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Influência-do-LoRA-por-meio-do-parâmetro-α-index">
									<a class="anchor-link" href="#Influência-do-LoRA-por-meio-do-parâmetro-α">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Influência do LoRA por meio do parâmetro α</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Vantagens-da-LoRA
-index">
									<a class="anchor-link" href="#Vantagens-da-LoRA
">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Vantagens da LoRA
</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Implementação-de-LoRA-em-um-LLM-index">
									<a class="anchor-link" href="#Implementação-de-LoRA-em-um-LLM">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Implementação de LoRA em um LLM</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Faça-login-no-hub-index">
									<a class="anchor-link" href="#Faça-login-no-hub">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Faça login no hub</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Conjunto-de-dados-index">
									<a class="anchor-link" href="#Conjunto-de-dados">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Conjunto de dados</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Tokeniser-index">
									<a class="anchor-link" href="#Tokeniser">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Tokeniser</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Modelo-index">
									<a class="anchor-link" href="#Modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-index">
									<a class="anchor-link" href="#Treinamento">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Avaliação-index">
									<a class="anchor-link" href="#Avaliação">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Avaliação</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Publicar-o-modelo-index">
									<a class="anchor-link" href="#Publicar-o-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Publicar o modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Teste-de-modelo-index">
									<a class="anchor-link" href="#Teste-de-modelo">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Teste de modelo</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Implementação-de-LoRA-em-um-LLM-com-PEFT-da-Hugging-Face-index">
									<a class="anchor-link" href="#Implementação-de-LoRA-em-um-LLM-com-PEFT-da-Hugging-Face">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Implementação de LoRA em um LLM com PEFT da Hugging Face</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Faça-login-no-hub-index">
									<a class="anchor-link" href="#Faça-login-no-hub">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Faça login no hub</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Conjunto-de-dados-index">
									<a class="anchor-link" href="#Conjunto-de-dados">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Conjunto de dados</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Tokeniser-index">
									<a class="anchor-link" href="#Tokeniser">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Tokeniser</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Modelo-index">
									<a class="anchor-link" href="#Modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-com-PEFT-index">
									<a class="anchor-link" href="#LoRA-com-PEFT">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA com PEFT</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-index">
									<a class="anchor-link" href="#Treinamento">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Avaliação-index">
									<a class="anchor-link" href="#Avaliação">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Avaliação</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Publicar-o-modelo-index">
									<a class="anchor-link" href="#Publicar-o-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Publicar o modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Teste-do-modelo-treinado-com-PEFT-index">
									<a class="anchor-link" href="#Teste-do-modelo-treinado-com-PEFT">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Teste do modelo treinado com PEFT</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/notebooks_translated/2024-07-20-LoRA_PT.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="LoRA---adaptação-de-baixa-classificação-de-grandes-modelos-de-linguagem">
								<a class="anchor-link" href="#LoRA---adaptação-de-baixa-classificação-de-grandes-modelos-de-linguagem">
									<p style="margin-left: 0px">LoRA - adaptação de baixa classificação de grandes modelos de linguagem</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Este caderno foi traduzido automaticamente para torná-lo acessível a mais pessoas, por favor me avise se você vir algum erro de digitação..</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O tamanho cada vez maior dos modelos de linguagem torna cada vez mais caro treiná-los, pois é necessário cada vez mais VRAM para armazenar todos os seus parâmetros e gradientes derivados do treinamento.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No artigo <a href="https://arxiv.org/abs/2106.09685" target="_blank">LoRA - Low rank adaption of large language models</a>, eles propõem congelar os pesos do modelo e treinar duas matrizes chamadas A e B, o que reduz bastante o número de parâmetros a serem treinados.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/LoRA_adapat.webp" alt="LoRA"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vejamos como isso é feito</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Explicação-do-LoRA">
								<a class="anchor-link" href="#Explicação-do-LoRA">
									<p style="margin-left: 10px">Explicação do LoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Atualização-de-pesos-em-uma-rede-neural">
								<a class="anchor-link" href="#Atualização-de-pesos-em-uma-rede-neural">
									<p style="margin-left: 20px">Atualização de pesos em uma rede neural</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para entender como o LoRA funciona, primeiro precisamos lembrar o que acontece quando treinamos um modelo. Vamos voltar à parte mais básica da aprendizagem profunda: temos uma camada densa de uma rede neural que é definida como:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx + b</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Onde W é a matriz de pesos e b é o vetor de polarização.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para simplificar, vamos supor que não haja viés, de modo que ficaria assim</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Suponha que, para uma entrada x, queremos que ela tenha uma saída ŷ.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Primeiro, calculamos o resultado que obtemos com nosso valor atual de pesos W, ou seja, obtemos o valor y.</li>
									<li>Em seguida, calculamos o erro que existe entre o valor de y que obtivemos e o valor que queríamos obter ŷ. Chamamos esse erro de loss e o calculamos com alguma função matemática, não importa qual.</li>
									<li>Calculamos a derivada do erro loss com relação à matriz de peso W, ou seja, ΔW = dloss/dW.</li>
									<li>Atualizamos os pesos W subtraindo de cada um de seus valores o valor do gradiente multiplicado por um fator de aprendizado α, ou seja, W = W - α·ΔW.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O que os autores do LoRA propõem é que a matriz de peso W possa ser decomposta em</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">W ~ W + ΔW</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Portanto, ao congelar a matriz W e treinar somente a matriz ΔW, é possível obter um modelo que se ajusta aos novos dados sem precisar treinar novamente o modelo inteiro.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mas você pode pensar que ΔW é uma matriz de tamanho igual a W e, portanto, nada foi ganho, mas aqui os autores se baseiam em <code><b>Aghajanyan et al. (2020)</b></code>, um artigo no qual eles mostraram que, embora os modelos de linguagem sejam grandes e seus parâmetros sejam matrizes com dimensões muito grandes, para adaptá-los a novas tarefas não é necessário alterar todos os valores das matrizes, mas alterar alguns valores é suficiente, o que, em termos técnicos, é chamado de Low Rank Adaptation (LoRA). Daí o nome LoRA (Low Rank Adaptation).</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Congelamos o modelo e agora queremos treinar a matriz ΔW. Vamos supor que tanto W quanto ΔW sejam matrizes de tamanho 20x10, portanto, temos 200 parâmetros treináveis.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, vamos supor que a matriz ΔW possa ser decomposta no produto de duas matrizes A e B, ou seja</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ΔW = A · B</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para que essa multiplicação ocorra, os tamanhos das matrizes A e B devem ser 20xn e 10x10, respectivamente. Suponha que n=5, então A teria o tamanho de 20x5, ou seja, 100 parâmetros, e B o tamanho de 5x10, ou seja, 50 parâmetros, de modo que teríamos 100+50=150 parâmetros treináveis. Já temos menos parâmetros treináveis do que antes</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos supor que W seja, na verdade, uma matriz de tamanho 10.000x10.000, de modo que teríamos 100.000.000 parâmetros treináveis, mas se decompusermos ΔW em A e B com n=5, teríamos uma matriz de tamanho 10.000x5 e outra de tamanho 5x10.000, de modo que teríamos 50.000 parâmetros de uma e outros 50.000 parâmetros da outra, em um total de 100.000 parâmetros treináveis, ou seja, reduzimos o número de parâmetros 1.000 vezes.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Você já pode ver o poder do LoRA: quando você tem modelos muito grandes, o número de parâmetros treináveis pode ser bastante reduzido.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se olharmos novamente para a imagem da arquitetura do LoRA, entenderemos melhor.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/LoRA_adapat.webp" alt="LoRA adapt"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mas a economia no número de parâmetros treináveis com essa imagem parece ainda melhor.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/Lora_matmul.webp" alt="LoRA matmul"></p></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Implementação-de-LoRA-em-transformadores">
								<a class="anchor-link" href="#Implementação-de-LoRA-em-transformadores">
									<p style="margin-left: 20px">Implementação de LoRA em transformadores</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como os modelos de linguagem são implementações de transformadores, vamos ver como o LoRA é implementado nos transformadores. Na arquitetura do transformador, há camadas lineares nas matrizes de atenção Q, K e V e nas camadas de feedforward, de modo que o LoRA pode ser aplicado a todas essas camadas lineares. No artigo, eles afirmam que, para simplificar, aplicam o LoRA somente às camadas lineares das matrizes de atenção Q, K e V.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Essas camadas têm um tamanho de d_model x d_model, em que d_model é a dimensão de incorporação do modelo.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Tamanho-do-intervalo-r">
								<a class="anchor-link" href="#Tamanho-do-intervalo-r">
									<p style="margin-left: 20px">Tamanho do intervalo r</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para obter esses benefícios, o tamanho do intervalo r deve ser menor que o tamanho das camadas lineares. Como dissemos que eles só o implementaram nas camadas lineares de atenção, que têm um tamanho d_model x d_model, o tamanho do intervalo r deve ser menor que d_model.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Inicialização-das-matrizes-A-e-B">
								<a class="anchor-link" href="#Inicialização-das-matrizes-A-e-B">
									<p style="margin-left: 20px">Inicialização das matrizes A e B</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As matrizes A e B são inicializadas com uma distribuição gaussiana aleatória para A e zero para B, de modo que o produto de ambas as matrizes será zero no início, ou seja</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ΔW = A · B = 0</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Influência-do-LoRA-por-meio-do-parâmetro-α">
								<a class="anchor-link" href="#Influência-do-LoRA-por-meio-do-parâmetro-α">
									<p style="margin-left: 20px">Influência do LoRA por meio do parâmetro α</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por fim, na implementação do LoRA, um parâmetro α é adicionado para estabelecer o grau de influência do LoRA no treinamento. Ele é semelhante à taxa de aprendizado no ajuste fino normal, mas, nesse caso, é usado para estabelecer a influência do LoRA no treinamento. Assim, a fórmula do LoRA seria a seguinte</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">W = W + α ΔW = W + α(A · B)</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Vantagens-da-LoRA
">
								<a class="anchor-link" href="#Vantagens-da-LoRA
">
									<p style="margin-left: 10px">Vantagens da LoRA
</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Implementação-de-LoRA-em-um-LLM">
								<a class="anchor-link" href="#Implementação-de-LoRA-em-um-LLM">
									<p style="margin-left: 10px">Implementação de LoRA em um LLM</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos repetir o código de treinamento da postagem <a href="https://maximofn.com/fine-tuning-sml/" target="_blank">Fine tuning SLMs</a>, especificamente o treinamento para classificação de texto com as bibliotecas Hugging Face, mas, desta vez, faremos isso com LoRA. Na publicação anterior, usamos um tamanho de lote de 28 para o loop de treinamento e 40 para o loop de avaliação; no entanto, como agora não vamos treinar todos os pesos do modelo, mas apenas as matrizes LoRA, poderemos usar um tamanho de lote maior.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Faça-login-no-hub">
								<a class="anchor-link" href="#Faça-login-no-hub">
									<p style="margin-left: 20px">Faça login no hub</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Fazemos login para carregar o modelo no Hub</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_login</span></p>
<p><span style="color: #6b97e8;">notebook_login</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Conjunto-de-dados">
								<a class="anchor-link" href="#Conjunto-de-dados">
									<p style="margin-left: 20px">Conjunto de dados</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Baixamos o conjunto de dados que usaremos, que é um conjunto de dados de avaliações da <a href="https://huggingface.co/datasets/mteb/amazon_reviews_multi" target="_blank">Amazon</a></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mteb/amazon_reviews_multi&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;en&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 200000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um subconjunto para o caso de você querer testar o código com um conjunto de dados menor. No meu caso, usarei 100% do conjunto de dados.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">percentage</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos uma amostra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">random</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">randint</span></p>
<p></p>
<p><span style="color: #6b97e8;">idx</span> <span>=</span> <span style="color: #6b97e8;">randint</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">,</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0388304',</p><p> 'text': 'The N was missing from on\n\nThe N was missing from on',</p><p> 'label': 0,</p><p> 'label_text': '0'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para obter o número de classes, usamos <code><b>dataset['train']</b></code> e não <code><b>subset_dataset_train</b></code> porque, se o subconjunto for muito pequeno, talvez não haja exemplos com todas as classes possíveis do conjunto de dados original.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">unique</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>5</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para criar o campo <code><b>label</b></code> no conjunto de dados. O conjunto de dados baixado tem o campo <code><b>labels</b></code>, mas a biblioteca <code><b>transformers</b></code> precisa que o campo seja chamado <code><b>label</b></code> e não <code><b>labels</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">set_labels</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;labels&#39;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">]</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">example</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aqui está um exemplo novamente</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0388304',</p><p> 'text': 'The N was missing from on\n\nThe N was missing from on',</p><p> 'label': 0,</p><p> 'label_text': '0',</p><p> 'labels': 0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Tokeniser">
								<a class="anchor-link" href="#Tokeniser">
									<p style="margin-left: 20px">Tokeniser</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Implementamos o tokenizador. Para evitar erros, atribuímos o token de fim de cadeia ao token de preenchimento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #7e7a34;">&quot;openai-community/gpt2&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">pad_token</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">eos_token</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para tokenizar o conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #7e7a38;">768</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados e removemos as colunas de que não precisamos.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos uma amostra novamente, mas, nesse caso, vemos apenas as <code><b>keys</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">keys</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>dict_keys(['labels', 'input_ids', 'attention_mask'])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Modelo">
								<a class="anchor-link" href="#Modelo">
									<p style="margin-left: 20px">Modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Instanciamos o modelo. Além disso, para evitar erros, atribuímos o token do final da string ao token de preenchimento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">pad_token_id</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">eos_token_id</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como vimos na postagem <a href="https://maximofn.com/fine-tuning-sml/" target="_blank">Fine tuning SLMs</a>, recebemos um aviso de que algumas camadas não foram inicializadas. Isso ocorre porque, nesse caso, como se trata de um problema de classificação e, quando instanciamos o modelo, dissemos a ele que queríamos que fosse um modelo de classificação com 5 classes, a biblioteca eliminou a última camada e a substituiu por uma de 5 neurônios na saída. Se você não entender isso, vá para a postagem que citei, que está mais bem explicada.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes de implementar o LoRA, verificamos o número de parâmetros treináveis que o modelo tem.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">total_params</span> <span>=</span> <span style="color: #dfd84a;">sum</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">numel</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">p</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">requires_grad</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total trainable parameters before: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">total_params</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">,</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total trainable parameters before: 124,443,648</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que você tem 124 milhões de parâmetros treináveis. Agora vamos congelá-los</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">param</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">param</span><span>.</span><span style="color: #6b97e8;">requires_grad</span> <span>=</span> <span style="color: #7f6e38;">False</span></p>
<p></p>
<p><span style="color: #6b97e8;">total_params</span> <span>=</span> <span style="color: #dfd84a;">sum</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">numel</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">p</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">requires_grad</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total trainable parameters after: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">total_params</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">,</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total trainable parameters after: 0</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Após o congelamento, não há mais parâmetros treináveis</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ver como é o modelo antes de aplicar o LoRA.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, criamos a camada LoRA.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ele precisa herdar do <code><b>torch.nn.Module</b></code> para que possa atuar como uma camada de uma rede neural.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No método <code><b>_init_</b></code>, criamos os vetores <code><b>A</b></code> e <code><b>B</b></code> inicializados conforme explicado acima, o vetor <code><b>A</b></code> com uma distribuição gaussiana aleatória e o vetor <code><b>B</b></code> com zeros. Também criamos os parâmetros <code><b>rank</b></code> e <code><b>alpha</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No método "forward", calculamos o LoRA conforme explicado acima.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #a04cc1;">class</span> <span style="color: #7f6e38;">LoRALayer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Module</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">__init__</span><span style="color: #e3e11d;">(</span><span style="color: #7f6e38;">self</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">in_dim</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_dim</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #dfd84a;">super</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #7f6e38;">__init__</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">A</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Parameter</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">empty</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">in_dim</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">))</span></p>
<p>        <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">init</span><span>.</span><span style="color: #6b97e8;">kaiming_uniform_</span><span style="color: #e3e11d;">(</span><span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">A</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">a</span><span>=</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">sqrt</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">tensor</span><span style="color: #e3e11d;">(</span><span style="color: #a09e19;">5.</span><span style="color: #e3e11d;">))</span><span>.</span><span style="color: #6b97e8;">item</span><span style="color: #e3e11d;">())</span>  <span style="color: #7f6e38;"># similar to standard weight initialization</span></p>
<p>        <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">B</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Parameter</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">zeros</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">out_dim</span><span style="color: #e3e11d;">))</span></p>
<p>        <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">alpha</span> <span>=</span> <span style="color: #6b97e8;">alpha</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">forward</span><span style="color: #e3e11d;">(</span><span style="color: #7f6e38;">self</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">x</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #6b97e8;">x</span> <span>=</span> <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">alpha</span> <span>*</span> <span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">x</span> <span>@</span> <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">A</span> <span>@</span> <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">B</span><span style="color: #e3e11d;">)</span></p>
<p>        <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">x</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, criamos uma classe linear com LoRA.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como antes, ele herda do <code><b>torch.nn.Module</b></code> para que possa atuar como uma camada de uma rede neural.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No método <code><b>_init_</b></code>, criamos uma variável com a camada linear original da rede e criamos outra variável com a nova camada LoRA que implementamos anteriormente.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No método <code><b>forward</b></code>, adicionamos as saídas da camada linear original e da camada LoRA.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">class</span> <span style="color: #7f6e38;">LoRALinear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Module</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">__init__</span><span style="color: #e3e11d;">(</span><span style="color: #7f6e38;">self</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">linear</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #dfd84a;">super</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #7f6e38;">__init__</span><span style="color: #e3e11d;">()</span></p>
<p>        <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">linear</span> <span>=</span> <span style="color: #6b97e8;">linear</span></p>
<p>        <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">lora</span> <span>=</span> <span style="color: #6b97e8;">LoRALayer</span><span style="color: #e3e11d;">(</span></p>
<p>            <span style="color: #6b97e8;">linear</span><span>.</span><span style="color: #6b97e8;">in_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">linear</span><span>.</span><span style="color: #6b97e8;">out_features</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span></p>
<p>        <span style="color: #e3e11d;">)</span></p>
<p></p>
<p>    <span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">forward</span><span style="color: #e3e11d;">(</span><span style="color: #7f6e38;">self</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">x</span><span style="color: #e3e11d;">):</span></p>
<p>        <span style="color: #a04cc1;">return</span> <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">linear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">x</span><span style="color: #e3e11d;">)</span> <span>+</span> <span style="color: #7f6e38;">self</span><span>.</span><span style="color: #6b97e8;">lora</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">x</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por fim, criamos uma função que substitui as camadas lineares pela nova camada linear com LoRA que criamos. Se encontrar uma camada linear no modelo, ela a substituirá pela camada linear com LoRA; caso contrário, aplicará a função nas subcamadas da camada.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">replace_linear_with_lora</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">name</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">module</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">named_children</span><span style="color: #e3e11d;">():</span></p>
<p>        <span style="color: #a04cc1;">if</span> <span style="color: #dfd84a;">isinstance</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">module</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">nn</span><span>.</span><span style="color: #6b97e8;">Linear</span><span style="color: #e3e11d;">):</span></p>
<p>            <span style="color: #7f6e38;"># Replace the Linear layer with LinearWithLoRA</span></p>
<p>            <span style="color: #dfd84a;">setattr</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">name</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">LoRALinear</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">module</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">))</span></p>
<p>        <span style="color: #a04cc1;">else</span><span style="color: #e3e11d;">:</span></p>
<p>            <span style="color: #7f6e38;"># Recursively apply the same function to child modules</span></p>
<p>            <span style="color: #6b97e8;">replace_linear_with_lora</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">module</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao modelo para substituir as camadas lineares do modelo pela nova camada linear com LoRA.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">rank</span> <span>=</span> <span style="color: #7e7a38;">16</span></p>
<p><span style="color: #6b97e8;">alpha</span> <span>=</span> <span style="color: #7e7a38;">16</span></p>
<p></p>
<p><span style="color: #6b97e8;">replace_linear_with_lora</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">rank</span><span>=</span><span style="color: #6b97e8;">rank</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">alpha</span><span>=</span><span style="color: #6b97e8;">alpha</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vemos o número de parâmetros treináveis</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">total_params</span> <span>=</span> <span style="color: #dfd84a;">sum</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">numel</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">for</span> <span style="color: #6b97e8;">p</span> <span style="color: #7f6e38;">in</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">parameters</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">p</span><span>.</span><span style="color: #6b97e8;">requires_grad</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Total trainable LoRA parameters: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">total_params</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">,</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Total trainable LoRA parameters: 12,368</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Passamos de 124 milhões de parâmetros treináveis para 12 mil parâmetros treináveis, ou seja, reduzimos o número de parâmetros treináveis em 10.000 vezes!</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Analisamos o modelo novamente</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): LoRALinear(</p><p>    (linear): Linear(in_features=768, out_features=5, bias=False)</p><p>    (lora): LoRALayer()</p><p>  )</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos compará-los camada por camada</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<table>
								<tr>
									<th>Modelo original</th>
									<th>Modelo com LoRA</th>
								</tr>
								<tr>
									<td>GPT2ForSequenceClassification(</td>
									<td>GPT2ForSequenceClassification(</td>
								</tr>
								<tr>
									<td>  (transformer): GPT2Model(</td>
									<td>  (transformer): GPT2Model(</td>
								</tr>
								<tr>
									<td>    (wte): Embedding(50257, 768)</td>
									<td>    (wte): Embedding(50257, 768)</td>
								</tr>
								<tr>
									<td>    (wpe): Embedding(1024, 768)</td>
									<td>    (wpe): Embedding(1024, 768)</td>
								</tr>
								<tr>
									<td>    (drop): Dropout(p=0.1, inplace=False)</td>
									<td>    (drop): Dropout(p=0.1, inplace=False)</td>
								</tr>
								<tr>
									<td>    (h): ModuleList(</td>
									<td>    (h): ModuleList(</td>
								</tr>
								<tr>
									<td>      (0-11): 12 x GPT2Block(</td>
									<td>      (0-11): 12 x GPT2Block(</td>
								</tr>
								<tr>
									<td>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
									<td>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
								</tr>
								<tr>
									<td>        (attn): GPT2Attention(</td>
									<td>        (attn): GPT2Attention(</td>
								</tr>
								<tr>
									<td>          (c_attn): Conv1D()</td>
									<td>          (c_attn): Conv1D()</td>
								</tr>
								<tr>
									<td>          (c_proj): Conv1D()</td>
									<td>          (c_proj): Conv1D()</td>
								</tr>
								<tr>
									<td>          (attn_dropout): Dropout(p=0.1, inplace=False)</td>
									<td>          (attn_dropout): Dropout(p=0.1, inplace=False)</td>
								</tr>
								<tr>
									<td>          (resid_dropout): Dropout(p=0.1, inplace=False)</td>
									<td>          (resid_dropout): Dropout(p=0.1, inplace=False)</td>
								</tr>
								<tr>
									<td>        )</td>
									<td>        )</td>
								</tr>
								<tr>
									<td>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
									<td>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
								</tr>
								<tr>
									<td>        (mlp): GPT2MLP(</td>
									<td>        (mlp): GPT2MLP(</td>
								</tr>
								<tr>
									<td>          (c_fc): Conv1D()</td>
									<td>          (c_fc): Conv1D()</td>
								</tr>
								<tr>
									<td>          (c_proj): Conv1D()</td>
									<td>          (c_proj): Conv1D()</td>
								</tr>
								<tr>
									<td>          (act): NewGELUActivation()</td>
									<td>          (act): NewGELUActivation()</td>
								</tr>
								<tr>
									<td>          (dropout): Dropout(p=0.1, inplace=False)</td>
									<td>          (dropout): Dropout(p=0.1, inplace=False)</td>
								</tr>
								<tr>
									<td>        )</td>
									<td>        )</td>
								</tr>
								<tr>
									<td>      )</td>
									<td>      )</td>
								</tr>
								<tr>
									<td>    )</td>
									<td>    )</td>
								</tr>
								<tr>
									<td>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
									<td>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</td>
								</tr>
								<tr>
									<td>  )</td>
									<td>  )</td>
								</tr>
								<tr>
									<td></td>
									<td>  (score): LoRALinear()</td>
								</tr>
								<tr>
									<td>  (score): Linear(in_features=768, out_features=5, bias=False)</td>
									<td>    (linear): Linear(in_features=768, out_features=5, bias=False)</td>
								</tr>
								<tr>
									<td></td>
									<td>    (lora): LoRALayer()</td>
								</tr>
								<tr>
									<td></td>
									<td>  )</td>
								</tr>
								<tr>
									<td>)</td>
									<td>)</td>
								</tr>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Podemos ver que eles são iguais, exceto no final, onde no modelo original havia uma camada linear normal e no modelo com LoRA há uma camada <code><b>LoRALinear</b></code> que tem a camada linear do modelo original e uma camada <code><b>LoRALayer</b></code> dentro.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento">
								<a class="anchor-link" href="#Treinamento">
									<p style="margin-left: 20px">Treinamento</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois que o modelo tiver sido instanciado com o LoRA, vamos treiná-lo como de costume.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como dissemos, na postagem <a href="https://maximofn.com/fine-tuning-sml/" target="_blank">Fine tuning SLMs</a>, usamos um tamanho de lote de 28 para o loop de treinamento e 40 para o loop de avaliação, mas agora que há menos parâmetros treináveis, podemos usar um tamanho de lote maior.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Por que isso acontece? Quando você treina um modelo, precisa salvar o modelo e seus gradientes na memória da GPU; portanto, tanto com o LoRA quanto sem o LoRA, você precisa salvar o modelo de qualquer maneira, mas no caso do LoRA, você salva apenas os gradientes de 12 mil parâmetros, enquanto com o LoRA você salva os gradientes de 128 milhões de parâmetros; portanto, com o LoRA, você precisa de menos memória da GPU, o que permite usar um tamanho de lote maior.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">TrainingArguments</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;accuracy&quot;</span></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-LoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">LR</span> <span>=</span> <span style="color: #a09e19;">2e-5</span></p>
<p><span style="color: #6b97e8;">BS_TRAIN</span> <span>=</span> <span style="color: #7e7a38;">400</span></p>
<p><span style="color: #6b97e8;">BS_EVAL</span> <span>=</span> <span style="color: #7e7a38;">400</span></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">3</span></p>
<p><span style="color: #6b97e8;">WEIGHT_DECAY</span> <span>=</span> <span style="color: #a09e19;">0.01</span></p>
<p></p>
<p><span style="color: #6b97e8;">training_args</span> <span>=</span> <span style="color: #6b97e8;">TrainingArguments</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">save_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">learning_rate</span><span>=</span><span style="color: #6b97e8;">LR</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_train_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_TRAIN</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_eval_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_EVAL</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">num_train_epochs</span><span>=</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">weight_decay</span><span>=</span><span style="color: #6b97e8;">WEIGHT_DECAY</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lr_scheduler_type</span><span>=</span><span style="color: #7e7a34;">&quot;cosine&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">warmup_ratio</span> <span>=</span> <span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">fp16</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">load_best_model_at_end</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">metric_for_best_model</span><span>=</span><span style="color: #6b97e8;">metric_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">push_to_hub</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">logging_dir</span><span>=</span><span style="color: #7e7a34;">&quot;./runs&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">numpy</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">np</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">evaluate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">compute_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">eval_pred</span></p>
<p>    <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">np</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Trainer</span></p>
<p></p>
<p><span style="color: #6b97e8;">trainer</span> <span>=</span> <span style="color: #6b97e8;">Trainer</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">training_args</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">train_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">compute_metrics</span><span>=</span><span style="color: #6b97e8;">compute_metrics</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>TrainOutput(global_step=1500, training_loss=1.8345018310546874, metrics={'train_runtime': 2565.4667, 'train_samples_per_second': 233.876, 'train_steps_per_second': 0.585, 'total_flos': 2.352076406784e+17, 'train_loss': 1.8345018310546874, 'epoch': 3.0})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Avaliação">
								<a class="anchor-link" href="#Avaliação">
									<p style="margin-left: 20px">Avaliação</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de treinados, avaliamos o conjunto de dados de teste</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">evaluate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_test</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'eval_loss': 1.5203168392181396,</p><p> 'eval_accuracy': 0.3374,</p><p> 'eval_runtime': 19.3843,</p><p> 'eval_samples_per_second': 257.94,</p><p> 'eval_steps_per_second': 0.671,</p><p> 'epoch': 3.0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Publicar-o-modelo">
								<a class="anchor-link" href="#Publicar-o-modelo">
									<p style="margin-left: 20px">Publicar o modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora que temos nosso modelo treinado, podemos compartilhá-lo com o mundo, portanto, primeiro criamos um cartão de modelo.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">create_model_card</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E agora podemos publicá-lo. Como a primeira coisa que fizemos foi fazer login no hub da huggingface, poderemos fazer o upload para o nosso hub sem nenhum problema.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">push_to_hub</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Teste-de-modelo">
								<a class="anchor-link" href="#Teste-de-modelo">
									<p style="margin-left: 10px">Teste de modelo</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Limpamos o máximo possível</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">gc</span></p>
<p></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">clear_hardwares</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">clear_autocast_cache</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">ipc_collect</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">empty_cache</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">gc</span><span>.</span><span style="color: #6b97e8;">collect</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p></p>
<p><span style="color: #6b97e8;">clear_hardwares</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">clear_hardwares</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como fizemos o upload do modelo em nosso hub, podemos baixá-lo e usá-lo.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">user</span> <span>=</span> <span style="color: #7e7a34;">&quot;maximofn&quot;</span></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">/</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_name</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #6b97e8;">task</span> <span>=</span> <span style="color: #7e7a34;">&quot;text-classification&quot;</span></p>
<p><span style="color: #6b97e8;">classifier</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">task</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, se quisermos retornar a probabilidade de todas as classes, basta usar o classificador que acabamos de instanciar, com o parâmetro <code><b>top_k=None</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7f6e38;">None</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">labels</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_0', 'score': 0.8419149518013},</p><p> {'label': 'LABEL_1', 'score': 0.09386005252599716},</p><p> {'label': 'LABEL_3', 'score': 0.03624210134148598},</p><p> {'label': 'LABEL_2', 'score': 0.02049318142235279},</p><p> {'label': 'LABEL_4', 'score': 0.0074898069724440575}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se quisermos apenas a classe com a maior probabilidade, faremos o mesmo, mas com o parâmetro <code><b>top_k=1</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">label</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">label</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_0', 'score': 0.8419149518013}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E se quisermos n classes, faremos o mesmo, mas com o parâmetro <code><b>top_k=n</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">two_labels</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">two_labels</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_0', 'score': 0.8419149518013},</p><p> {'label': 'LABEL_1', 'score': 0.09386005252599716}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Também podemos testar o modelo com o Automodel e o AutoTokenizer.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">user</span> <span>=</span> <span style="color: #7e7a34;">&quot;maximofn&quot;</span></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">/</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_name</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #6b97e8;">num_classes</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">half</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokens</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">encode</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokens</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">logits</span> <span>=</span> <span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">logits</span></p>
<p><span style="color: #6b97e8;">lables</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">softmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dim</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">cpu</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">numpy</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">tolist</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">lables</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[0.003940582275390625,</p><p> 0.00266265869140625,</p><p> 0.013946533203125,</p><p> 0.1544189453125,</p><p> 0.8251953125]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se você quiser testar o modelo com mais detalhes, poderá vê-lo em <a href="https://huggingface.co/Maximofn/GPT2-small-LoRA-finetuned-amazon-reviews-en-classification" target="_blank">Maximofn/GPT2-small-LoRA-finetuned-amazon-reviews-en-classification</a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Implementação-de-LoRA-em-um-LLM-com-PEFT-da-Hugging-Face">
								<a class="anchor-link" href="#Implementação-de-LoRA-em-um-LLM-com-PEFT-da-Hugging-Face">
									<p style="margin-left: 10px">Implementação de LoRA em um LLM com PEFT da Hugging Face</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Podemos fazer o mesmo com a biblioteca <code><b>PEFT</b></code> da Hugging Face. Vamos dar uma olhada nela</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Faça-login-no-hub">
								<a class="anchor-link" href="#Faça-login-no-hub">
									<p style="margin-left: 20px">Faça login no hub</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Fazemos login para carregar o modelo no Hub</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_login</span></p>
<p><span style="color: #6b97e8;">notebook_login</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Conjunto-de-dados">
								<a class="anchor-link" href="#Conjunto-de-dados">
									<p style="margin-left: 20px">Conjunto de dados</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Baixamos novamente o conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mteb/amazon_reviews_multi&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;en&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 200000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um subconjunto para o caso de você querer testar o código com um conjunto de dados menor. No meu caso, usarei 100% do conjunto de dados.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">percentage</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para obter o número de classes, usamos <code><b>dataset['train']</b></code> e não <code><b>subset_dataset_train</b></code> porque, se o subconjunto for muito pequeno, talvez não haja exemplos com todas as classes possíveis do conjunto de dados original.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">unique</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>5</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para criar o campo <code><b>label</b></code> no conjunto de dados. O conjunto de dados baixado tem o campo <code><b>labels</b></code>, mas a biblioteca <code><b>transformers</b></code> precisa que o campo seja chamado <code><b>label</b></code> e não <code><b>labels</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">set_labels</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;labels&#39;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">]</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">example</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Tokeniser">
								<a class="anchor-link" href="#Tokeniser">
									<p style="margin-left: 20px">Tokeniser</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Instanciamos o tokenizador. Para evitar erros, atribuímos o token de fim de cadeia ao token de preenchimento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #7e7a34;">&quot;openai-community/gpt2&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">pad_token</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">eos_token</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para tokenizar o conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #7e7a38;">768</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados e removemos as colunas de que não precisamos.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Modelo">
								<a class="anchor-link" href="#Modelo">
									<p style="margin-left: 20px">Modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Instanciamos o modelo. Além disso, para evitar erros, atribuímos o token do final da string ao token de preenchimento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">pad_token_id</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">eos_token_id</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA-com-PEFT">
								<a class="anchor-link" href="#LoRA-com-PEFT">
									<p style="margin-left: 20px">LoRA com PEFT</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes de criar o modelo com o LoRA, vamos dar uma olhada em suas camadas</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como podemos ver, há apenas uma camada <code><b>Linear</b></code>, que é <code><b>score</b></code>, e é essa que vamos substituir.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Podemos criar uma configuração do LoRA com a biblioteca PEFT e, em seguida, aplicar o LoRA ao mapa.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TaskType</span></p>
<p></p>
<p><span style="color: #6b97e8;">peft_config</span> <span>=</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">r</span><span>=</span><span style="color: #7e7a38;">16</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_alpha</span><span>=</span><span style="color: #7e7a38;">32</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_dropout</span><span>=</span><span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">task_type</span><span>=</span><span style="color: #6b97e8;">TaskType</span><span>.</span><span style="color: #6b97e8;">SEQ_CLS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">target_modules</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;score&quot;</span><span style="color: #e3e11d;">],</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Com essa configuração, definimos uma classificação de 16 e um alfa de 32. Além disso, adicionamos um dropout de 0,1 às camadas lora. Temos de indicar a tarefa para a configuração do LoRA; nesse caso, é uma tarefa de classificação de sequência. Por fim, indicamos quais camadas queremos substituir, neste caso, a camada <code><b>score</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, aplicamos o LoRA ao modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">get_peft_model</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">get_peft_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">peft_config</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ver quantos parâmetros treináveis o modelo tem agora.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">print_trainable_parameters</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>trainable params: 12,368 || all params: 124,456,016 || trainable%: 0.0099</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtemos os mesmos parâmetros treináveis de antes</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento">
								<a class="anchor-link" href="#Treinamento">
									<p style="margin-left: 20px">Treinamento</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois que o modelo tiver sido instanciado com o LoRA, vamos treiná-lo como de costume.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">TrainingArguments</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;accuracy&quot;</span></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-PEFT-LoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">LR</span> <span>=</span> <span style="color: #a09e19;">2e-5</span></p>
<p><span style="color: #6b97e8;">BS_TRAIN</span> <span>=</span> <span style="color: #7e7a38;">400</span></p>
<p><span style="color: #6b97e8;">BS_EVAL</span> <span>=</span> <span style="color: #7e7a38;">400</span></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">3</span></p>
<p><span style="color: #6b97e8;">WEIGHT_DECAY</span> <span>=</span> <span style="color: #a09e19;">0.01</span></p>
<p></p>
<p><span style="color: #6b97e8;">training_args</span> <span>=</span> <span style="color: #6b97e8;">TrainingArguments</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">save_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">learning_rate</span><span>=</span><span style="color: #6b97e8;">LR</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_train_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_TRAIN</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_eval_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_EVAL</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">num_train_epochs</span><span>=</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">weight_decay</span><span>=</span><span style="color: #6b97e8;">WEIGHT_DECAY</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lr_scheduler_type</span><span>=</span><span style="color: #7e7a34;">&quot;cosine&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">warmup_ratio</span> <span>=</span> <span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">fp16</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">load_best_model_at_end</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">metric_for_best_model</span><span>=</span><span style="color: #6b97e8;">metric_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">push_to_hub</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">logging_dir</span><span>=</span><span style="color: #7e7a34;">&quot;./runs&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">numpy</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">np</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">evaluate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">compute_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">eval_pred</span></p>
<p>    <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">np</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Trainer</span></p>
<p></p>
<p><span style="color: #6b97e8;">trainer</span> <span>=</span> <span style="color: #6b97e8;">Trainer</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">training_args</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">train_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">compute_metrics</span><span>=</span><span style="color: #6b97e8;">compute_metrics</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>TrainOutput(global_step=1500, training_loss=1.751504597981771, metrics={'train_runtime': 2551.7753, 'train_samples_per_second': 235.13, 'train_steps_per_second': 0.588, 'total_flos': 2.352524525568e+17, 'train_loss': 1.751504597981771, 'epoch': 3.0})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Avaliação">
								<a class="anchor-link" href="#Avaliação">
									<p style="margin-left: 20px">Avaliação</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de treinados, avaliamos o conjunto de dados de teste</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">evaluate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_test</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'eval_loss': 1.4127237796783447,</p><p> 'eval_accuracy': 0.3862,</p><p> 'eval_runtime': 19.3275,</p><p> 'eval_samples_per_second': 258.699,</p><p> 'eval_steps_per_second': 0.673,</p><p> 'epoch': 3.0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Publicar-o-modelo">
								<a class="anchor-link" href="#Publicar-o-modelo">
									<p style="margin-left: 20px">Publicar o modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um cartão modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">create_model_card</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o publicamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">push_to_hub</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>CommitInfo(commit_url='https://huggingface.co/Maximofn/GPT2-small-PEFT-LoRA-finetuned-amazon-reviews-en-classification/commit/839066c2bde02689a6b3f5624ac25f89c4de217d', commit_message='End of training', commit_description='', oid='839066c2bde02689a6b3f5624ac25f89c4de217d', pr_url=None, pr_revision=None, pr_num=None)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Teste-do-modelo-treinado-com-PEFT">
								<a class="anchor-link" href="#Teste-do-modelo-treinado-com-PEFT">
									<p style="margin-left: 10px">Teste do modelo treinado com PEFT</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Limpamos o máximo possível</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">gc</span></p>
<p></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">clear_hardwares</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">clear_autocast_cache</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">ipc_collect</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">empty_cache</span><span style="color: #e3e11d;">()</span></p>
<p>    <span style="color: #6b97e8;">gc</span><span>.</span><span style="color: #6b97e8;">collect</span><span style="color: #e3e11d;">()</span></p>
<p></p>
<p></p>
<p><span style="color: #6b97e8;">clear_hardwares</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">clear_hardwares</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como fizemos o upload do modelo em nosso hub, podemos baixá-lo e usá-lo.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">pipeline</span></p>
<p></p>
<p><span style="color: #6b97e8;">user</span> <span>=</span> <span style="color: #7e7a34;">&quot;maximofn&quot;</span></p>
<p><span style="color: #6b97e8;">checkpoints</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">/</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_name</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #6b97e8;">task</span> <span>=</span> <span style="color: #7e7a34;">&quot;text-classification&quot;</span></p>
<p><span style="color: #6b97e8;">classifier</span> <span>=</span> <span style="color: #6b97e8;">pipeline</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">task</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">model</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">checkpoints</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, se quisermos retornar a probabilidade de todas as classes, basta usar o classificador que acabamos de instanciar, com o parâmetro <code><b>top_k=None</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7f6e38;">None</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">labels</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_1', 'score': 0.9979197382926941},</p><p> {'label': 'LABEL_0', 'score': 0.002080311067402363}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se quisermos apenas a classe com a maior probabilidade, faremos o mesmo, mas com o parâmetro <code><b>top_k=1</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">label</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">label</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_1', 'score': 0.9979197382926941}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E se quisermos n classes, faremos o mesmo, mas com o parâmetro <code><b>top_k=n</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">two_labels</span> <span>=</span> <span style="color: #6b97e8;">classifier</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">top_k</span><span>=</span><span style="color: #7e7a38;">2</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">two_labels</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[{'label': 'LABEL_1', 'score': 0.9979197382926941},</p><p> {'label': 'LABEL_0', 'score': 0.002080311067402363}]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se você quiser testar o modelo com mais detalhes, poderá vê-lo em <a href="https://huggingface.co/Maximofn/GPT2-small-PEFT-LoRA-finetuned-amazon-reviews-en-classification" target="_blank">Maximofn/GPT2-small-PEFT-LoRA-finetuned-amazon-reviews-en-classification</a></p>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>


