<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Actualización-de-pesos-en-una-red-neuronal-index">
									<a class="anchor-link" href="#Actualización-de-pesos-en-una-red-neuronal">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Actualización de pesos en una red neuronal</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="QLoRA-index">
									<a class="anchor-link" href="#QLoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">QLoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Cuantización-QLoRA-index">
									<a class="anchor-link" href="#Cuantización-QLoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Cuantización QLoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Cuantización-de-los-modelos-de-lenguaje-en-normal-float-4-(NF4)-index">
									<a class="anchor-link" href="#Cuantización-de-los-modelos-de-lenguaje-en-normal-float-4-(NF4)">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Cuantización de los modelos de lenguaje en normal float 4 (NF4)</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Doble-cuantización-index">
									<a class="anchor-link" href="#Doble-cuantización">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Doble cuantización</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Optimizadores-paginados-index">
									<a class="anchor-link" href="#Optimizadores-paginados">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Optimizadores paginados</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Fine-tuning-con-LoRA-index">
									<a class="anchor-link" href="#Fine-tuning-con-LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Fine tuning con LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Cómo-hacer-fine-tuning-de-un-modelo-cuantizado-con-QLoRA-index">
									<a class="anchor-link" href="#Cómo-hacer-fine-tuning-de-un-modelo-cuantizado-con-QLoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Cómo hacer fine tuning de un modelo cuantizado con QLoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Login-en-el-Hub-de-Hugging-Face-index">
									<a class="anchor-link" href="#Login-en-el-Hub-de-Hugging-Face">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Login en el Hub de Hugging Face</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Dataset-index">
									<a class="anchor-link" href="#Dataset">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Dataset</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Tokenizer-index">
									<a class="anchor-link" href="#Tokenizer">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Tokenizer</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Modelo-index">
									<a class="anchor-link" href="#Modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Cuantización-del-modelo-index">
									<a class="anchor-link" href="#Cuantización-del-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Cuantización del modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Training-index">
									<a class="anchor-link" href="#Training">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Training</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Evaluación-index">
									<a class="anchor-link" href="#Evaluación">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Evaluación</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Publicar-el-modelo-index">
									<a class="anchor-link" href="#Publicar-el-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Publicar el modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Probar-el-modelo-index">
									<a class="anchor-link" href="#Probar-el-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Probar el modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/2024-07-29-QLoRA.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="QLoRA:-Efficient-Finetuning-of-Quantized-LLMs">
								<a class="anchor-link" href="#QLoRA:-Efficient-Finetuning-of-Quantized-LLMs">
									<p style="margin-left: 0px">QLoRA: Efficient Finetuning of Quantized LLMs</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si bien <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> proporciona una manera de hacer fine tuning de modelos de lenguaje sin necesidad de GPUs con grandes VRAMs, en el paper de <a href="https://arxiv.org/abs/2305.14314" target="_blank">QLoRA</a> van más allá y proponen la manera de hacer fine tuning de modelo cuantizados, haciendo que se necesite aún menos memoria para hacer fine tuning de modelos de lenguaje.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 10px">LoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Actualización-de-pesos-en-una-red-neuronal">
								<a class="anchor-link" href="#Actualización-de-pesos-en-una-red-neuronal">
									<p style="margin-left: 20px">Actualización de pesos en una red neuronal</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para entender cómo funciona LoRA, primero tenemos que recordar qué ocurre cuando entrenamos un modelo. Volvamos a la parte más básica del deep learning, tenemos una capa densa de una red neuronal que se define como:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx + b</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Donde W es la matriz de pesos y b es el vector de sesgos.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para simplificar vamos a suponer que no hay sesgo, por lo que quedaría así</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Supongamos que para una entrada x queremos que tenga una salida ŷ</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Primero lo que hacemos es calcular la salida que obtenemos con nuestro valor actual de pesos W, es decir obtenemos el valor y</li>
									<li>A continuación calculamos el error que existe entre el valor de y que hemos obtenido y el valor que queríamos obtener ŷ. A ese error lo llamamos loss, y lo calculamos con alguna función matemática, ahora no importa cual</li>
									<li>Calculamos el gardiente (la derivada) del error loss con respecto a la matriz de pesos W, es decir ΔW = dloss/dW</li>
									<li>Actualizamos los pesos W restando a cada uno de sus valores el valor del gradiente multiplicado por un factor de aprendizaje α, es decir W = W - α·ΔW</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Los autores de LoRA lo que proponen es que la matriz de pesos W se puede descomponer en </p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">W ~ W + ΔW</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">De manera que congelando la matriz W y entrenando solo la matriz ΔW se puede obtener un modelo que se adapte a nuevos datos sin tener que reentrenar todo el modelo</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Pero podrás pensar que ΔW es una matriz de tamaño igual a W por lo que no se ha ganado nada, pero aquí los autores se basan en <code><b>Aghajanyan et al. (2020)</b></code>, un paper en el que demostraron que aunque los modelos de lenguaje son grandes y que sus parámetros son matrices con dimensiones muy grandes, para adaptarlos a nuevas tareas no es necesario cambiar todos los valores de las matrices, sino que cambiando unos pocos valores es suficiente, que en términos técnicos, se llama adaptación de bajo rango. De ahí el nombre de LoRA (Low Rank Adaptation)</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Hemos congelado el modelo y ahora queremos entrenar la matriz ΔW, supongamos que tanto W como ΔW son matrices de tamaño 20x10, por lo que tenemos 200 parámetros entrenables</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora supongamos que la matriz ΔW se puede descomponer en el producto de dos matrices A y B, es decir</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ΔW = A · B</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para que esta multiplicación se produzca los tamaños de las matrices A y B tienen que ser 20xn y 10x10 respectivamente. Supongamos que n=5, por lo que A sería de tamaño 20x5, es decir 100 parámetros, y B de tamaño 5x10, es decir 50 parámetros, por lo que tendríamos 100+50=150 parámetros entrenables. Ya tenemos menos parámetros entrenables que antes</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora supongamos que W en realidad es una matriz de tamaño 10.000x10.000, por lo que tendríamos 100.000.000 parámetros entrenables, pero si descomponemos ΔW en A y B con n=5, tendríamos una matriz de tamaño 10.000x5 y otra de tamaño 5x10.000, por lo que tendríamos 50.000 parámetros de una y otros 50.000 parámetros de otra, en total 100.000 parámetros entrenables, es decir hemos reducido el número de parámetros 1000 veces</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ya puedes ir viendo el poder de LoRA, cuando se tienen modelos muy grandes, el número de parámetros entrenables se puede reducir muchísimo</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Si volvemos a ver la imagen de la arquitectura de LoRA, la entenderemos mejor</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/LoRA_adapat.webp" alt="LoRA adapt"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Pero se ve mejor aun, el ahorro en número de parámetros entrenables con esta imagen</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/Lora_matmul.webp" alt="LoRA matmul"></p></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="QLoRA">
								<a class="anchor-link" href="#QLoRA">
									<p style="margin-left: 10px">QLoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">QLoRA se realiza en dos pasos, la primera consiste en cuantizar el moelo y la segunda en aplicar LoRA al modelo cuantizado</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Cuantización-QLoRA">
								<a class="anchor-link" href="#Cuantización-QLoRA">
									<p style="margin-left: 20px">Cuantización QLoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">La cuantización de QLoRA se basa en tres conceptos, la cuantización del modelo a 4 bits con el formato normal float 4 (NF4), la doble cuantiazción y los optimizadores paginados. Todo ello junto hace que se pueda ahorrar mucha memoria al hacer fine tuning de los modelos de lenguaje, así que vamos a ver en qué consiste cada uno</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Cuantización-de-los-modelos-de-lenguaje-en-normal-float-4-(NF4)">
								<a class="anchor-link" href="#Cuantización-de-los-modelos-de-lenguaje-en-normal-float-4-(NF4)">
									<p style="margin-left: 30px">Cuantización de los modelos de lenguaje en normal float 4 (NF4)</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En QLoRA, para cuantizar, lo que se hace es cuantizar en formato normal float 4 (NF4), que es un tipo de cuantización a 4 bits de manera que sus datos tienen una distribución normal, es decir que siguen una campana de Gauss. Para conseguir que sigan esta distribución, lo que se hace es dividir los valores de los pesos en FP16 en quantiles, de manera que en cada quantil haya el mismo número de valores. Una vez tenemos los cuantiles, a cada cuantil se le asigna un valor en 4 bits</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/QLoRA-normal-float-quantization.webp" alt="QLoRA-normal-float-quantization"></p></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para realizar esta cuantización utiliza el algoritmo de cuantización SRAM, que es un algoritmo de cuantización por quantiles muy rápido, pero tiene mucho error con valores que están muy lejos en la distribución de la campana de Gauss, valores atípicos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como normalmente los parámetros de los pesos de una red neuronal suelen seguir una distribución normal (es decir que siguen una campana de Gauss), centrada en cero y con una desviación estandar σ. Lo que se hace es normalizarlos para que tengan una desviación estandar entre -1 y 1, y después se cuantizan en formato NF4</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Doble-cuantización">
								<a class="anchor-link" href="#Doble-cuantización">
									<p style="margin-left: 30px">Doble cuantización</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como hemos comentado, a la hora de cuantizar los parámetros de la red, tenemos que normalizarlos para que tengan una desviación estandar entre -1 y 1, y después cuantizarlos en formato NF4. Por lo que tenemos que guardar algunos parámetros como los valores para normalizar los parámetros, es decir, el valor por el que se dividen los datos para que tengan una desviación entre -1 y 1. Esos valores se almacenan en formato FP32, por lo que los autores del paper proponen cuantizar esos parámetros a formato FP8.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aunque esto puede parecer que no ahorra mucha memoria, los autores calculan que esto puede ahorrar unos 0.373 bits por parámetro, pero si por ejemplo tenemos un modelo de 8B de parámetros, que no es un modelo excesivamente grande a día de hoy, nos ahorraríamos unos 3 GB de memoria, que no está mal. En el caso de un modelo de 70B de parámetros, nos ahorraríamos unos 26 GB de memoria</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Optimizadores-paginados">
								<a class="anchor-link" href="#Optimizadores-paginados">
									<p style="margin-left: 30px">Optimizadores paginados</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Las GPUs de Nvidia tienen la opción de compartir la RAM de la GPU y de la CPU, de manera que lo que hacen es guardar los estados del optimizador en la RAM de la CPU y acceder a ellos cuando lo necesitan. Así no se tienen que guardar en la RAM de la GPU y podemos ahorrar memoria de la GPU</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Fine-tuning-con-LoRA">
								<a class="anchor-link" href="#Fine-tuning-con-LoRA">
									<p style="margin-left: 20px">Fine tuning con LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez hemos cuantizado el modelo ya podemos hacer fine tuning del modelo cuantizado igual que se hace en <a href="https://maximofn.com/lora/" target="_blank">LoRA</a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Cómo-hacer-fine-tuning-de-un-modelo-cuantizado-con-QLoRA">
								<a class="anchor-link" href="#Cómo-hacer-fine-tuning-de-un-modelo-cuantizado-con-QLoRA">
									<p style="margin-left: 10px">Cómo hacer fine tuning de un modelo cuantizado con QLoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ahora que hemos explicado QLoRA, vamos a ver un ejemplo de cómo hacer fine tuning a un modelo usando QLoRA</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Login-en-el-Hub-de-Hugging-Face">
								<a class="anchor-link" href="#Login-en-el-Hub-de-Hugging-Face">
									<p style="margin-left: 20px">Login en el Hub de Hugging Face</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero nos logeamos para poder subir el modelo entrenado al Hub</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_login</span></p>
<p><span style="color: #6b97e8;">notebook_login</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Dataset">
								<a class="anchor-link" href="#Dataset">
									<p style="margin-left: 20px">Dataset</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Descargamos el dataset que vamos a usar, que es un dataset de reviews de <a href="https://huggingface.co/datasets/mteb/amazon_reviews_multi" target="_blank">Amazon</a></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mteb/amazon_reviews_multi&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;en&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 200000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos un subset por si quieres probar el código con un dataset más pequeño. En mi caso usaré el 100% del dataset</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">percentage</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos una muestra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">random</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">randint</span></p>
<p></p>
<p><span style="color: #6b97e8;">idx</span> <span>=</span> <span style="color: #6b97e8;">randint</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">,</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0297000',</p><p> 'text': 'Not waterproof at all\n\nBought this after reading good reviews. But it’s not water proof at all. If my son has even a little accident in bed, it goes straight to mattress. I don’t see a point in having this. So I have to purchase another one.',</p><p> 'label': 0,</p><p> 'label_text': '0'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Obtenemos el número de clases, para obtener el número de clases usamos <code><b>dataset['train']</b></code> y no <code><b>subset_dataset_train</b></code> porque si el subset lo hamos muy pequeño es posible que no haya ejemplos con todas las posibles clases del dataset original</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">unique</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>5</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos una función para crear el campo <code><b>label</b></code> en el dataset. El dataset descargado tiene el campo <code><b>labels</b></code> pero la librería <code><b>transformers</b></code> necesita que el campo se llame <code><b>label</b></code> y no <code><b>labels</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">set_labels</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;labels&#39;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">]</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">example</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos la función al dataset</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Volvemos a ver una muestra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0297000',</p><p> 'text': 'Not waterproof at all\n\nBought this after reading good reviews. But it’s not water proof at all. If my son has even a little accident in bed, it goes straight to mattress. I don’t see a point in having this. So I have to purchase another one.',</p><p> 'label': 0,</p><p> 'label_text': '0',</p><p> 'labels': 0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Tokenizer">
								<a class="anchor-link" href="#Tokenizer">
									<p style="margin-left: 20px">Tokenizer</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Implementamos el tokenizador. Para que no nos de error, asignamos el token de end of string al token de padding</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #7e7a34;">&quot;openai-community/gpt2&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">pad_token</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">eos_token</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos una función para tokenizar el dataset</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #7e7a38;">768</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos la función al dataset y de paso eliminamos las columnas que no necesitamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Volvemos a ver una muestra, pero en este caso solo vemos las <code><b>keys</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">keys</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>dict_keys(['labels', 'input_ids', 'attention_mask'])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Modelo">
								<a class="anchor-link" href="#Modelo">
									<p style="margin-left: 20px">Modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Descargamos primero el modelo sin cuantizar</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">pad_token_id</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">eos_token_id</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos la memoria que ocupa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.48 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Pasamos el modelo a FP16 y volvemos a ver la memoria que ocupa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">half</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.24 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos la arquitectura del modelo antes de cuantizar</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Cuantización-del-modelo">
								<a class="anchor-link" href="#Cuantización-del-modelo">
									<p style="margin-left: 20px">Cuantización del modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para cuantizar el modelo primero tenemos que crear la configuración de cuantización, para ello usamos la librería <code><b>bitsandbytes</b></code>, si no la tienes instalada la puedes instalar con</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>pip install bitsandbytes<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primero comprobamos si la arquitectura de nuestra GPU permite el formato BF16, si no lo permite usaremos FP16</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A continuación creamos la configuración de cuantización, con <code><b>load_in_4bits=True</b></code> indicamos que cuantice a 4 bits, con <code><b>bnb_4bit_quant_type="nf4"</b></code> le indicamos que lo haga en formato NF4, con <code><b>bnb_4bit_use_double_quant=True</b></code> le indicamos que haga doble cuantización y con <code><b>bnb_4bit_compute_dtype=compute_dtype</b></code> le indicamos qué formato de datos tiene que usar cuando descuantice, que puede ser FP16 o BF16. </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">BitsAndBytesConfig</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #6b97e8;">compute_dtype</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">bfloat16</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_bf16_supported</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">float16</span></p>
<p></p>
<p><span style="color: #6b97e8;">bnb_config</span> <span>=</span> <span style="color: #6b97e8;">BitsAndBytesConfig</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">load_in_4bit</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_quant_type</span><span>=</span><span style="color: #7e7a34;">&quot;nf4&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_use_double_quant</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_compute_dtype</span><span>=</span><span style="color: #6b97e8;">compute_dtype</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Y ahora cuantizamos el modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">quantization_config</span><span>=</span><span style="color: #6b97e8;">bnb_config</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>`low_cpu_mem_usage` was None, now set to True since model is quantized.</p><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Volvemos a ver la memoria que ocupa ahora que lo hemos cuantizado</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.12 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que se ha reducido el tamaño del modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Volvemos a ver la arquitectura del modelo una vez cuantizado</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Linear4bit(in_features=768, out_features=2304, bias=True)</p><p>          (c_proj): Linear4bit(in_features=768, out_features=768, bias=True)</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Linear4bit(in_features=768, out_features=3072, bias=True)</p><p>          (c_proj): Linear4bit(in_features=3072, out_features=768, bias=True)</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que la arquitectura ha cambiado</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/QLoRA-model-vs-quantized-model_-scaled.webp" alt="QLoRA-model-vs-quantized-model"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ha modificado las capas <code><b>Conv1D</b></code> por capas <code><b>Linear4bits</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes de implementar LoRA, tenemos que configurar el modelo para entrenar en 4 bits</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">prepare_model_for_kbit_training</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">prepare_model_for_kbit_training</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos a ver si ha cambiado el tamaño del modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.20 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Ha aumentado la memoria, así que volvemos a ver la arquitectura del modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Linear4bit(in_features=768, out_features=2304, bias=True)</p><p>          (c_proj): Linear4bit(in_features=768, out_features=768, bias=True)</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Linear4bit(in_features=768, out_features=3072, bias=True)</p><p>          (c_proj): Linear4bit(in_features=3072, out_features=768, bias=True)</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">La arquitectura sigue siendo la misma, por lo que suponemos que el aumento de memoria es por alguna configuración extra para poder aplicar LoRA en 4 bits</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos una configuración de LoRA, pero a diferencia del post de <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> en el que solo configuramos en <code><b>target_modeules</b></code> la capa <code><b>scores</b></code>, ahora vamos a añadir también las capas <code><b>c_attn</b></code>, <code><b>c_proj</b></code> y <code><b>c_fc</b></code> ya que ahora son de tipo <code><b>Linear4bits</b></code> y no <code><b>Conv1D</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TaskType</span></p>
<p></p>
<p><span style="color: #6b97e8;">config</span> <span>=</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">r</span><span>=</span><span style="color: #7e7a38;">16</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_alpha</span><span>=</span><span style="color: #7e7a38;">32</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_dropout</span><span>=</span><span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">task_type</span><span>=</span><span style="color: #6b97e8;">TaskType</span><span>.</span><span style="color: #6b97e8;">SEQ_CLS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">target_modules</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;c_attn&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;c_fc&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;c_proj&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;score&#39;</span><span style="color: #e3e11d;">],</span></p>
<p>    <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7e7a34;">&quot;none&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">get_peft_model</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">get_peft_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">config</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">print_trainable_parameters</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>trainable params: 2,375,504 || all params: 126,831,520 || trainable%: 1.8730</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mientras que en el post de <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> teníamos unos 12.000 parámetros entrenables, ahora tenemos unos 2 millones, ya que ahora hemos añadido las capas <code><b>c_attn</b></code>, <code><b>c_proj</b></code> y <code><b>c_fc</b></code></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Training">
								<a class="anchor-link" href="#Training">
									<p style="margin-left: 20px">Training</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez instanciado el modelo cuantizado y aplicado LoRA, es decir, una vez hemos hecho QLoRA, vamos a entrenarlo como siempre</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">TrainingArguments</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;accuracy&quot;</span></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">LR</span> <span>=</span> <span style="color: #a09e19;">2e-5</span></p>
<p><span style="color: #6b97e8;">BS_TRAIN</span> <span>=</span> <span style="color: #7e7a38;">224</span></p>
<p><span style="color: #6b97e8;">BS_EVAL</span> <span>=</span> <span style="color: #7e7a38;">224</span></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">3</span></p>
<p><span style="color: #6b97e8;">WEIGHT_DECAY</span> <span>=</span> <span style="color: #a09e19;">0.01</span></p>
<p></p>
<p><span style="color: #6b97e8;">training_args</span> <span>=</span> <span style="color: #6b97e8;">TrainingArguments</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">save_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">learning_rate</span><span>=</span><span style="color: #6b97e8;">LR</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_train_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_TRAIN</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_eval_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_EVAL</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">num_train_epochs</span><span>=</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">weight_decay</span><span>=</span><span style="color: #6b97e8;">WEIGHT_DECAY</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lr_scheduler_type</span><span>=</span><span style="color: #7e7a34;">&quot;cosine&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">warmup_ratio</span> <span>=</span> <span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">fp16</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">load_best_model_at_end</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">metric_for_best_model</span><span>=</span><span style="color: #6b97e8;">metric_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">push_to_hub</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">logging_dir</span><span>=</span><span style="color: #7e7a34;">&quot;./runs&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">En el post <a href="https://maximofn.com/fine-tuning-sml/" target="_blank">Fine tuning SMLs</a> tuvimos que poner un BS de train de 28, en el post <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> al poner las matrices de bajo rango en las capas lineales hizo que pudiéramos poner un batch size de train de 400. Ahora, como al cuantizar el modelo, la librería PEFT ha convertido algunas capas más a <code><b>Linear</b></code> no podemos poner un batch size tan grande y lo tenemos que poner de 224</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">numpy</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">np</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">evaluate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">compute_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">eval_pred</span></p>
<p>    <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">np</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Trainer</span></p>
<p></p>
<p><span style="color: #6b97e8;">trainer</span> <span>=</span> <span style="color: #6b97e8;">Trainer</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">training_args</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">train_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">compute_metrics</span><span>=</span><span style="color: #6b97e8;">compute_metrics</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>TrainOutput(global_step=2679, training_loss=1.1650676093647934, metrics={'train_runtime': 11299.1288, 'train_samples_per_second': 53.101, 'train_steps_per_second': 0.237, 'total_flos': 2.417754341376e+17, 'train_loss': 1.1650676093647934, 'epoch': 3.0})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Evaluación">
								<a class="anchor-link" href="#Evaluación">
									<p style="margin-left: 20px">Evaluación</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Una vez entrenado evaluamos sobre el dataset de test</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">evaluate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_test</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'eval_loss': 0.8883273601531982,</p><p> 'eval_accuracy': 0.615,</p><p> 'eval_runtime': 28.5566,</p><p> 'eval_samples_per_second': 175.091,</p><p> 'eval_steps_per_second': 0.805,</p><p> 'epoch': 3.0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Publicar-el-modelo">
								<a class="anchor-link" href="#Publicar-el-modelo">
									<p style="margin-left: 20px">Publicar el modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Creamos una model card</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">create_model_card</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Lo publicamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">push_to_hub</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Probar-el-modelo">
								<a class="anchor-link" href="#Probar-el-modelo">
									<p style="margin-left: 20px">Probar el modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos aprobar el modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">user</span> <span>=</span> <span style="color: #7e7a34;">&quot;maximofn&quot;</span></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">/</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_name</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #7e7a38;">5</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">half</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>/home/sae00531/miniconda3/envs/nlp_/lib/python3.11/site-packages/huggingface_hub/file_download.py:1132: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.</p><p>  warnings.warn(</p><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p><p>/home/sae00531/miniconda3/envs/nlp_/lib/python3.11/site-packages/peft/tuners/lora/layer.py:1119: UserWarning: fan_in_fan_out is set to False but the target module is `Conv1D`. Setting fan_in_fan_out to True.</p><p>  warnings.warn(</p><p>Loading adapter weights from maximofn/GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification led to unexpected keys not found in the model:  ['score.modules_to_save.default.base_layer.weight', 'score.modules_to_save.default.lora_A.default.weight', 'score.modules_to_save.default.lora_B.default.weight', 'score.modules_to_save.default.modules_to_save.lora_A.default.weight', 'score.modules_to_save.default.modules_to_save.lora_B.default.weight', 'score.modules_to_save.default.original_module.lora_A.default.weight', 'score.modules_to_save.default.original_module.lora_B.default.weight']. </p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokens</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">encode</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokens</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">logits</span> <span>=</span> <span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">logits</span></p>
<p><span style="color: #6b97e8;">lables</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">softmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dim</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">cpu</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">numpy</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">tolist</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">lables</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[0.0186614990234375,</p><p> 0.483642578125,</p><p> 0.048187255859375,</p><p> 0.415283203125,</p><p> 0.03399658203125]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>

