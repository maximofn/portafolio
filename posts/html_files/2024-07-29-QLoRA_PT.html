<p>
	<!-- Custom stylesheet, it must be in the same directory as the html file -->
	<!-- Loading mathjax macro --><!-- Load mathjax --><!-- MathJax configuration -->
<p>
<style>
	/* Media query para pantallas grandes */
	@media screen and (min-width: 1000px) {
		.container {
			flex-wrap: nowrap;
			display: flex;
			justify-content: space-between;
			height: 100vh; /* altura del viewport */
		}
		
		.indice {
			width: 25%; /* Ancho del índice en pantallas grandes */
			border-right: 1px solid #ccc;
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
		
		.contenido {
			width: 70%; /* Ancho del contenido en pantallas grandes */
			max-height: calc(100vh - 40px); /* Ajustar según tus necesidades. Aquí estamos restando el doble del padding para mantener todo visible */
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto; /* desplazamiento vertical cuando sea necesario */
		}
	}
</style>
<!-- Open div notebook -->
<div id="notebook" class="border-box-sizing" tabindex="-1">
	<!-- Open div notebook container -->
	<div id="notebook-container" class="container">
		<!-- Open div indice -->
		<div class="indice">
			<!-- Open div index header -->
			<div class="cell border-box-sizing text_cell rendered">
				<h2 class="prompt input_prompt">
					<span style="
					color: var(--darkreader-text--heading-color, var(--darkreader-text--heading-2-color,
					var(--darkreader-text--headings-color)));
					font-family: var(--fontFamily); font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-color: var(--darkreader-text--darkreader-text--heading-color,
					var(--darkreader-text--darkreader-text--heading-2-color, var(--darkreader-text--darkreader-text--headings-color)));
					--darkreader-inline-bgcolor: transparent;"
					data-darkreader-inline-color="" data-darkreader-inline-bgcolor="">
						Índice
					</span>
					<a class="anchor-link" style="
					font-family: var(--fontFamily);
					font-size: var(--fontSize);
					font-style: var(--fontStyle, inherit);
					font-weight: var(--fontWeight);
					letter-spacing: var(--letterSpacing);
					text-transform: var(--textTransform);
					background-color: transparent;
					--darkreader-inline-bgcolor: transparent;"
					href="#Índice" data-darkreader-inline-bgcolor="">
					</a>
				</h2>
			<!-- Close div index header -->
			</div>
			<!-- Index body -->
			<div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Atualização-de-pesos-em-uma-rede-neural-index">
									<a class="anchor-link" href="#Atualização-de-pesos-em-uma-rede-neural">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Atualização de pesos em uma rede neural</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="QLoRA-index">
									<a class="anchor-link" href="#QLoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">QLoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Quantificação-de-QLoRA-index">
									<a class="anchor-link" href="#Quantificação-de-QLoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Quantificação de QLoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Quantificação-de-modelos-de-linguagem-em-normal-float-4-(NF4)-index">
									<a class="anchor-link" href="#Quantificação-de-modelos-de-linguagem-em-normal-float-4-(NF4)">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Quantificação de modelos de linguagem em normal float 4 (NF4)</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Quantização-dupla-index">
									<a class="anchor-link" href="#Quantização-dupla">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Quantização dupla</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h4 id="Otimizadores-paginados-index">
									<a class="anchor-link" href="#Otimizadores-paginados">
										<p style="margin-left: 80px; font-size: 12px; line-height: 1.5;">Otimizadores paginados</p>
									</a>
								</h4>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Ajuste-fino-com-LoRA-index">
									<a class="anchor-link" href="#Ajuste-fino-com-LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Ajuste fino com LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h2 id="Como-fazer-o-ajuste-fino-de-um-modelo-quantizado-com-QLoRA-index">
									<a class="anchor-link" href="#Como-fazer-o-ajuste-fino-de-um-modelo-quantizado-com-QLoRA">
										<p style="margin-left: 0px; font-size: 12px; line-height: 1.5;">Como fazer o ajuste fino de um modelo quantizado com QLoRA</p>
									</a>
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Faça-login-no-hub-do-Hugging-Face-index">
									<a class="anchor-link" href="#Faça-login-no-hub-do-Hugging-Face">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Faça login no hub do Hugging Face</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Conjunto-de-dados-index">
									<a class="anchor-link" href="#Conjunto-de-dados">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Conjunto de dados</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Tokenizer-index">
									<a class="anchor-link" href="#Tokenizer">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Tokenizer</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Modelo-index">
									<a class="anchor-link" href="#Modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Quantificação-do-modelo-index">
									<a class="anchor-link" href="#Quantificação-do-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Quantificação do modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="LoRA-index">
									<a class="anchor-link" href="#LoRA">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">LoRA</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Treinamento-index">
									<a class="anchor-link" href="#Treinamento">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Treinamento</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Avaliação-index">
									<a class="anchor-link" href="#Avaliação">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Avaliação</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Publicar-o-modelo-index">
									<a class="anchor-link" href="#Publicar-o-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Publicar o modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
				<!-- Open div header -->
				<div class="cell border-box-sizing text_cell rendered">
					<div class="prompt input_prompt">
						<div class="inner_cell">
							<div class="text_cell_render border-box-sizing rendered_html">
								<h3 id="Teste-o-modelo-index">
									<a class="anchor-link" href="#Teste-o-modelo">
										<p style="margin-left: 40px; font-size: 12px; line-height: 1.5;">Teste o modelo</p>
									</a>
								</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		<!-- Close div indice -->
		</div>
 
		<!-- Content -->
		<div class="contenido">
		<div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><a href="https://colab.research.google.com/github/maximofn/portafolio/blob/main/posts/notebooks_translated/2024-07-29-QLoRA_PT.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h1 id="QLoRA:-ajuste-fino-eficiente-de-LLMs-quantizados">
								<a class="anchor-link" href="#QLoRA:-ajuste-fino-eficiente-de-LLMs-quantizados">
									<p style="margin-left: 0px">QLoRA: ajuste fino eficiente de LLMs quantizados</p>
								</a>
							</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Este caderno foi traduzido automaticamente para torná-lo acessível a mais pessoas, por favor me avise se você vir algum erro de digitação..</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Embora <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> ofereça uma maneira de ajustar os modelos de linguagem sem a necessidade de GPUs com grandes VRAMs, no artigo <a href="https://arxiv.org/abs/2305.14314" target="_blank">QLoRA</a> eles vão além e propõem uma maneira de ajustar os modelos quantizados, tornando ainda menos necessária a memória para o ajuste fino dos modelos de linguagem.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 10px">LoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Atualização-de-pesos-em-uma-rede-neural">
								<a class="anchor-link" href="#Atualização-de-pesos-em-uma-rede-neural">
									<p style="margin-left: 20px">Atualização de pesos em uma rede neural</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para entender como o LoRA funciona, primeiro precisamos lembrar o que acontece quando treinamos um modelo. Vamos voltar à parte mais básica da aprendizagem profunda: temos uma camada densa de uma rede neural que é definida como:</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx + b</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Onde W é a matriz de pesos e b é o vetor de polarização.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para simplificar, vamos supor que não haja viés, de modo que ficaria assim</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">y = Wx</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Suponha que, para uma entrada x, queremos que ela tenha uma saída ŷ.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">
								<ul>
									<li>Primeiro, calculamos o resultado que obtemos com nosso valor atual de pesos W, ou seja, obtemos o valor y.</li>
									<li>Em seguida, calculamos o erro que existe entre o valor de y que obtivemos e o valor que queríamos obter ŷ. Chamamos esse erro de loss e o calculamos com alguma função matemática, não importa qual.</li>
									<li>Calculamos a derivada do erro loss com relação à matriz de peso W, ou seja, ΔW = dloss/dW.</li>
									<li>Atualizamos os pesos W subtraindo de cada um de seus valores o valor do gradiente multiplicado por um fator de aprendizado α, ou seja, W = W - α·ΔW.</li>
								</ul>
							</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">

						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O que os autores do LoRA propõem é que a matriz de peso W possa ser decomposta em</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">W ~ W + ΔW</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Portanto, ao congelar a matriz W e treinar somente a matriz ΔW, é possível obter um modelo que se ajusta aos novos dados sem precisar treinar novamente o modelo inteiro.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mas você pode pensar que ΔW é uma matriz de tamanho igual a W e, portanto, nada foi ganho, mas aqui os autores se baseiam em <code><b>Aghajanyan et al. (2020)</b></code>, um artigo no qual eles mostraram que, embora os modelos de linguagem sejam grandes e seus parâmetros sejam matrizes com dimensões muito grandes, para adaptá-los a novas tarefas não é necessário alterar todos os valores das matrizes, mas alterar alguns valores é suficiente, o que, em termos técnicos, é chamado de Low Rank Adaptation (LoRA). Daí o nome LoRA (Low Rank Adaptation).</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Congelamos o modelo e agora queremos treinar a matriz ΔW. Vamos supor que tanto W quanto ΔW sejam matrizes de tamanho 20x10, portanto, temos 200 parâmetros treináveis.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora, vamos supor que a matriz ΔW possa ser decomposta no produto de duas matrizes A e B, ou seja</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">ΔW = A · B</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para que essa multiplicação ocorra, os tamanhos das matrizes A e B devem ser 20xn e 10x10, respectivamente. Suponha que n=5, então A teria o tamanho de 20x5, ou seja, 100 parâmetros, e B o tamanho de 5x10, ou seja, 50 parâmetros, de modo que teríamos 100+50=150 parâmetros treináveis. Já temos menos parâmetros treináveis do que antes</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora vamos supor que W seja, na verdade, uma matriz de tamanho 10.000x10.000, de modo que teríamos 100.000.000 parâmetros treináveis, mas se decompusermos ΔW em A e B com n=5, teríamos uma matriz de tamanho 10.000x5 e outra de tamanho 5x10.000, de modo que teríamos 50.000 parâmetros de uma e outros 50.000 parâmetros da outra, em um total de 100.000 parâmetros treináveis, ou seja, reduzimos o número de parâmetros 1.000 vezes.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Você já pode ver o poder do LoRA: quando você tem modelos muito grandes, o número de parâmetros treináveis pode ser bastante reduzido.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Se olharmos novamente para a imagem da arquitetura do LoRA, entenderemos melhor.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/LoRA_adapat.webp" alt="LoRA adapt"></p></p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Mas a economia no número de parâmetros treináveis com essa imagem parece ainda melhor.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;"><p align="center"><img src="https://maximofn.com/wp-content/uploads/2024/07/Lora_matmul.webp" alt="LoRA matmul"></p></p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="QLoRA">
								<a class="anchor-link" href="#QLoRA">
									<p style="margin-left: 10px">QLoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">O QLoRA é realizado em duas etapas: a primeira é quantificar o modelo e a segunda é aplicar o LoRA ao modelo quantificado.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Quantificação-de-QLoRA">
								<a class="anchor-link" href="#Quantificação-de-QLoRA">
									<p style="margin-left: 20px">Quantificação de QLoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A quantização do QLoRA baseia-se em três conceitos: quantização do modelo de 4 bits com o formato normal float 4 (NF4), quantização dupla e otimizadores paginados. Tudo isso junto permite economizar muita memória ao fazer o ajuste fino dos modelos de linguagem, portanto, vamos ver em que consiste cada um deles.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Quantificação-de-modelos-de-linguagem-em-normal-float-4-(NF4)">
								<a class="anchor-link" href="#Quantificação-de-modelos-de-linguagem-em-normal-float-4-(NF4)">
									<p style="margin-left: 30px">Quantificação de modelos de linguagem em normal float 4 (NF4)</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">No QLoRA, para quantificar, o que se faz é quantificar no formato normal float 4 (NF4), que é um tipo de quantização de 4 bits para que seus dados tenham uma distribuição normal, ou seja, sigam um sino gaussiano. Para que eles sigam essa distribuição, o que se faz é dividir os valores dos pesos no FP16 em quantis, de modo que em cada quantil haja o mesmo número de valores. Quando tivermos os quantis, cada quantil receberá um valor em 4 bits</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">QLoRA-normal-float-quantization](https://maximofn.com/wp-content/uploads/2024/07/QLoRA-normal-float-quantization.webp)</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para realizar essa quantização, ele usa o algoritmo de quantização SRAM, que é um algoritmo de quantização de quantis muito rápido por quantis, mas apresenta muitos erros com valores que estão muito distantes na distribuição de sino gaussiana, outliers.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Como os parâmetros dos pesos de uma rede neural geralmente seguem uma distribuição normal (ou seja, seguem um sino gaussiano), centrados em zero e com um desvio padrão σ. Eles são normalizados para ter um desvio padrão entre -1 e 1 e, em seguida, quantizados no formato NF4.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Quantização-dupla">
								<a class="anchor-link" href="#Quantização-dupla">
									<p style="margin-left: 30px">Quantização dupla</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Conforme mencionado acima, ao quantificar os parâmetros de rede, precisamos normalizá-los para que tenham um desvio padrão entre -1 e 1 e, em seguida, quantificá-los no formato NF4. Portanto, precisamos armazenar alguns parâmetros como os valores para normalizar os parâmetros, ou seja, o valor pelo qual os dados são divididos para ter um desvio entre -1 e 1. Esses valores são armazenados no formato FP32, portanto, os autores do artigo propõem quantificar esses parâmetros no formato FP8.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Embora isso possa parecer não economizar muita memória, os autores estimam que isso pode economizar cerca de 0,373 bits por parâmetro, mas se, por exemplo, tivermos um modelo de 8B parâmetros, que não é um modelo excessivamente grande para os padrões atuais, economizaríamos cerca de 3 GB de memória, o que não é ruim. No caso de um modelo de 70B parâmetros, economizaríamos cerca de 26 GB de memória.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h4 id="Otimizadores-paginados">
								<a class="anchor-link" href="#Otimizadores-paginados">
									<p style="margin-left: 30px">Otimizadores paginados</p>
								</a>
							</h4>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">As GPUs da Nvidia têm a opção de compartilhar a RAM da GPU e da CPU, portanto, o que elas fazem é armazenar os estados do otimizador na RAM da CPU e acessá-los quando necessário. Assim, eles não precisam ser armazenados na RAM da GPU e podemos economizar memória da GPU.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Ajuste-fino-com-LoRA">
								<a class="anchor-link" href="#Ajuste-fino-com-LoRA">
									<p style="margin-left: 20px">Ajuste fino com LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de quantizar o modelo, podemos fazer o ajuste fino do modelo quantizado, como em [LoRA] (https://maximofn.com/lora/).</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h2 id="Como-fazer-o-ajuste-fino-de-um-modelo-quantizado-com-QLoRA">
								<a class="anchor-link" href="#Como-fazer-o-ajuste-fino-de-um-modelo-quantizado-com-QLoRA">
									<p style="margin-left: 10px">Como fazer o ajuste fino de um modelo quantizado com QLoRA</p>
								</a>
							</h2>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Agora que já explicamos o QLoRA, vamos ver um exemplo de como ajustar um modelo usando o QLoRA.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Faça-login-no-hub-do-Hugging-Face">
								<a class="anchor-link" href="#Faça-login-no-hub-do-Hugging-Face">
									<p style="margin-left: 20px">Faça login no hub do Hugging Face</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, fazemos login para carregar o modelo treinado no Hub.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">huggingface_hub</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">notebook_login</span></p>
<p><span style="color: #6b97e8;">notebook_login</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Conjunto-de-dados">
								<a class="anchor-link" href="#Conjunto-de-dados">
									<p style="margin-left: 20px">Conjunto de dados</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Baixamos o conjunto de dados que usaremos, que é um conjunto de dados de avaliações da <a href="https://huggingface.co/datasets/mteb/amazon_reviews_multi" target="_blank">Amazon</a></p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">datasets</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load_dataset</span></p>
<p></p>
<p><span style="color: #6b97e8;">dataset</span> <span>=</span> <span style="color: #6b97e8;">load_dataset</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;mteb/amazon_reviews_multi&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #7e7a34;">&quot;en&quot;</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">dataset</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>DatasetDict({</p><p>    train: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 200000</p><p>    })</p><p>    validation: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>    test: Dataset({</p><p>        features: ['id', 'text', 'label', 'label_text'],</p><p>        num_rows: 5000</p><p>    })</p><p>})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um subconjunto para o caso de você querer testar o código com um conjunto de dados menor. No meu caso, usarei 100% do conjunto de dados.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">percentage</span> <span>=</span> <span style="color: #7e7a38;">1</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;validation&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">select</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">range</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">int</span><span style="color: #e3e11d;">(</span><span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;test&#39;</span><span style="color: #e3e11d;">])</span> <span>*</span> <span style="color: #6b97e8;">percentage</span><span style="color: #e3e11d;">)))</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos uma amostra</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">random</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">randint</span></p>
<p></p>
<p><span style="color: #6b97e8;">idx</span> <span>=</span> <span style="color: #6b97e8;">randint</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">,</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0297000',</p><p> 'text': 'Not waterproof at all\n\nBought this after reading good reviews. But it’s not water proof at all. If my son has even a little accident in bed, it goes straight to mattress. I don’t see a point in having this. So I have to purchase another one.',</p><p> 'label': 0,</p><p> 'label_text': '0'}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para obter o número de classes, usamos <code><b>dataset['train']</b></code> e não <code><b>subset_dataset_train</b></code> porque, se o subconjunto for muito pequeno, talvez não haja exemplos com todas as classes possíveis do conjunto de dados original.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #dfd84a;">len</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">dataset</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;train&#39;</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">unique</span><span style="color: #e3e11d;">(</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">))</span></p>
<p><span style="color: #6b97e8;">num_classes</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>5</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para criar o campo <code><b>label</b></code> no conjunto de dados. O conjunto de dados baixado tem o campo <code><b>labels</b></code>, mas a biblioteca <code><b>transformers</b></code> precisa que o campo seja chamado <code><b>label</b></code> e não <code><b>labels</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">set_labels</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;labels&#39;</span><span style="color: #e3e11d;">]</span> <span>=</span> <span style="color: #6b97e8;">example</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">]</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">example</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">set_labels</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['id', 'text', 'label', 'label_text', 'labels'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aqui está um exemplo novamente</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'id': 'en_0297000',</p><p> 'text': 'Not waterproof at all\n\nBought this after reading good reviews. But it’s not water proof at all. If my son has even a little accident in bed, it goes straight to mattress. I don’t see a point in having this. So I have to purchase another one.',</p><p> 'label': 0,</p><p> 'label_text': '0',</p><p> 'labels': 0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Tokenizer">
								<a class="anchor-link" href="#Tokenizer">
									<p style="margin-left: 20px">Tokenizer</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Implementamos o tokenizador. Para evitar erros, atribuímos o token de fim de cadeia ao token de preenchimento.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span></p>
<p></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #7e7a34;">&quot;openai-community/gpt2&quot;</span></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">pad_token</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">eos_token</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma função para tokenizar o conjunto de dados</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">tokenize_function</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">examples</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a34;">&quot;text&quot;</span><span style="color: #e3e11d;">],</span> <span style="color: #6b97e8;">padding</span><span>=</span><span style="color: #7e7a34;">&quot;max_length&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">truncation</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">max_length</span><span>=</span><span style="color: #7e7a38;">768</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Aplicamos a função ao conjunto de dados e removemos as colunas de que não precisamos.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_train</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_validation</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p><span style="color: #6b97e8;">subset_dataset_test</span> <span>=</span> <span style="color: #6b97e8;">subset_dataset_test</span><span>.</span><span style="color: #6b97e8;">map</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokenize_function</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">batched</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">remove_columns</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;text&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;id&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;label_text&#39;</span><span style="color: #e3e11d;">])</span></p>
<p></p>
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">subset_dataset_test</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>(Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 200000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }),</p><p> Dataset({</p><p>     features: ['labels', 'input_ids', 'attention_mask'],</p><p>     num_rows: 5000</p><p> }))</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos uma amostra novamente, mas, nesse caso, vemos apenas as <code><b>chaves</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">[</span><span style="color: #6b97e8;">idx</span><span style="color: #e3e11d;">]</span><span>.</span><span style="color: #6b97e8;">keys</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>dict_keys(['labels', 'input_ids', 'attention_mask'])</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Modelo">
								<a class="anchor-link" href="#Modelo">
									<p style="margin-left: 20px">Modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, baixamos o modelo não quantizado</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">pad_token_id</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">config</span><span>.</span><span style="color: #6b97e8;">eos_token_id</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos a memória que ele ocupa</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.48 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Passamos o modelo para o FP16 e verificamos novamente a memória que ele ocupa.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">half</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.24 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Analisamos a arquitetura do modelo antes de quantificar.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Conv1D()</p><p>          (c_proj): Conv1D()</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Quantificação-do-modelo">
								<a class="anchor-link" href="#Quantificação-do-modelo">
									<p style="margin-left: 20px">Quantificação do modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Para quantificar o modelo, primeiro precisamos criar a configuração de quantização. Para isso, usamos a biblioteca <code><b>bitsandbytes</b></code>; se você não a tiver instalada, poderá fazê-lo com</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 80px;"><code>pip install bitsandbytes<br></code></p>
						</div>
					</div>
				</div>
			</div>
	
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Primeiro, verificamos se nossa arquitetura de GPU permite o formato BF16; se não permitir, usaremos o FP16.</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Em seguida, criamos a configuração de quantização, com <code><b>load_in_4bits=True</b></code> indicamos que ele quantiza em 4 bits, com <code><b>bnb_4bit_quant_type="nf4"</b></code> indicamos que ele faz isso no formato NF4, com <code><b>bnb_4bit_use_double_quant=True</b></code> dizemos a ele para fazer a quantização dupla e com <code><b>bnb_4bit_compute_dtype=compute_dtype</b></code> dizemos a ele qual formato de dados usar ao quantificar, que pode ser FP16 ou BF16. </p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">BitsAndBytesConfig</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #6b97e8;">compute_dtype</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">bfloat16</span> <span style="color: #a04cc1;">if</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">cuda</span><span>.</span><span style="color: #6b97e8;">is_bf16_supported</span><span style="color: #e3e11d;">()</span> <span style="color: #a04cc1;">else</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">float16</span></p>
<p></p>
<p><span style="color: #6b97e8;">bnb_config</span> <span>=</span> <span style="color: #6b97e8;">BitsAndBytesConfig</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">load_in_4bit</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_quant_type</span><span>=</span><span style="color: #7e7a34;">&quot;nf4&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_use_double_quant</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">bnb_4bit_compute_dtype</span><span>=</span><span style="color: #6b97e8;">compute_dtype</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">E agora quantificamos o modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">quantization_config</span><span>=</span><span style="color: #6b97e8;">bnb_config</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>`low_cpu_mem_usage` was None, now set to True since model is quantized.</p><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos examinar novamente o espaço ocupado pela memória, agora que já o quantificamos.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.12 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que o tamanho do modelo foi reduzido.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos examinar novamente a arquitetura do modelo depois que ele tiver sido quantificado.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Linear4bit(in_features=768, out_features=2304, bias=True)</p><p>          (c_proj): Linear4bit(in_features=768, out_features=768, bias=True)</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Linear4bit(in_features=768, out_features=3072, bias=True)</p><p>          (c_proj): Linear4bit(in_features=3072, out_features=768, bias=True)</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vemos que a arquitetura mudou</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">QLoRA-model-vs-quantized-model](https://maximofn.com/wp-content/uploads/2024/07/QLoRA-model-vs-quantized-model_-scaled.webp)</p>
						</div>
					</div>
				</div>
			</div>
	
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Alterou as camadas <code><b>Conv1D</b></code> para camadas <code><b>Linear4bits</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="LoRA">
								<a class="anchor-link" href="#LoRA">
									<p style="margin-left: 20px">LoRA</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Antes de implementar o LoRA, temos que configurar o modelo para treinar em 4 bits.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">prepare_model_for_kbit_training</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">prepare_model_for_kbit_training</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos ver se o tamanho do modelo foi alterado.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model_memory</span> <span>=</span> <span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">get_memory_footprint</span><span style="color: #e3e11d;">()</span><span>/</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a38;">1024</span><span>**</span><span style="color: #7e7a38;">3</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;Model memory: </span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_memory</span><span style="color: #3b75c2;">:</span><span style="color: #7e7a34;">.2f</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;"> GB&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>Model memory: 0.20 GB</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A memória aumentou, portanto, examinamos novamente a arquitetura do modelo.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>GPT2ForSequenceClassification(</p><p>  (transformer): GPT2Model(</p><p>    (wte): Embedding(50257, 768)</p><p>    (wpe): Embedding(1024, 768)</p><p>    (drop): Dropout(p=0.1, inplace=False)</p><p>    (h): ModuleList(</p><p>      (0-11): 12 x GPT2Block(</p><p>        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (attn): GPT2Attention(</p><p>          (c_attn): Linear4bit(in_features=768, out_features=2304, bias=True)</p><p>          (c_proj): Linear4bit(in_features=768, out_features=768, bias=True)</p><p>          (attn_dropout): Dropout(p=0.1, inplace=False)</p><p>          (resid_dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>        (mlp): GPT2MLP(</p><p>          (c_fc): Linear4bit(in_features=768, out_features=3072, bias=True)</p><p>          (c_proj): Linear4bit(in_features=3072, out_features=768, bias=True)</p><p>          (act): NewGELUActivation()</p><p>          (dropout): Dropout(p=0.1, inplace=False)</p><p>        )</p><p>      )</p><p>    )</p><p>    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)</p><p>  )</p><p>  (score): Linear(in_features=768, out_features=5, bias=False)</p><p>)</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">A arquitetura permanece a mesma, portanto, presumimos que o aumento na memória é para alguma configuração extra para poder aplicar o LoRA em 4 bits</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos uma configuração do LoRA, mas, diferentemente da postagem <a href="https://maximofn.com/lora/" target="_blank">LoRA</a>, em que configuramos em <code><b>target_modeules</b></code> apenas a camada <code><b>scores</b></code>, agora também adicionaremos as camadas <code><b>c_attn</b></code>, <code><b>c_proj</b></code> e <code><b>c_fc</b></code>, pois agora elas são do tipo <code><b>Linear4bits</b></code> e não <code><b>Conv1D</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">TaskType</span></p>
<p></p>
<p><span style="color: #6b97e8;">config</span> <span>=</span> <span style="color: #6b97e8;">LoraConfig</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">r</span><span>=</span><span style="color: #7e7a38;">16</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_alpha</span><span>=</span><span style="color: #7e7a38;">32</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lora_dropout</span><span>=</span><span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">task_type</span><span>=</span><span style="color: #6b97e8;">TaskType</span><span>.</span><span style="color: #6b97e8;">SEQ_CLS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">target_modules</span><span>=</span><span style="color: #e3e11d;">[</span><span style="color: #8d783e;">&#39;c_attn&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;c_fc&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;c_proj&#39;</span><span style="color: #e3e11d;">,</span> <span style="color: #8d783e;">&#39;score&#39;</span><span style="color: #e3e11d;">],</span></p>
<p>    <span style="color: #6b97e8;">bias</span><span>=</span><span style="color: #7e7a34;">&quot;none&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">peft</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">get_peft_model</span></p>
<p></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">get_peft_model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">config</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">print_trainable_parameters</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>trainable params: 2,375,504 || all params: 126,831,520 || trainable%: 1.8730</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Enquanto na postagem <a href="https://maximofn.com/lora/" target="_blank">LoRA</a> tínhamos cerca de 12.000 parâmetros treináveis, agora temos cerca de 2 milhões, pois adicionamos as camadas <code><b>c_attn</b></code>, <code><b>c_proj</b></code> e <code><b>c_fc</b></code>.</p>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Treinamento">
								<a class="anchor-link" href="#Treinamento">
									<p style="margin-left: 20px">Treinamento</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de instanciar o modelo quantizado e aplicar o LoRA, ou seja, depois de fazer o QLoRA, vamos treiná-lo como de costume.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">TrainingArguments</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;accuracy&quot;</span></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">LR</span> <span>=</span> <span style="color: #a09e19;">2e-5</span></p>
<p><span style="color: #6b97e8;">BS_TRAIN</span> <span>=</span> <span style="color: #7e7a38;">224</span></p>
<p><span style="color: #6b97e8;">BS_EVAL</span> <span>=</span> <span style="color: #7e7a38;">224</span></p>
<p><span style="color: #6b97e8;">EPOCHS</span> <span>=</span> <span style="color: #7e7a38;">3</span></p>
<p><span style="color: #6b97e8;">WEIGHT_DECAY</span> <span>=</span> <span style="color: #a09e19;">0.01</span></p>
<p></p>
<p><span style="color: #6b97e8;">training_args</span> <span>=</span> <span style="color: #6b97e8;">TrainingArguments</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">save_strategy</span><span>=</span><span style="color: #7e7a34;">&quot;epoch&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">learning_rate</span><span>=</span><span style="color: #6b97e8;">LR</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_train_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_TRAIN</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">per_device_eval_batch_size</span><span>=</span><span style="color: #6b97e8;">BS_EVAL</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">num_train_epochs</span><span>=</span><span style="color: #6b97e8;">EPOCHS</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">weight_decay</span><span>=</span><span style="color: #6b97e8;">WEIGHT_DECAY</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">lr_scheduler_type</span><span>=</span><span style="color: #7e7a34;">&quot;cosine&quot;</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">warmup_ratio</span> <span>=</span> <span style="color: #a09e19;">0.1</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">fp16</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">load_best_model_at_end</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">metric_for_best_model</span><span>=</span><span style="color: #6b97e8;">metric_name</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">push_to_hub</span><span>=</span><span style="color: #7f6e38;">True</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">logging_dir</span><span>=</span><span style="color: #7e7a34;">&quot;./runs&quot;</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Na postagem [Fine tuning SMLs] (https://maximofn.com/fine-tuning-sml/), tivemos que colocar um tamanho de trem BS de 28; na postagem [LoRA] (https://maximofn.com/lora/), ao colocar as matrizes de baixa classificação nas camadas lineares, foi possível colocar um tamanho de lote de 400. Agora, como ao quantizar o modelo, a biblioteca PEFT converteu mais algumas camadas em <code><b>Linear</b></code>, não podemos colocar um tamanho de lote tão grande e temos que colocá-lo em 224.</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">numpy</span> <span style="color: #a04cc1;">as</span> <span style="color: #4fcd7d;">np</span></p>
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">evaluate</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">load</span></p>
<p></p>
<p><span style="color: #6b97e8;">metric</span> <span>=</span> <span style="color: #6b97e8;">load</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;accuracy&quot;</span><span style="color: #e3e11d;">)</span></p>
<p></p>
<p><span style="color: #a04cc1;">def</span> <span style="color: #7f6e38;">compute_metrics</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">):</span></p>
<p>    <span style="color: #dfd84a;">print</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_pred</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">labels</span> <span>=</span> <span style="color: #6b97e8;">eval_pred</span></p>
<p>    <span style="color: #6b97e8;">predictions</span> <span>=</span> <span style="color: #6b97e8;">np</span><span>.</span><span style="color: #6b97e8;">argmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">axis</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span></p>
<p>    <span style="color: #a04cc1;">return</span> <span style="color: #6b97e8;">metric</span><span>.</span><span style="color: #6b97e8;">compute</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">predictions</span><span>=</span><span style="color: #6b97e8;">predictions</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">references</span><span>=</span><span style="color: #6b97e8;">labels</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">Trainer</span></p>
<p></p>
<p><span style="color: #6b97e8;">trainer</span> <span>=</span> <span style="color: #6b97e8;">Trainer</span><span style="color: #e3e11d;">(</span></p>
<p>    <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">training_args</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">train_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_train</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_validation</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">tokenizer</span><span>=</span><span style="color: #6b97e8;">tokenizer</span><span style="color: #e3e11d;">,</span></p>
<p>    <span style="color: #6b97e8;">compute_metrics</span><span>=</span><span style="color: #6b97e8;">compute_metrics</span><span style="color: #e3e11d;">,</span></p>
<p><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">train</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>TrainOutput(global_step=2679, training_loss=1.1650676093647934, metrics={'train_runtime': 11299.1288, 'train_samples_per_second': 53.101, 'train_steps_per_second': 0.237, 'total_flos': 2.417754341376e+17, 'train_loss': 1.1650676093647934, 'epoch': 3.0})</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Avaliação">
								<a class="anchor-link" href="#Avaliação">
									<p style="margin-left: 20px">Avaliação</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Depois de treinados, avaliamos o conjunto de dados de teste</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">evaluate</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">eval_dataset</span><span>=</span><span style="color: #6b97e8;">subset_dataset_test</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>{'eval_loss': 0.8883273601531982,</p><p> 'eval_accuracy': 0.615,</p><p> 'eval_runtime': 28.5566,</p><p> 'eval_samples_per_second': 175.091,</p><p> 'eval_steps_per_second': 0.805,</p><p> 'epoch': 3.0}</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Publicar-o-modelo">
								<a class="anchor-link" href="#Publicar-o-modelo">
									<p style="margin-left: 20px">Publicar o modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Criamos um cartão modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">create_model_card</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Nós o publicamos</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">trainer</span><span>.</span><span style="color: #6b97e8;">push_to_hub</span><span style="color: #e3e11d;">()</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
			<!-- Open div header -->
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<h3 id="Teste-o-modelo">
								<a class="anchor-link" href="#Teste-o-modelo">
									<p style="margin-left: 20px">Teste o modelo</p>
								</a>
							</h3>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing text_cell rendered">
				<div class="prompt input_prompt">
					<div class="inner_cell">
						<div class="text_cell_render border-box-sizing rendered_html">
							<p style="margin-left: 0px;">Vamos aprovar o modelo</p>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #833aa0;">from</span> <span style="color: #4fcd7d;">transformers</span> <span style="color: #833aa0;">import</span> <span style="color: #6b97e8;">AutoTokenizer</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span></p>
<p><span style="color: #833aa0;">import</span> <span style="color: #4fcd7d;">torch</span></p>
<p></p>
<p><span style="color: #6b97e8;">model_name</span> <span>=</span> <span style="color: #7e7a34;">&quot;GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification&quot;</span></p>
<p><span style="color: #6b97e8;">user</span> <span>=</span> <span style="color: #7e7a34;">&quot;maximofn&quot;</span></p>
<p><span style="color: #6b97e8;">checkpoint</span> <span>=</span> <span style="color: #1b1477;">f</span><span style="color: #7e7a34;">&quot;</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">user</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">/</span><span style="color: #3b75c2;">{</span><span style="color: #6b97e8;">model_name</span><span style="color: #3b75c2;">}</span><span style="color: #7e7a34;">&quot;</span></p>
<p><span style="color: #6b97e8;">num_classes</span> <span>=</span> <span style="color: #7e7a38;">5</span></p>
<p></p>
<p><span style="color: #6b97e8;">tokenizer</span> <span>=</span> <span style="color: #6b97e8;">AutoTokenizer</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">model</span> <span>=</span> <span style="color: #6b97e8;">AutoModelForSequenceClassification</span><span>.</span><span style="color: #6b97e8;">from_pretrained</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">checkpoint</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">num_labels</span><span>=</span><span style="color: #6b97e8;">num_classes</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">half</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">eval</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;cuda&quot;</span><span style="color: #e3e11d;">)</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>/home/sae00531/miniconda3/envs/nlp_/lib/python3.11/site-packages/huggingface_hub/file_download.py:1132: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.</p><p>  warnings.warn(</p><p>Some weights of GPT2ForSequenceClassification were not initialized from the model checkpoint at openai-community/gpt2 and are newly initialized: ['score.weight']</p><p>You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.</p><p>/home/sae00531/miniconda3/envs/nlp_/lib/python3.11/site-packages/peft/tuners/lora/layer.py:1119: UserWarning: fan_in_fan_out is set to False but the target module is `Conv1D`. Setting fan_in_fan_out to True.</p><p>  warnings.warn(</p><p>Loading adapter weights from maximofn/GPT2-small-QLoRA-finetuned-amazon-reviews-en-classification led to unexpected keys not found in the model:  ['score.modules_to_save.default.base_layer.weight', 'score.modules_to_save.default.lora_A.default.weight', 'score.modules_to_save.default.lora_B.default.weight', 'score.modules_to_save.default.modules_to_save.lora_A.default.weight', 'score.modules_to_save.default.modules_to_save.lora_B.default.weight', 'score.modules_to_save.default.original_module.lora_A.default.weight', 'score.modules_to_save.default.original_module.lora_B.default.weight']. </p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="cell border-box-sizing code_cell rendered">
				<div class="input">
					<div class="prompt input_prompt" style="margin-left: 20px;">Code:</div>
					<div class="inner_cell">
						<div class="input_area">
							<div class=" highlight hl-python3">
								<pre class="python" style="margin-left: 40px; line-height: 0%;font-family:monospace;">
<p><span style="color: #6b97e8;">tokens</span> <span>=</span> <span style="color: #6b97e8;">tokenizer</span><span>.</span><span style="color: #6b97e8;">encode</span><span style="color: #e3e11d;">(</span><span style="color: #7e7a34;">&quot;I love this product&quot;</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">return_tensors</span><span>=</span><span style="color: #7e7a34;">&quot;pt&quot;</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">to</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">model</span><span>.</span><span style="color: #6b97e8;">device</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #a04cc1;">with</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">no_grad</span><span style="color: #e3e11d;">():</span></p>
<p>    <span style="color: #6b97e8;">output</span> <span>=</span> <span style="color: #6b97e8;">model</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">tokens</span><span style="color: #e3e11d;">)</span></p>
<p><span style="color: #6b97e8;">logits</span> <span>=</span> <span style="color: #6b97e8;">output</span><span>.</span><span style="color: #6b97e8;">logits</span></p>
<p><span style="color: #6b97e8;">lables</span> <span>=</span> <span style="color: #6b97e8;">torch</span><span>.</span><span style="color: #6b97e8;">softmax</span><span style="color: #e3e11d;">(</span><span style="color: #6b97e8;">logits</span><span style="color: #e3e11d;">,</span> <span style="color: #6b97e8;">dim</span><span>=</span><span style="color: #7e7a38;">1</span><span style="color: #e3e11d;">)</span><span>.</span><span style="color: #6b97e8;">cpu</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">numpy</span><span style="color: #e3e11d;">()</span><span>.</span><span style="color: #6b97e8;">tolist</span><span style="color: #e3e11d;">()</span></p>
<p><span style="color: #6b97e8;">lables</span><span style="color: #e3e11d;">[</span><span style="color: #7e7a38;">0</span><span style="color: #e3e11d;">]</span></p>
								</pre>
							</div>
						</div>
					</div>
				</div>
				<div class="output_wrapper">
					<div class="output">
						<div class="output_area">
							<div class="prompt" style="margin-left: 20px;">Output:</div>
							<div class="output_subarea output_stream output_stdout output_text">
								<pre style="margin-left: 60px; line-height: 0%;"><p>[0.0186614990234375,</p><p> 0.483642578125,</p><p> 0.048187255859375,</p><p> 0.415283203125,</p><p> 0.03399658203125]</p></pre>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!-- Close class contenido -->
	</div>
<!-- Close div notebook container -->
</div>
<!-- Close div notebook -->
</div>

