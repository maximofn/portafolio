<section class="section-block-markdown-cell">
<h1 id="FastRTC: The Real-Time Communication Library for Python">FastRTC: The Real-Time Communication Library for Python<a class="anchor-link" href="#FastRTC: The Real-Time Communication Library for Python">¬∂</a></h1>
</section>
<section class="section-block-markdown-cell">
<blockquote>
<p>Disclaimer: This post has been translated to English using a machine translation model. Please, let me know if you find any mistakes.</p>
</blockquote>
</section>
<section class="section-block-markdown-cell">
<p>In recent months, we have seen significant advancements in real-time voice models, with entire companies being founded around both open-source and closed models. Some key milestones include:</p>
<ul>
  <li><code>OpenAI</code> and <code>Google</code> launched their live multimodal APIs for ChatGPT and Gemini. OpenAI even launched a phone number <code>1-800-ChatGPT</code>!</li>
  <li><code>Kyutai</code> launched <a href="https://huggingface.co/kyutai">Moshi</a>, a fully open-source audio-to-audio LLM.</li>
  <li><code>Alibaba</code> launched <a href="https://huggingface.co/Qwen/Qwen2-Audio-7B-Instruct">Qwen2-Audio</a>, an open-source LLM that natively understands audio.</li>
  <li><code>Fixie.ai</code> launched <a href="https://huggingface.co/fixie-ai/ultravox-v0_5-llama-3_3-70b">Ultravox</a>, another open-source LLM that also natively understands audio.</li>
  <li><code>ElevenLabs</code> raised 180 million dollars in its Series C.</li>
</ul>
</section>
<section class="section-block-markdown-cell">
<p>Despite this explosion in models and funding, it remains difficult to build real-time AI applications that stream audio and video, especially in Python.</p>
<ul>
  <li>Machine learning engineers may not have experience with the necessary technologies to build real-time applications, such as <code>WebRTC</code>.</li>
  <li>Even code assistance tools like <code>Cursor</code> and <code>Copilot</code> struggle to write Python code that supports real-time audio/video applications.</li>
</ul>
<p>That's why the announcement of <code>FastRTC</code>, the real-time communication library for Python, is exciting. The library is designed to make it easy to build real-time audio and video AI applications entirely in Python!</p>
</section>
<section class="section-block-markdown-cell">
<h2 id="Main Features of FastRTC">Main Features of FastRTC<a class="anchor-link" href="#Main Features of FastRTC">¬∂</a></h2>
</section>
<section class="section-block-markdown-cell">
<ul>
  <li>üó£Ô∏è Automatic voice detection and built-in turn taking, so you only have to worry about the user response logic.</li>
  <li>üíª Automatic UI - Built-in Gradio UI enabled for WebRTC for testing (or deployment to production!).</li>
  <li>üìû Phone call - Use <code>fastphone()</code> to get a <strong>free</strong> phone number to call your audio stream (HF token required).</li>
  <li>‚ö°Ô∏è Support for <code>WebRTC</code> and <code>Websocket</code>.</li>
  <li>üí™ Customizable - You can mount the stream in any <code>FastAPI</code> application to serve a custom UI and deploy beyond <code>Gradio</code>.</li>
  <li>üß∞ Many utilities for <code>text-to-speech</code>, <code>speech-to-text</code>, <code>stop detection</code> to help you get started.</li>
</ul>
</section>
<section class="section-block-markdown-cell">
<h2 id="Installation">Installation<a class="anchor-link" href="#Installation">¬∂</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>To be able to use <code>FastRTC</code>, you first need to install the library:</p>
<div class='highlight'><pre><code class="language-bash">pip install fastrtc
</code></pre></div>
<p>But if we want to install the pause detection, speech-to-text, and text-to-speech functionalities, we need to install some additional dependencies:</p>
<div class='highlight'><pre><code class="language-bash">pip install "fastrtc[vad, stt, tts]"
</code></pre></div>
</section>
<section class="section-block-markdown-cell">
<h2 id="Getting Started">Getting Started<a class="anchor-link" href="#Getting Started">¬∂</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>We will start by building the <code>hello world</code> of real-time audio: echoing what the user says. In <code>FastRTC</code>, this is as simple as:</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">ReplyOnPause</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="w"> </span>
<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="k">yield</span> <span class="n">audio</span>
<span class="w"> </span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>
<span class="n">stream</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>* Running on local URL:  http://127.0.0.1:7872

To create a public link, set `share=True` in `launch()`.
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>&amp;lt;IPython.core.display.HTML object&amp;gt;
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>INFO:     127.0.0.1:58223 - &quot;GET / HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/index-C7PS0jJm.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/index-Bo0Yq5bb.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/svelte/svelte.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/Embed-FUIL71FR.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/Index-wMEhc4G9.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/StreamingBar-DOagx4HU.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/index-B1gfMDT9.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/IconButtonWrapper-EOzMzU45.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/StreamingBar.svelte_svelte_type_style_lang-CDNxkBIr.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/MarkdownCode-DPiWQnAx.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/DownloadLink-CqD3Uu0l.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/IconButtonWrapper.svelte_svelte_type_style_lang-BOpxTcdu.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/prism-python-qapVsvY8.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-BJ_RfjVB.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/MarkdownCode.svelte_svelte_type_style_lang-3tofWDHK.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/IconButton-B-aAVSzy.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Clear-By3xiIwg.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/context-TgWPFwN2.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/Button-BWSOH8Qq.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/Image-CsmDAdIf.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Blocks-E57YC_S0.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/Button-DTh9AgeE.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/Image-B8dFOee4.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/ImagePreview-DJhr8Mfv.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/file-url-DgijyRSD.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/Dropdown-CWxB-qJp.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/Example-D7K5RtQ2.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/Blocks-B5wxaDIo.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Dropdown-DjrBHETv.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/Block-DZqtZLFP.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/BlockTitle-BIcnzvtg.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/index-CvpmwOJi.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/MarkdownCode-DJM7o_VY.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/Info-DcCn6tHi.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/DropdownArrow-dYuMZY9s.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Toast-DdWZrg4w.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/utils-BsGrhMNe.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58230 - &quot;GET /assets/Index-ChJkSByh.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/Index-CfowPFmo.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-CptIZeFZ.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Index-Csm0OGa9.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /assets/Index-Cgj6KPvj.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58223 - &quot;GET /assets/Code-DGNrTu_I.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58225 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58228 - &quot;GET /assets/Index-HXWviefR.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58229 - &quot;GET /assets/Index-WEzAIkMk.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58230 - &quot;GET /assets/BlockLabel-DqHge3FF.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58227 - &quot;GET /assets/Index-CRGGsrTx.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58241 - &quot;GET / HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58241 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58241 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58244 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58260 - &quot;GET /static/fonts/ui-sans-serif/ui-sans-serif-Bold.woff2 HTTP/1.1&quot; 404 Not Found
INFO:     127.0.0.1:58260 - &quot;GET /static/fonts/system-ui/system-ui-Bold.woff2 HTTP/1.1&quot; 404 Not Found
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>When we go to the link that Gradio suggests, we first have to give permissions to the browser to access the microphone. Next, this will appear:</p>
<img src="https://pub-fb664c455eca46a2ba762a065ac900f7.r2.dev/fastRTC%20-%20hello%20world%20-%20init.webp" alt="fastrct - hello world - init">
</section>
<section class="section-block-markdown-cell">
<p>If we click on the tab to the right of the word <code>Record</code>, we can select the microphone we want to use.</p>
</section>
<section class="section-block-markdown-cell">
<p>When we press the <code>Record</code> button, everything we say will be repeated by the application. That is, it captures the audio, detects when we have stopped speaking, and repeats it.</p>
</section>
<section class="section-block-markdown-cell">
<p>Let's break it down:</p>
<ul>
  <li><code>ReplyOnPause</code> will handle voice detection and turn-taking for you. You only need to worry about the logic for responding to the user. You have to pass it the function that will manage the input audio. In our case, it's the <code>echo</code> function, which captures the input audio and returns it as a stream using <code>yield</code>, which many people don't know, but is a generator, meaning it's a Python method for creating iterators. If you want to learn more about <code>yield</code>, you can read my post on <a href="https://www.maximofn.com/python#6.5.-Generators">Python</a>. Any generator that returns an audio tuple (represented as <code>(sample_rate, audio_data)</code>) will work.* The <code>Stream</code> class will build a Gradio UI for you to quickly test your stream. Once you have finished prototyping, you can deploy your Stream as a production-ready FastAPI application in a single line of code.</li>
</ul>
</section>
<section class="section-block-markdown-cell">
<p>Here we can see an example from the creators of <code>FastRTC</code></p>
<video src="https://github.com/user-attachments/assets/fcf2d30e-3e98-47c9-8dc3-23340784c441" controls></video>
</section>
<section class="section-block-markdown-cell">
<h2 id="Leveling Up: Voice Chat with LLM">Leveling Up: Voice Chat with LLM<a class="anchor-link" href="#Leveling Up: Voice Chat with LLM">¬∂</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>The next level is to use an LLM to respond to the user. <code>FastRTC</code> comes with built-in <code>speech-to-text</code> and <code>text-to-speech</code> capabilities, so working with LLMs is really easy. Let's modify our <code>echo</code> function accordingly:</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplyOnPause</span><span class="p">,</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">get_stt_model</span><span class="p">,</span> <span class="n">get_tts_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gradio_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="w"> </span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;Maximofn/SmolLM2_localModel&quot;</span><span class="p">)</span>
<span class="n">stt_model</span> <span class="o">=</span> <span class="n">get_stt_model</span><span class="p">()</span>
<span class="n">tts_model</span> <span class="o">=</span> <span class="n">get_tts_model</span><span class="p">()</span>
<span class="w"> </span>
<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">):</span>
<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">stt_model</span><span class="o">.</span><span class="n">stt</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
<span class="w">    </span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
<span class="w">            </span><span class="n">message</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<span class="w">            </span><span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;You are a friendly Chatbot. Always reply in the language in which the user is writing to you.&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<span class="w">            </span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<span class="w">            </span><span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
<span class="w">            </span><span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;/chat&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>
<span class="w">    </span><span class="k">for</span> <span class="n">audio_chunk</span> <span class="ow">in</span> <span class="n">tts_model</span><span class="o">.</span><span class="n">stream_tts_sync</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
<span class="w">        </span><span class="k">yield</span> <span class="n">audio_chunk</span>
<span class="w"> </span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>
<span class="n">stream</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Loaded as API: https://maximofn-smollm2-localmodel.hf.space ‚úî
* Running on local URL:  http://127.0.0.1:7871

To create a public link, set `share=True` in `launch()`.
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>&amp;lt;IPython.core.display.HTML object&amp;gt;
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>INFO:     127.0.0.1:58224 - &quot;GET / HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/index-Bo0Yq5bb.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/index-C7PS0jJm.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/svelte/svelte.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-wMEhc4G9.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/StreamingBar-DOagx4HU.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/IconButtonWrapper-EOzMzU45.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/Embed-FUIL71FR.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/StreamingBar.svelte_svelte_type_style_lang-CDNxkBIr.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/index-B1gfMDT9.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/MarkdownCode-DPiWQnAx.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/MarkdownCode.svelte_svelte_type_style_lang-3tofWDHK.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/Index-BJ_RfjVB.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/DownloadLink-CqD3Uu0l.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/IconButtonWrapper.svelte_svelte_type_style_lang-BOpxTcdu.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/prism-python-qapVsvY8.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/IconButton-B-aAVSzy.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/Clear-By3xiIwg.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/context-TgWPFwN2.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/Blocks-E57YC_S0.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/Image-B8dFOee4.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/ImagePreview-DJhr8Mfv.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/Button-BWSOH8Qq.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/Button-DTh9AgeE.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/Dropdown-CWxB-qJp.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/Image-CsmDAdIf.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/Blocks-B5wxaDIo.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/Example-D7K5RtQ2.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/Block-DZqtZLFP.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/file-url-DgijyRSD.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/Info-DcCn6tHi.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/MarkdownCode-DJM7o_VY.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/Dropdown-DjrBHETv.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/index-CvpmwOJi.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/BlockTitle-BIcnzvtg.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/DropdownArrow-dYuMZY9s.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/Toast-DdWZrg4w.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/utils-BsGrhMNe.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/Index-CfowPFmo.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/Index-ChJkSByh.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /assets/Code-DGNrTu_I.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-Csm0OGa9.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /assets/Index-HXWviefR.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58231 - &quot;GET /assets/BlockLabel-DqHge3FF.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58224 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58231 - &quot;GET /assets/Index-Cgj6KPvj.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58233 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58226 - &quot;GET /assets/Index-CptIZeFZ.css HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58232 - &quot;GET /assets/Index-CRGGsrTx.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58234 - &quot;GET /assets/Index-WEzAIkMk.js HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58242 - &quot;GET / HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58242 - &quot;GET /theme.css?v=63194d3741d384f9f85db890247b6c0ef9e7abac0f297f40a15c59fe4baba916 HTTP/1.1&quot; 200 OK
INFO:     127.0.0.1:58242 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/style.css HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58243 - &quot;GET /gradio_api/custom_component/91a0d0cc3e6164063c775a057aff53510cb8fc04c8b99d010e09ce4ba9beb99d/client/component/index.js HTTP/1.1&quot; 304 Not Modified
INFO:     127.0.0.1:58250 - &quot;GET /static/fonts/ui-sans-serif/ui-sans-serif-Bold.woff2 HTTP/1.1&quot; 404 Not Found
INFO:     127.0.0.1:58250 - &quot;GET /static/fonts/system-ui/system-ui-Bold.woff2 HTTP/1.1&quot; 404 Not Found
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>As a <code>speech-to-text</code> model, use <code>Moonshine</code>, which supposedly only supports English, but I have tested it in Spanish and it understands well.</p>
</section>
<section class="section-block-markdown-cell">
<p>As a language model, we will use the model I deployed in a backend on Hugging Face and wrote about in the post <a href="https://www.maximofn.com/deploy-backend-with-llm-in-huggingface">Deploying a Backend with LLM on HuggingFace</a>. It uses the LLM <code>HuggingFaceTB/SmolLM2-1.7B-Instruct</code>, which is a small model since it's running on a backend with CPU, but it works quite well.</p>
</section>
<section class="section-block-markdown-cell">
<p>As a <code>text-to-speech</code> model, use <code>Kokoro</code>, which does have options to speak in other languages, but is not yet implemented in the <code>FastRTC</code> library.</p>
</section>
<section class="section-block-markdown-cell">
<p>If we are very interested in using <code>speech-to-speech</code> and <code>text-to-speech</code> models in other languages, we could implement them ourselves, because the greatest potential of <code>FastRTC</code> lies in the real-time communication layer, but I won't go into that now.</p>
</section>
<section class="section-block-markdown-cell">
<p>Now if we test the code we just wrote, we can have a voice chatbot in real time.</p>
</section>
<section class="section-block-markdown-cell">
<h2 id="Phone Call">Phone Call<a class="anchor-link" href="#Phone Call">¬∂</a></h2>
<p>If you call <code>stream.fastphone()</code> instead of <code>stream.ui.launch()</code>, you will get a free phone number to call your stream. Note that a Hugging Face token is required.</p>
<p>We generated a script because it doesn't always work in a Jupyter Notebook.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">fastrtc_phone_demo</span><span class="o">.</span><span class="n">py</span>
<span class="w"> </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastrtc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReplyOnPause</span><span class="p">,</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">get_stt_model</span><span class="p">,</span> <span class="n">get_tts_model</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gradio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gradio_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gradio.networking</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_tunnel</span> <span class="k">as</span> <span class="n">original_setup_tunnel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="w"> </span>
<span class="c1"># Monkey patch setup_tunnel para que acepte el par√°metro adicional</span>
<span class="k">def</span><span class="w"> </span><span class="nf">patched_setup_tunnel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">share_token</span><span class="p">,</span> <span class="n">share_server_address</span><span class="p">,</span> <span class="n">share_server_tls_certificate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="k">return</span> <span class="n">original_setup_tunnel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">share_token</span><span class="p">,</span> <span class="n">share_server_address</span><span class="p">,</span> <span class="n">share_server_tls_certificate</span><span class="p">)</span>
<span class="w"> </span>
<span class="c1"># Replace the original function with our patched version</span>
<span class="n">gradio</span><span class="o">.</span><span class="n">networking</span><span class="o">.</span><span class="n">setup_tunnel</span> <span class="o">=</span> <span class="n">patched_setup_tunnel</span>
<span class="w"> </span>
<span class="c1"># Get the token from the environment variable</span>
<span class="n">HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN&quot;</span><span class="p">)</span>
<span class="w"> </span>
<span class="c1"># Initialize the LLM client</span>
<span class="n">llm_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;Maximofn/SmolLM2_localModel&quot;</span><span class="p">)</span>
<span class="w"> </span>
<span class="c1"># Initialize the STT and TTS models</span>
<span class="n">stt_model</span> <span class="o">=</span> <span class="n">get_stt_model</span><span class="p">()</span>
<span class="n">tts_model</span> <span class="o">=</span> <span class="n">get_tts_model</span><span class="p">()</span>
<span class="w"> </span>
<span class="c1"># Define the echo function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">echo</span><span class="p">(</span><span class="n">audio</span><span class="p">):</span>
<span class="w">    </span><span class="c1"># Convert the audio to text</span>
<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">stt_model</span><span class="o">.</span><span class="n">stt</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1"># Generate the response</span>
<span class="w">    </span><span class="n">response</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
<span class="w">            </span><span class="n">message</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<span class="w">            </span><span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;You are a friendly Chatbot. Always reply in the language in which the user is writing to you.&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
<span class="w">            </span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<span class="w">            </span><span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
<span class="w">            </span><span class="n">api_name</span><span class="o">=</span><span class="s2">&quot;/chat&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Convert the response to audio</span>
<span class="w">    </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">response</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1"># Stream the audio</span>
<span class="w">    </span><span class="k">for</span> <span class="n">audio_chunk</span> <span class="ow">in</span> <span class="n">tts_model</span><span class="o">.</span><span class="n">stream_tts_sync</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
<span class="w">        </span><span class="k">yield</span> <span class="n">audio_chunk</span>
<span class="w"> </span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_free_port</span><span class="p">(</span><span class="n">start_port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">max_port</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the first free port starting from start_port.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for a free port starting from </span><span class="si">{</span><span class="n">start_port</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_port</span><span class="p">,</span> <span class="n">max_port</span><span class="p">):</span>
<span class="w">        </span><span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">connect_ex</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="w">            </span><span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If result != 0, the port is free</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free port found: </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span> <span class="n">port</span>
<span class="w">    </span><span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No free port found between </span><span class="si">{</span><span class="n">start_port</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="n">free_port</span> <span class="o">=</span> <span class="n">find_free_port</span><span class="p">()</span>    <span class="c1"># Search for a free port</span>
<span class="w"> </span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">Stream</span><span class="p">(</span><span class="n">ReplyOnPause</span><span class="p">(</span><span class="n">echo</span><span class="p">),</span> <span class="n">modality</span><span class="o">=</span><span class="s2">&quot;audio&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;send-receive&quot;</span><span class="p">)</span>
<span class="n">stream</span><span class="o">.</span><span class="n">fastphone</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">free_port</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>We explain the code</p>
</section>
<section class="section-block-markdown-cell">
<p>The part</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-python"># Monkey patch `setup_tunnel` to accept the additional parameter<br>def patched_setup_tunnel(host, port, share_token, share_server_address, share_server_tls_certificate=None):<br>return original_setup_tunnel(host, port, share_token, share_server_address, share_server_tls_certificate)<br><br># Replace the original function with our patched versiongradio.networking.setup_tunnel = patched_setup_tunnel</code></pre></div>
      </section>
<p>It is necessary because <code>FastRTC</code> is written for an older version of <code>gradio</code> that does not support the <code>share_server_address</code> parameter in the <code>setup_tunnel</code> method. So we patch it to accept the additional parameter.</p>
</section>
<section class="section-block-markdown-cell">
<p>As a Hugging Face token is required, we obtain it from the environment variable <code>HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN</code>.</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-python"># Get the token from the environment variable<br>HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN = os.getenv("HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN")</code></pre></div>
      </section>
</section>
<section class="section-block-markdown-cell">
<p>The language models, the <code>speech-to-text</code> model, and the <code>text-to-speech</code> model are created below, along with the <code>echo</code> function that will handle the input and output audio.</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-python"># Initialize the LLM client<br>llm_client = Client("Maximofn/SmolLM2_localModel")<br><br># Initialize the STT and TTS models<br>stt_model = get_stt_model()<br>tts_model = get_tts_model()<br><br># Define the echo function<br>def echo(audio):<br># Convert the audio to text<br>prompt = stt_model.stt(audio)<br><br># Generate the response<br>response = llm_client.predict(<br>message=prompt,<br>system_message="You are a friendly Chatbot. Always reply in the language in which the user is writing to you."max_tokens=512,<br>temperature=0.7,<br>top_p=0.95,<br>api_name="/chat"<br>)<br>&#x20;&#x20;<br># Convert the response to audio<br>prompt = response<br><br># Stream the audio<br>for audio_chunk in tts_model.stream_tts_sync(prompt):<br>yield audio_chunk</code></pre></div>
      </section>
</section>
<section class="section-block-markdown-cell">
<p>As we have used port <code>8000</code> before, in case it tells you that it is occupied, we create a function to find a free port and find one.</p>
<div class='highlight'><pre><code class="language-python">def find_free_port(start_port=8000, max_port=9000):
</code></pre></div>
<p>markdown</p>
<p>"Find the first free port starting from start_port."</p>
<div class='highlight'><pre><code>print(f"Searching for a free port starting from {start_port}...")
for port in range(start_port, max_port):
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
result = sock.connect_ex((&#39;127.0.0.1&#39;, port))
if result != 0:  # If result != 0, the port is free
print(f"Free port found: {port}")
return port
raise RuntimeError(f"No free port found between {start_port} and {max_port}")
    
free_port = find_free_port()    # Search for a free port
</code></pre></div>
</section>
<section class="section-block-markdown-cell">
<p>The stream is created and now <code>stream.fastphone()</code> is used to get a free phone number to call your stream, instead of <code>stream.ui.launch()</code> which we used before to create the graphical interface.</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-python">stream = Stream(ReplyOnPause(echo), modality="audio", mode="send-receive")<br>stream.fastphone(token=HUGGINGFACE_FASTRTC_PHONE_CALL_TOKEN, port=free_port)</code></pre></div>
      </section>
</section>
<section class="section-block-markdown-cell">
<p>If we run it, we will see something like this:</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">python</span> <span class="n">fastrtc_phone_demo</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Loaded as API: https://maximofn-smollm2-localmodel.hf.space ‚úî
INFO:	  Warming up STT model.
INFO:	  STT model warmed up.
INFO:	  Warming up VAD model.
INFO:	  VAD model warmed up.
Searching for a free port starting from 8000...
Free port found: 8004
INFO:     Started server process [24029]
INFO:     Waiting for application startup.
INFO:	  Visit https://fastrtc.org/userguide/api/ for WebRTC or Websocket API docs.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8004 (Press CTRL+C to quit)
INFO:	  Your FastPhone is now live! Call +1 877-713-4471 and use code 994514 to connect to your stream.
INFO:	  You have 30:00 minutes remaining in your quota (Resetting on 2025-04-07)
INFO:	  Visit https://fastrtc.org/userguide/audio/#telephone-integration for information on making your handler compatible with phone usage.
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>We see that it appears</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-bash">INFO:	Your FastPhone is now live! Call +1 877-713-4471 and use code 994514 to connect to your stream.<br>INFO:	You have 30:00 minutes remaining in your quota (Resetting on 2025-04-07)</code></pre></div>
      </section>
<p>That is, if we call the number <code>+1 877-713-4471</code> and use the code <code>994514</code>, it will connect us to our stream.</p>
</section>
<section class="section-block-markdown-cell">
<p>If we go to <a href="https://fastrtc.org/userguide/audio/#telephone-integration">Telephone Integration</a> in the <code>FastRTC</code> documentation, we will see that it uses <a href="https://www.twilio.com/">twilio</a> to make the call. It has an option to configure a local number from the United States, Dublin, Frankfurt, Tokyo, Singapore, Sydney, and S√£o Paulo.</p>
</section>
<section class="section-block-markdown-cell">
<p>I tried making the call from Spain (which is going to be quite expensive for me) and it works, but it's slow. I called, entered the code, and waited for the agent to connect, but since it was taking too long, I hung up.</p>
</section>