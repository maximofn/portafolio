<section class="section-block-markdown-cell">
<h1 id="Durabilidade do MCP">Durabilidade do MCP<a class="anchor-link" href="#Durabilidade do MCP">¶</a></h1>
</section>
<section class="section-block-markdown-cell">
<p>Nesta publicação, veremos como criar um servidor e um cliente MCP com a capacidade de o cliente solicitar uma tarefa de longa duração ao servidor, encerrar o cliente, a tarefa continuar sendo executada no servidor, reconectar o cliente e ver o status da tarefa.</p>
</section>
<section class="section-block-markdown-cell">
<h2 id="Servidor MCP com durabilidade">Servidor MCP com durabilidade<a class="anchor-link" href="#Servidor MCP com durabilidade">¶</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>O servidor será semelhante ao que criamos nas publicações <a href="https://www.maximofn.com/streamable-mcp">streamable MCP</a> e <a href="https://www.maximofn.com/resumable-mcp">resumable MCP</a>, com a diferença de que agora vamos adicionar a capacidade de o cliente solicitar uma tarefa de longa duração ao servidor, parar o cliente, a tarefa continuar sendo executada no servidor, reconectar o cliente e ver o status da tarefa.</p>
</section>
<section class="section-block-markdown-cell">
<p>Além disso, neste caso, vamos guardar as tarefas em um banco de dados SQLite para torná-lo mais profissional, já que nos posts anteriores guardávamos as informações em arquivos json.</p>
</section>
<section class="section-block-markdown-cell">
<h3 id="Implementacion del servidor MCP con durabilidad">Implementación del servidor MCP con durabilidad<a class="anchor-link" href="#Implementacion del servidor MCP con durabilidad">¶</a></h3>
</section>
<section class="section-block-markdown-cell">
<p>O servidor terá uma classe <code>DurableTaskManager</code> que irá gerenciar a criação das tarefas, armazená-las no banco de dados, relatar o status e poderá cancelá-las.</p>
</section>
<section class="section-block-markdown-cell">
<p>Você terá três recursos: para obter o status de uma tarefa, para listar todas as tarefas e para listar as tarefas por status.</p>
</section>
<section class="section-block-markdown-cell">
<p>E terá cinco ferramentas, três serão tarefas específicas (migração de dados, processamento de dados e treinamento de modelo), uma para cancelar uma tarefa e a última para obter as estatísticas do servidor.</p>
</section>
<section class="section-block-markdown-cell">
<h4 id="Criar ambiente virtual do servidor">Criar ambiente virtual do servidor<a class="anchor-link" href="#Criar ambiente virtual do servidor">¶</a></h4>
</section>
<section class="section-block-markdown-cell">
<p>Primeiro criamos a pasta onde vamos desenvolvê-lo.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="n">MCP_durability_server</span>
</pre></div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Criamos o ambiente com <code>uv</code></p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_server</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">init</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Initialized project `mcp-durability-server` at `/Users/macm1/Documents/web/portafolio/posts/MCP_durability_server`
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Iniciamos o ambiente</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_server</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">venv</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Using CPython 3.12.8
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Instalamos as bibliotecas necessárias</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_server</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">add</span> <span class="n">fastmcp</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Resolved 64 packages in 344ms                                        
Installed 61 packages in 136ms                                   ░░░░░░░░░░░░░░░░░░░░ [0/0] Installing wheels...                                 
 + annotated-types==0.7.0
 + anyio==4.10.0
 + attrs==25.3.0
 + authlib==1.6.3
 + certifi==2025.8.3
 + cffi==1.17.1
 + charset-normalizer==3.4.3
 + click==8.2.1
 + cryptography==45.0.6
 + cyclopts==3.23.0
 + dnspython==2.7.0
 + docstring-parser==0.17.0
 + docutils==0.22
 + email-validator==2.3.0
 + exceptiongroup==1.3.0
 + fastmcp==2.11.3
 + h11==0.16.0
 + httpcore==1.0.9
 + httpx==0.28.1
 + httpx-sse==0.4.1
 + idna==3.10
 + isodate==0.7.2
 + jsonschema==4.25.1
 + jsonschema-path==0.3.4
 + jsonschema-specifications==2025.4.1
 + lazy-object-proxy==1.12.0
 + markdown-it-py==4.0.0
 + markupsafe==3.0.2
 + mcp==1.13.1
 + mdurl==0.1.2
 + more-itertools==10.7.0
 + openapi-core==0.19.5
 + openapi-pydantic==0.5.1
 + openapi-schema-validator==0.6.3
 + openapi-spec-validator==0.7.2
 + parse==1.20.2
 + pathable==0.4.4
 + pycparser==2.22
 + pydantic==2.11.7
 + pydantic-core==2.33.2
 + pydantic-settings==2.10.1
 + pygments==2.19.2
 + pyperclip==1.9.0
 + python-dotenv==1.1.1
 + python-multipart==0.0.20
 + pyyaml==6.0.2
 + referencing==0.36.2
 + requests==2.32.5
 + rfc3339-validator==0.1.4
 + rich==14.1.0
 + rich-rst==1.3.1
 + rpds-py==0.27.1
 + six==1.17.0
 + sniffio==1.3.1
 + sse-starlette==3.0.2
 + starlette==0.47.3
 + typing-extensions==4.15.0
 + typing-inspection==0.4.1
 + urllib3==2.5.0
 + uvicorn==0.35.0
 + werkzeug==3.1.1
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<h4 id="Codigo do servidor">Código do servidor<a class="anchor-link" href="#Codigo do servidor">¶</a></h4>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">MCP_durability_server</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">py</span>
<span class="w"> </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MCP Durability Server</span>
<span class="w"> </span>
<span class="sd">MPC server that implements durability for long-running agents using Resource links.</span>
<span class="sd">Allows long-running operations to survive server restarts and provides state tracking</span>
<span class="sd">outside of band.</span>
<span class="w"> </span>
<span class="sd">Implemented pattern:</span>
<span class="sd">1. Tools return resource links immediately</span>
<span class="sd">2. Background processing continues asynchronously</span>
<span class="sd">3. Clients can poll or subscribe to resources for state updates</span>
<span class="w"> </span>
<span class="sd">Usage:</span>
<span class="sd">    python server.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="w"> </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="w"> </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp.server.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">Context</span>
<span class="w"> </span>

<span class="k">class</span><span class="w"> </span><span class="nc">TaskStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Long running task status.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
<span class="w">    </span><span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span> 
<span class="w">    </span><span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
<span class="w">    </span><span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
<span class="w">    </span><span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
<span class="w"> </span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TaskResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result data for a completed task.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="n">status</span><span class="p">:</span> <span class="n">TaskStatus</span>
<span class="w">    </span><span class="n">progress</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">    </span><span class="n">total</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="n">result_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">    </span><span class="n">updated_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="w">    </span><span class="n">completed_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w"> </span>

<span class="k">class</span><span class="w"> </span><span class="nc">DurableTaskManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages persistent task state and background execution.&quot;&quot;&quot;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mcp_tasks.db&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="n">db_path</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_background_tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_setup_database</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_setup_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes SQLite database for task persistence.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS tasks (</span>
<span class="s2">                task_id TEXT PRIMARY KEY,</span>
<span class="s2">                status TEXT NOT NULL,</span>
<span class="s2">                progress REAL DEFAULT 0.0,</span>
<span class="s2">                total REAL,</span>
<span class="s2">                message TEXT,</span>
<span class="s2">                result_data TEXT,</span>
<span class="s2">                error TEXT,</span>
<span class="s2">                created_at REAL NOT NULL,</span>
<span class="s2">                updated_at REAL NOT NULL,</span>
<span class="s2">                completed_at REAL</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new task and returns its ID.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_id</span><span class="p">:</span>
<span class="w">            </span><span class="n">task_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span><span class="n">task_result</span> <span class="o">=</span> <span class="n">TaskResult</span><span class="p">(</span>
<span class="w">            </span><span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span><span class="o">=</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
<span class="w">            </span><span class="n">updated_at</span><span class="o">=</span><span class="n">current_time</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_task</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="n">task_id</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_background_task</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span> 
<span class="w">        </span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<span class="w">        </span><span class="n">task_function</span><span class="p">,</span> 
<span class="w">        </span><span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Context</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts a background task and tracks its execution.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">():</span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_task_status</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1"># Execute the real task</span>
<span class="w">                </span><span class="k">if</span> <span class="n">context</span><span class="p">:</span>
<span class="w">                    </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_function</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_function</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1"># Mark as completed with results</span>
<span class="w">                </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_task_completion</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">            </span><span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_task_status</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">)</span>
<span class="w">                </span><span class="k">raise</span>
<span class="w">            </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_task_error</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="w">            </span><span class="k">finally</span><span class="p">:</span>
<span class="w">                </span><span class="c1"># Clean up background task reference</span>
<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_background_tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Start the task in the background</span>
<span class="w">        </span><span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">wrapper</span><span class="p">())</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_background_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_result</span><span class="p">:</span> <span class="n">TaskResult</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the task result to the database.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT OR REPLACE INTO tasks </span>
<span class="s2">            (task_id, status, progress, total, message, result_data, error, </span>
<span class="s2">             created_at, updated_at, completed_at)</span>
<span class="s2">            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<span class="w">            </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task_result</span><span class="o">.</span><span class="n">result_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">task_result</span><span class="o">.</span><span class="n">result_data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">completed_at</span>
<span class="w">        </span><span class="p">))</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the task result from the database.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
<span class="w">        </span><span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT task_id, status, progress, total, message, result_data, error,</span>
<span class="s2">                   created_at, updated_at, completed_at</span>
<span class="s2">            FROM tasks WHERE task_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">result_data</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># result_data</span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="n">result_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="w">            </span><span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<span class="w">                </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">return</span> <span class="n">TaskResult</span><span class="p">(</span>
<span class="w">            </span><span class="n">task_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">            </span><span class="n">status</span><span class="o">=</span><span class="n">TaskStatus</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="w">            </span><span class="n">progress</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="w">            </span><span class="n">total</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">            </span><span class="n">message</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="w">            </span><span class="n">result_data</span><span class="o">=</span><span class="n">result_data</span><span class="p">,</span>
<span class="w">            </span><span class="n">error</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
<span class="w">            </span><span class="n">created_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
<span class="w">            </span><span class="n">updated_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
<span class="w">            </span><span class="n">completed_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_task_progress</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span> 
<span class="w">        </span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<span class="w">        </span><span class="n">progress</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
<span class="w">        </span><span class="n">total</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="w">        </span><span class="n">message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the task progress.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">task_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_result</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">progress</span>
<span class="w">        </span><span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
<span class="w">        </span><span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="n">task_result</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_task</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_task_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the task status.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">task_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_result</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_task</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_task_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks the task as completed with results.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">task_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_result</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">COMPLETED</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">task_result</span><span class="o">.</span><span class="n">total</span> <span class="ow">or</span> <span class="mf">100.0</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">result_data</span> <span class="o">=</span> <span class="n">result_data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">}</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">completed_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_task</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_task_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Marks the task as failed with error.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">task_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_result</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">FAILED</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span>
<span class="w">        </span><span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_task</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancels a background task in execution.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background_tasks</span><span class="p">:</span>
<span class="w">            </span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
<span class="w">            </span><span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="w">            </span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_task_status</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">True</span>
<span class="w">        </span><span class="k">return</span> <span class="kc">False</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TaskStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">List</span><span class="p">[</span><span class="n">TaskResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists all tasks, optionally filtered by status.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
<span class="w">            </span><span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT task_id, status, progress, total, message, result_data, error,</span>
<span class="s2">                       created_at, updated_at, completed_at</span>
<span class="s2">                FROM tasks WHERE status = ? ORDER BY updated_at DESC</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status_filter</span><span class="o">.</span><span class="n">value</span><span class="p">,))</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT task_id, status, progress, total, message, result_data, error,</span>
<span class="s2">                       created_at, updated_at, completed_at</span>
<span class="s2">                FROM tasks ORDER BY updated_at DESC</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="w">        </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
<span class="w">            </span><span class="n">result_data</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">            </span><span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
<span class="w">                </span><span class="k">try</span><span class="p">:</span>
<span class="w">                    </span><span class="n">result_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="w">                </span><span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<span class="w">                    </span><span class="k">pass</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TaskResult</span><span class="p">(</span>
<span class="w">                </span><span class="n">task_id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                </span><span class="n">status</span><span class="o">=</span><span class="n">TaskStatus</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
<span class="w">                </span><span class="n">progress</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="w">                </span><span class="n">total</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">                </span><span class="n">message</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="w">                </span><span class="n">result_data</span><span class="o">=</span><span class="n">result_data</span><span class="p">,</span>
<span class="w">                </span><span class="n">error</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
<span class="w">                </span><span class="n">created_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
<span class="w">                </span><span class="n">updated_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
<span class="w">                </span><span class="n">completed_at</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="w">            </span><span class="p">))</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">return</span> <span class="n">tasks</span>
<span class="w"> </span>

<span class="c1"># Create the MCP server with durability capabilities</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;MCP Durability Server&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">instructions</span><span class="o">=</span><span class="s2">&quot;An MCP server that demonstrates durability for long-running agents&quot;</span>
<span class="p">)</span>
<span class="w"> </span>
<span class="c1"># Initialize the task manager</span>
<span class="n">task_manager</span> <span class="o">=</span> <span class="n">DurableTaskManager</span><span class="p">()</span>
<span class="w"> </span>

<span class="c1"># Resources to track the state of tasks</span>
<span class="nd">@server</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;task://status/</span><span class="si">{task_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_task_status</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the current status of a task by ID.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">task_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span> <span class="ow">not</span> <span class="n">task_result</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Task not found&quot;</span><span class="p">,</span> <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;result_data&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">result_data</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;completed_at&quot;</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">completed_at</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;task://list&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_all_tasks</span><span class="p">()</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lists all tasks with their current status.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">list_tasks</span><span class="p">()</span>
<span class="w">    </span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;completed_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">completed_at</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;has_result&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">result_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;has_error&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="w">            </span><span class="p">}</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;task://list/</span><span class="si">{status}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_tasks_by_status</span><span class="p">(</span><span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lists tasks filtered by status.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">try</span><span class="p">:</span>
<span class="w">        </span><span class="n">status_enum</span> <span class="o">=</span> <span class="n">TaskStatus</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="w">        </span><span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">list_tasks</span><span class="p">(</span><span class="n">status_enum</span><span class="p">)</span>
<span class="w">        </span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">progress</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;completed_at&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">completed_at</span>
<span class="w">                </span><span class="p">}</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="s2">&quot;status_filter&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="w">        </span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;valid_statuses&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">TaskStatus</span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w"> </span>

<span class="c1"># Tools to demonstrate durability functionality</span>
<span class="nd">@server</span><span class="o">.</span><span class="n">tool</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_data_migration</span><span class="p">(</span>
<span class="w">    </span><span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="w">    </span><span class="n">destination_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">record_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a long-running data migration task.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        source_path: Source path of the data</span>
<span class="sd">        destination_path: Destination path of the data  </span>
<span class="sd">        record_count: Number of records to migrate</span>
<span class="sd">        ctx: Contexto MCP</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Resource URI to track progress</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting migration of </span><span class="si">{</span><span class="n">record_count</span><span class="si">}</span><span class="s2"> records from </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">destination_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting migration of </span><span class="si">{</span><span class="n">record_count</span><span class="si">}</span><span class="s2"> records from </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">destination_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">migration_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">DurableTaskManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulated data migration task.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="w">        </span><span class="n">migrated</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span> <span class="n">batch_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">record_count</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
<span class="w">            </span><span class="c1"># Simulate batch processing</span>
<span class="w">            </span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Simulate work</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">batch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_start</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">record_count</span><span class="p">)</span>
<span class="w">            </span><span class="n">migrated</span> <span class="o">=</span> <span class="n">batch_end</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Update progress</span>
<span class="w">            </span><span class="n">progress_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">migrated</span> <span class="o">/</span> <span class="n">record_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Migrated </span><span class="si">{</span><span class="n">migrated</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">record_count</span><span class="si">}</span><span class="s2"> records&quot;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">update_task_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">progress_pct</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">report_progress</span><span class="p">(</span><span class="n">migrated</span><span class="p">,</span> <span class="n">record_count</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">                </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data migration completed: </span><span class="si">{</span><span class="n">migrated</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">            </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">return</span> <span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;migrated_records&quot;</span><span class="p">:</span> <span class="n">migrated</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;total_records&quot;</span><span class="p">:</span> <span class="n">record_count</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;source_path&quot;</span><span class="p">:</span> <span class="n">source_path</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;destination_path&quot;</span><span class="p">:</span> <span class="n">destination_path</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;completion_time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Create the task and start background processing</span>
<span class="w">    </span><span class="n">task_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">create_task</span><span class="p">()</span>
<span class="w">    </span><span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">start_background_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">migration_task</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">resource_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task://status/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data migration started. Track progress at: </span><span class="si">{</span><span class="n">resource_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span> <span class="n">resource_link</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">tool</span>  
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_batch_processing</span><span class="p">(</span>
<span class="w">    </span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="w">    </span><span class="n">total_items</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">processing_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a batch processing task.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        batch_size: Size of each batch</span>
<span class="sd">        total_items: Total number of items to process</span>
<span class="sd">        processing_delay: Delay per batch in seconds</span>
<span class="sd">        ctx: MCP context</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Resource URI to track progress</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting batch processing: </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2"> items in batches of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batch_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">DurableTaskManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch processing task.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_items</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
<span class="w">            </span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">processing_delay</span><span class="p">)</span>   <span class="c1"># Simulate work</span>
<span class="w">            </span><span class="n">batch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">total_items</span><span class="p">)</span>
<span class="w">            </span><span class="n">processed</span> <span class="o">=</span> <span class="n">batch_end</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">processed</span> <span class="o">/</span> <span class="n">total_items</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2"> items&quot;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">update_task_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">report_progress</span><span class="p">(</span><span class="n">processed</span><span class="p">,</span> <span class="n">total_items</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">                </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch processing completed: </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">            </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">return</span> <span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="n">processed</span><span class="p">,</span> 
<span class="w">            </span><span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_items</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;processing_delay&quot;</span><span class="p">:</span> <span class="n">processing_delay</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">task_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">create_task</span><span class="p">()</span>
<span class="w">    </span><span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">start_background_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">batch_task</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">resource_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task://status/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch processing started. Track progress at: </span><span class="si">{</span><span class="n">resource_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span> <span class="n">resource_link</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">tool</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_ml_training</span><span class="p">(</span>
<span class="w">    </span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="n">dataset_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
<span class="w">    </span><span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates machine learning model training.</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">        model_name: Name of the model to train</span>
<span class="sd">        dataset_size: Size of the dataset</span>
<span class="sd">        epochs: Number of training epochs</span>
<span class="sd">        ctx: MCP context</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Resource URI to track progress</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting training of model &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="n">dataset_size</span><span class="si">}</span><span class="s2"> samples by </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">training_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">DurableTaskManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulated ML training task.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="c1"># Simulate training of an epoch</span>
<span class="w">            </span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Simulate training metrics</span>
<span class="w">            </span><span class="n">loss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
<span class="w">            </span><span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">+</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.002</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> - Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">update_task_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">report_progress</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
<span class="w">            </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">                </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="k">await</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; training completed&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="w">            </span><span class="k">pass</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">return</span> <span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;dataset_size&quot;</span><span class="p">:</span> <span class="n">dataset_size</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;epochs_completed&quot;</span><span class="p">:</span> <span class="n">epochs</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;final_loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;final_accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;training_time_seconds&quot;</span><span class="p">:</span> <span class="n">epochs</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">task_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">create_task</span><span class="p">()</span>
<span class="w">    </span><span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">start_background_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">training_task</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">resource_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task://status/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training started. Track progress at: </span><span class="si">{</span><span class="n">resource_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span> <span class="n">resource_link</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">tool</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cancels an in-progress task.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        task_id: ID of the task to cancel</span>
<span class="sd">        ctx: MCP context</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Status message of the cancellation</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">cancel_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<span class="w">        </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> cancelled successfully&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> cancelled. Status available at: task://status/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">else</span><span class="p">:</span>
<span class="w">        </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> not found or cannot be cancelled&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> not found or cannot be cancelled&quot;</span>
<span class="w"> </span>

<span class="nd">@server</span><span class="o">.</span><span class="n">tool</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_server_stats</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets durability server statistics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ctx: MCP context</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Server statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">all_tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">list_tasks</span><span class="p">()</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;total_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_tasks</span><span class="p">),</span>
<span class="w">        </span><span class="s2">&quot;running_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">]),</span>
<span class="w">        </span><span class="s2">&quot;completed_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">]),</span>
<span class="w">        </span><span class="s2">&quot;failed_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">FAILED</span><span class="p">]),</span>
<span class="w">        </span><span class="s2">&quot;cancelled_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">]),</span>
<span class="w">        </span><span class="s2">&quot;pending_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">]),</span>
<span class="w">        </span><span class="s2">&quot;active_background_tasks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">_background_tasks</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server statistics: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_tasks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> total tasks, </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;running_tasks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> running&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span> <span class="n">stats</span>
<span class="w"> </span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Durability MCP server started&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available tools:&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - start_data_migration: Starts data migration&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - start_batch_processing: Starts batch processing&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - start_ml_training: Simulates ML training&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - cancel_task: Cancels a task&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - get_server_stats: Gets server statistics&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resources available:&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - task://status/</span><span class="si">{task_id}</span><span class="s2">: Specific task status&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - task://list: Lists all tasks&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - task://list/</span><span class="si">{status}</span><span class="s2">: Lists tasks by status&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Writing MCP_durability_server/server.py
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<h2 id="Cliente MCP com durabilidade">Cliente MCP com durabilidade<a class="anchor-link" href="#Cliente MCP com durabilidade">¶</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>O cliente será muito semelhante ao que criamos nas publicações <a href="https://www.maximofn.com/streamable-mcp">streamable MCP</a> e <a href="https://www.maximofn.com/resumable-mcp">resumable MCP</a>.</p>
</section>
<section class="section-block-markdown-cell">
<h3 id="Implementacao do cliente MCP com durabilidade">Implementação do cliente MCP com durabilidade<a class="anchor-link" href="#Implementacao do cliente MCP com durabilidade">¶</a></h3>
</section>
<section class="section-block-markdown-cell">
<p>Haverá uma classe <code>DurabilityClient</code> que terá métodos para se conectar ao servidor, iniciar as três tarefas possíveis (migração de dados, processamento de dados e treinamento de um modelo), obter o status de uma tarefa, obter uma lista de todas as tarefas ou cancelar uma tarefa.</p>
</section>
<section class="section-block-markdown-cell">
<h4 id="Criar um ambiente virtual do cliente">Criar um ambiente virtual do cliente<a class="anchor-link" href="#Criar um ambiente virtual do cliente">¶</a></h4>
</section>
<section class="section-block-markdown-cell">
<p>Primeiro criamos a pasta onde vamos desenvolvê-lo.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">mkdir</span> <span class="n">MCP_durability_client</span>
</pre></div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Criamos o ambiente com <code>uv</code></p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">init</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Initialized project `mcp-durability-client` at `/Users/macm1/Documents/web/portafolio/posts/MCP_durability_client`
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Iniciamos o ambiente</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">venv</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Using CPython 3.12.8
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Instalamos as bibliotecas necessárias</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">add</span> <span class="n">fastmcp</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Resolved 64 packages in 17ms                                         
Installed 61 packages in 80ms2                                   
 + annotated-types==0.7.0
 + anyio==4.10.0
 + attrs==25.3.0
 + authlib==1.6.3
 + certifi==2025.8.3
 + cffi==1.17.1
 + charset-normalizer==3.4.3
 + click==8.2.1
 + cryptography==45.0.6
 + cyclopts==3.23.0
 + dnspython==2.7.0
 + docstring-parser==0.17.0
 + docutils==0.22
 + email-validator==2.3.0
 + exceptiongroup==1.3.0
 + fastmcp==2.11.3
 + h11==0.16.0
 + httpcore==1.0.9
 + httpx==0.28.1
 + httpx-sse==0.4.1
 + idna==3.10
 + isodate==0.7.2
 + jsonschema==4.25.1
 + jsonschema-path==0.3.4
 + jsonschema-specifications==2025.4.1
 + lazy-object-proxy==1.12.0
 + markdown-it-py==4.0.0
 + markupsafe==3.0.2
 + mcp==1.13.1
 + mdurl==0.1.2
 + more-itertools==10.7.0
 + openapi-core==0.19.5
 + openapi-pydantic==0.5.1
 + openapi-schema-validator==0.6.3
 + openapi-spec-validator==0.7.2
 + parse==1.20.2
 + pathable==0.4.4
 + pycparser==2.22
 + pydantic==2.11.7
 + pydantic-core==2.33.2
 + pydantic-settings==2.10.1
 + pygments==2.19.2
 + pyperclip==1.9.0
 + python-dotenv==1.1.1
 + python-multipart==0.0.20
 + pyyaml==6.0.2
 + referencing==0.36.2
 + requests==2.32.5
 + rfc3339-validator==0.1.4
 + rich==14.1.0
 + rich-rst==1.3.1
 + rpds-py==0.27.1
 + six==1.17.0
 + sniffio==1.3.1
 + sse-starlette==3.0.2
 + starlette==0.47.3
 + typing-extensions==4.15.0
 + typing-inspection==0.4.1
 + urllib3==2.5.0
 + uvicorn==0.35.0
 + werkzeug==3.1.1
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<h4 id="Codigo do cliente">Código do cliente<a class="anchor-link" href="#Codigo do cliente">¶</a></h4>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="n">writefile</span> <span class="n">MCP_durability_client</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">py</span>
<span class="w"> </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Durability MCP client</span>
<span class="w"> </span>
<span class="sd">Client that demonstrates how to interact with an MCP server that implements durability.</span>
<span class="w"> </span>
<span class="sd">Shows how to:</span>
<span class="sd">1. Start long-running tasks</span>
<span class="sd">2. Monitor progress using resource polling</span>
<span class="sd">3. Subscribe to status updates (simulated)</span>
<span class="sd">4. Handle persistent tasks that survive server restarts</span>
<span class="w"> </span>

<span class="sd">Usage:</span>
<span class="sd">    python client.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="w"> </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="w"> </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp.client.transports</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamableHttpTransport</span>
<span class="w"> </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="w"> </span>

<span class="k">class</span><span class="w"> </span><span class="nc">DurabilityClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client that demonstrates durability patterns with MCP.&quot;&quot;&quot;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the durability client.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            server_command: Command to execute the MCP server</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">server_command</span> <span class="o">=</span> <span class="n">server_command</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">_polling_tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Client</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates and connects the client to the server.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">transport</span> <span class="o">=</span> <span class="n">StreamableHttpTransport</span><span class="p">(</span>
<span class="w">            </span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://127.0.0.1:8080/mcp&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="n">client</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_data_migration</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span> 
<span class="w">        </span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
<span class="w">        </span><span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/data/source&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">destination_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/data/destination&quot;</span><span class="p">,</span> 
<span class="w">        </span><span class="n">record_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a data migration task and returns the resource link.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            source_path: Source path</span>
<span class="sd">            destination_path: Destination path</span>
<span class="sd">            record_count: Number of records to migrate</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Resource URI to track progress</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 Starting data migration: </span><span class="si">{</span><span class="n">record_count</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Source: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Destination: </span><span class="si">{</span><span class="n">destination_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span>
<span class="w">            </span><span class="s2">&quot;start_data_migration&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;source_path&quot;</span><span class="p">:</span> <span class="n">source_path</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;destination_path&quot;</span><span class="p">:</span> <span class="n">destination_path</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;record_count&quot;</span><span class="p">:</span> <span class="n">record_count</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">resource_uri</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Task started. Resource URI: </span><span class="si">{</span><span class="n">resource_uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="n">resource_uri</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_batch_processing</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
<span class="w">        </span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<span class="w">        </span><span class="n">total_items</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
<span class="w">        </span><span class="n">processing_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts batch processing.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            batch_size: Batch size</span>
<span class="sd">            total_items: Total items</span>
<span class="sd">            processing_delay: Processing delay</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Resource URI to track progress</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔄 Starting batch processing:&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total items: </span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Processing delay: </span><span class="si">{</span><span class="n">processing_delay</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span>
<span class="w">            </span><span class="s2">&quot;start_batch_processing&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;total_items&quot;</span><span class="p">:</span> <span class="n">total_items</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;processing_delay&quot;</span><span class="p">:</span> <span class="n">processing_delay</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">resource_uri</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Batch processing started. Resource URI: </span><span class="si">{</span><span class="n">resource_uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="n">resource_uri</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_ml_training</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span>
<span class="w">        </span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clasificador-texto&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">dataset_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
<span class="w">        </span><span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts ML model training.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            model_name: Model name</span>
<span class="sd">            dataset_size: Dataset size</span>
<span class="sd">            epochs: Number of epochs</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Resource URI to track progress</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🤖 Starting ML training:&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Dataset size: </span><span class="si">{</span><span class="n">dataset_size</span><span class="si">}</span><span class="s2"> samples&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Epochs: </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span>
<span class="w">            </span><span class="s2">&quot;start_ml_training&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;dataset_size&quot;</span><span class="p">:</span> <span class="n">dataset_size</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="n">epochs</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">resource_uri</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ML training started. Resource URI: </span><span class="si">{</span><span class="n">resource_uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="n">resource_uri</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_task_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">resource_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the current status of a task.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            resource_uri: Resource URI of the task</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Current status of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_resource</span><span class="p">(</span><span class="n">resource_uri</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># result should be a list of ReadResourceContents  </span>
<span class="w">            </span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
<span class="w">                </span><span class="n">content_block</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1"># The content is in the &#39;text&#39; attribute</span>
<span class="w">                </span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;No text found in the resource. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content_block</span><span class="p">)</span><span class="si">}</span><span class="s2">, text=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty resource&quot;</span><span class="p">}</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error reading resource: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">poll_task_until_complete</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">,</span> 
<span class="w">        </span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> 
<span class="w">        </span><span class="n">resource_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="w">    </span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polls a task until it completes or fails.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            resource_uri: Resource URI of the task</span>
<span class="sd">            poll_interval: Interval between polls in seconds</span>
<span class="sd">            max_duration: Maximum duration of polling</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Final status of the task</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">task_id</span> <span class="o">=</span> <span class="n">resource_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📊 Monitoring task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="w">        </span><span class="n">last_progress</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">max_duration</span><span class="p">:</span>
<span class="w">            </span><span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_status</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">resource_uri</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting status: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span> <span class="n">status</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">current_status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="n">progress</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Show updates only if the progress changed</span>
<span class="w">            </span><span class="k">if</span> <span class="n">progress</span> <span class="o">!=</span> <span class="n">last_progress</span><span class="p">:</span>
<span class="w">                </span><span class="n">progress_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_progress_bar</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">progress_bar</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% | </span><span class="si">{</span><span class="n">current_status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="n">last_progress</span> <span class="o">=</span> <span class="n">progress</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># Check if the task is complete</span>
<span class="w">            </span><span class="k">if</span> <span class="n">current_status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">]:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">current_status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">if</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span> <span class="ow">and</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result_data&quot;</span><span class="p">):</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Results:&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="bp">self</span><span class="o">.</span><span class="n">_print_results</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&quot;result_data&quot;</span><span class="p">])</span>
<span class="w">                </span><span class="k">elif</span> <span class="n">current_status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="ow">and</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">return</span> <span class="n">status</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout for task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_status</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">resource_uri</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_create_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a visual progress bar.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">filled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">progress</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="w">        </span><span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;█&quot;</span> <span class="o">*</span> <span class="n">filled</span> <span class="o">+</span> <span class="s2">&quot;░&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">filled</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_print_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the results in a formatted way.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="n">spaces</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>
<span class="w">        </span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="w">            </span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spaces</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">_print_results</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spaces</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spaces</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_all_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists all tasks on the server.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_resource</span><span class="p">(</span><span class="s2">&quot;task://list&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># result should be a list of ReadResourceContents  </span>
<span class="w">            </span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
<span class="w">                </span><span class="n">content_block</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">                </span><span class="c1"># The content is in the &#39;text&#39; attribute</span>
<span class="w">                </span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;No text found in the resource. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content_block</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty resource&quot;</span><span class="p">}</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error reading task list: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_tasks_by_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists tasks filtered by status.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read_resource</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task://list/</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># result should be a list of ReadResourceContents  </span>
<span class="w">            </span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
<span class="w">                </span><span class="n">content_block</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">                </span><span class="c1"># The content is in the &#39;text&#39; attribute</span>
<span class="w">                </span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content_block</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content_block</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;No text found in the resource. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content_block</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty resource&quot;</span><span class="p">}</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error reading task list: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">print_task_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints a formatted list of all tasks.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Task list:&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_all_tasks</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">task_list</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">task_list</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">tasks</span> <span class="o">=</span> <span class="n">task_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   No tasks&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
<span class="w">            </span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">]</span>
<span class="w">            </span><span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="w">            </span><span class="n">progress</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">status</span><span class="si">:</span><span class="s2">9</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% | </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">select_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows a numbered list of tasks and allows the user to select one.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            client: MCP connected client</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The ID of the selected task, or None if no task was selected</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📋 Available tasks:&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">task_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_all_tasks</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">task_list</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ❌ </span><span class="si">{</span><span class="n">task_list</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">tasks</span> <span class="o">=</span> <span class="n">task_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="w">        </span><span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   No tasks available&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Show tasks with numbers</span>
<span class="w">        </span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">]</span>
<span class="w">            </span><span class="n">status</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="w">            </span><span class="n">progress</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">message</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. ID: </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">status</span><span class="si">:</span><span class="s2">9</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% | </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Ask user to select</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Select a task (1-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span><span class="si">}</span><span class="s2">) or press Enter to cancel: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span> <span class="ow">not</span> <span class="n">choice</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selection cancelled&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">                </span>
<span class="w">            </span><span class="n">choice_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span> <span class="mi">1</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="n">choice_num</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
<span class="w">                </span><span class="n">selected_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="n">choice_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<span class="w">                </span><span class="n">selected_id</span> <span class="o">=</span> <span class="n">selected_task</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">]</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Selected task: </span><span class="si">{</span><span class="n">selected_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span> <span class="n">selected_id</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Invalid selection. Please choose between 1 and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Invalid input. Please enter a number&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error selecting task: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="kc">None</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancels a specific task.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span><span class="s2">&quot;cancel_task&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
<span class="w">            </span><span class="n">response</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚫 </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="n">response</span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error canceling task: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span> <span class="n">error_msg</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_server_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets server statistics.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="k">try</span><span class="p">:</span>
<span class="w">            </span><span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">call_tool</span><span class="p">(</span><span class="s2">&quot;get_server_stats&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1"># result.content is a list of ContentBlock</span>
<span class="w">            </span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">:</span>
<span class="w">                </span><span class="n">content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">                </span><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">):</span>
<span class="w">                    </span><span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="c1"># If not text, it may be the object directly</span>
<span class="w">                    </span><span class="k">return</span> <span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Unexpected format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Empty response from get_server_stats&quot;</span><span class="p">}</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">            </span><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error getting server statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">print_server_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints server statistics.&quot;&quot;&quot;</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;📊 Server statistics:&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="n">stats</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_stats</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ❌ </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Total tasks: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Running: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;running_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Completed: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;completed_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Failed: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;failed_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Cancelled: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cancelled_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Pending: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pending_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Active background tasks: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_background_tasks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w"> </span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">interactive_demo</span><span class="p">(</span><span class="n">server_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interactive demo to explore the system.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🚀 Interactive Demo of the MCP Durability System&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">client_manager</span> <span class="o">=</span> <span class="n">DurabilityClient</span><span class="p">([])</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔗 Connected to the durability server&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available options:&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1. Start data migration&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2. Start batch processing&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3. Start ML training&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4. View server statistics&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;5. View task list&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;6. Monitor specific task&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;7. Cancel task&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;8. Exit&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">try</span><span class="p">:</span>
<span class="w">                </span><span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Select an option (1-8): &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="n">records</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Number of records to migrate (default 500): &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;500&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">uri</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">start_data_migration</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">record_count</span><span class="o">=</span><span class="n">records</span><span class="p">)</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Total elements (default 300): &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;300&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Batch size (default 30): &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;30&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">uri</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">start_batch_processing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">total_items</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="n">model_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Model name (default &#39;demo-model&#39;): &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;demo-model&quot;</span>
<span class="w">                    </span><span class="n">epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Number of epochs (default 25): &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;25&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="n">uri</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">start_ml_training</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task URI: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">print_server_stats</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">print_task_list</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="n">task_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">select_task</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span> <span class="n">task_id</span><span class="p">:</span>
<span class="w">                        </span><span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task://status/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">                        </span><span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">poll_task_until_complete</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;7&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="n">task_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">select_task</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span> <span class="n">task_id</span><span class="p">:</span>
<span class="w">                        </span><span class="k">await</span> <span class="n">client_manager</span><span class="o">.</span><span class="n">cancel_task</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;👋 Bye!&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="k">break</span>
<span class="w">                    </span>
<span class="w">                </span><span class="k">else</span><span class="p">:</span>
<span class="w">                    </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Invalid option. Please select 1-8.&quot;</span><span class="p">)</span>
<span class="w">                    </span>
<span class="w">            </span><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">👋 Demo interrupted. Bye!&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="k">break</span>
<span class="w">            </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">                </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w"> </span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="k">try</span><span class="p">:</span>
<span class="w">        </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">interactive_demo</span><span class="p">())</span>
<span class="w">    </span><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">👋 Bye!&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="w">        </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Writing MCP_durability_client/client.py
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<h2 id="Execucao">Execução<a class="anchor-link" href="#Execucao">¶</a></h2>
</section>
<section class="section-block-markdown-cell">
<p>Primeiro, iniciamos o servidor</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_server</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">server</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Durability MCP server started
Available tools:
&#x20;&#x20;- start_data_migration: Starts data migration
&#x20;&#x20;- start_batch_processing: Starts batch processing
&#x20;&#x20;- start_ml_training: Simulates ML training
&#x20;&#x20;- cancel_task: Cancels a task
&#x20;&#x20;- get_server_stats: Gets server statistics

Resources available:
&#x20;&#x20;- task://status/&#x7B;task_id&#x7D;: Specific task status
&#x20;&#x20;- task://list: Lists all tasks
&#x20;&#x20;- task://list/&#x7B;status&#x7D;: Lists tasks by status


╭─ FastMCP 2.0 ──────────────────────────────────────────────────────────────╮
│                                                                            │
│        _ __ ___ ______           __  __  _____________    ____    ____     │
│       _ __ ___ / ____/___ ______/ /_/  |/  / ____/ __ \  |___ \  / __ \    │
│      _ __ ___ / /_  / __ `/ ___/ __/ /|_/ / /   / /_/ /  ___/ / / / / /    │
│     _ __ ___ / __/ / /_/ (__  ) /_/ /  / / /___/ ____/  /  __/_/ /_/ /     │
│    _ __ ___ /_/    \__,_/____/\__/_/  /_/\____/_/      /_____(_)____/      │
│                                                                            │
│                                                                            │
│                                                                            │
│    🖥️  Server name:     MCP Durability Server                               │
│    📦 Transport:       Streamable-HTTP                                     │
│    🔗 Server URL:      http://127.0.0.1:8080/mcp                           │
│                                                                            │
│    📚 Docs:            https://gofastmcp.com                               │
│    🚀 Deploy:          https://fastmcp.cloud                               │
│                                                                            │
│    🏎️  FastMCP version: 2.11.3                                              │
│    🤝 MCP version:     1.13.1                                              │
│                                                                            │
╰────────────────────────────────────────────────────────────────────────────╯


[08/28/25 11:46:08] INFO     Starting MCP server &#x27;MCP Durability  ]8;id=396160;file:///Users/macm1/Documents/web/portafolio/posts/MCP_durability_server/.venv/lib/python3.12/site-packages/fastmcp/server/server.py\server.py]8;;\:]8;id=646262;file:///Users/macm1/Documents/web/portafolio/posts/MCP_durability_server/.venv/lib/python3.12/site-packages/fastmcp/server/server.py#1522\1522]8;;\\
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;Server&#x27; with transport &#x27;http&#x27; on                   
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;http://127.0.0.1:8080/mcp                          
INFO:     Started server process [55234]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8080 (Press CTRL+C to quit)
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Agora executamos o cliente</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>🚀 Interactive Demo of the MCP Durability System
=======================================================
🔗 Connected to the durability server

========================================
Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8):
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Primeiro, selecionamos a opção <code>5</code> para verificar se não há nenhuma tarefa em execução.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>🚀 Interactive Demo of the MCP Durability System
=======================================================
🔗 Connected to the durability server

========================================
Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 5
Task list:
No tasks

========================================
Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8):
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Vemos que sai</p>
<section class="section-block-markdown-cell">
      <div class='highlight'><pre><code class="language-json">Task list:<br>No tasks</code></pre></div>
      </section>
<p>Não há nenhuma tarefa em execução.</p>
</section>
<section class="section-block-markdown-cell">
<p>Agora selecionamos a opção <code>1</code> para iniciar a tarefa de migração de dados e selecionamos <code>100.000</code> amostras para garantir que a tarefa dure o suficiente para que possamos fazer tudo o que precisamos na postagem.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 1
Number of records to migrate (default 500): 100000
🚀 Starting data migration: 100000 records
&#x20;&#x20;&#x20;Source: /data/source
&#x20;&#x20;&#x20;Destination: /data/destination
[08/28/25 12:05:22] INFO     Server log: Starting migration of     logging.py:40
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;100000 records from /data/source to                
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;/data/destination                                  
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;INFO     Server log: Data migration started.   logging.py:40
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;Track progress at:                                 
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;task://status/821a210a-8672-4eba-b27c              
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;-500bf63e58c1                                      
✅ Task started. Resource URI: task://status/821a210a-8672-4eba-b27c-500bf63e58c1
Task URI: task://status/821a210a-8672-4eba-b27c-500bf63e58c1
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Selecionamos a opção <code>5</code> para ver a lista de tarefas</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 5
Task list:
&#x20;&#x20;&#x20;ID: 821a210a-8672-4eba-b27c-500bf63e58c1 | RUNNING   |   1.0% | Migrated 1000/100000 records
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Agora aparece a tarefa que acabamos de solicitar ao servidor MCP, podemos ver seu ID e seu status, ela contém 1000 dados de 100.000.</p>
</section>
<section class="section-block-markdown-cell">
<p>Selecionamos a opção <code>8</code> para encerrar o cliente.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 8
👋 Bye!
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Executamos novamente o cliente</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>🚀 Interactive Demo of the MCP Durability System
=======================================================
🔗 Connected to the durability server

========================================
Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8):
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Selecionamos novamente a opção <code>5</code> para ver a lista de tarefas em execução no servidor.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>🚀 Interactive Demo of the MCP Durability System
=======================================================
🔗 Connected to the durability server

========================================
Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 5
Task list:
&#x20;&#x20;&#x20;ID: 821a210a-8672-4eba-b27c-500bf63e58c1 | RUNNING   |   3.4% | Migrated 3400/100000 records
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Vemos que a tarefa continuou sendo executada e que agora tem mais dados processados. Antes tinha 1000 e agora tem 3400.</p>
</section>
<section class="section-block-markdown-cell">
<p>Now we select option <code>6</code> to monitor the task we requested from the server. This will allow us to monitor it for 10 seconds.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 6
📋 Available tasks:
&#x20;&#x20;&#x20;1. ID: 821a210a-8672-4eba-b27c-500bf63e58c1 | RUNNING   |   4.2% | Migrated 4200/100000 records

Select a task (1-1) or press Enter to cancel: 1
✅ Selected task: 821a210a-8672-4eba-b27c-500bf63e58c1
📊 Monitoring task 821a210a-8672-4eba-b27c-500bf63e58c1...
&#x20;&#x20;&#x20;[░░░░░░░░░░░░░░░░░░░░]   4.9% | RUNNING | Migrated 4900/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.0% | RUNNING | Migrated 5000/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.1% | RUNNING | Migrated 5100/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.2% | RUNNING | Migrated 5200/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.3% | RUNNING | Migrated 5300/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.4% | RUNNING | Migrated 5400/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.5% | RUNNING | Migrated 5500/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.6% | RUNNING | Migrated 5600/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.7% | RUNNING | Migrated 5700/100000 records
&#x20;&#x20;&#x20;[█░░░░░░░░░░░░░░░░░░░]   5.8% | RUNNING | Migrated 5800/100000 records
Timeout for task 821a210a-8672-4eba-b27c-500bf63e58c1
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Finally, we cancel the task using option <code>7</code>.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 7
📋 Available tasks:
&#x20;&#x20;&#x20;1. ID: 821a210a-8672-4eba-b27c-500bf63e58c1 | RUNNING   |   6.1% | Migrated 6100/100000 records

Select a task (1-1) or press Enter to cancel: 1
✅ Selected task: 821a210a-8672-4eba-b27c-500bf63e58c1
[08/28/25 12:06:25] INFO     Server log: Task                      logging.py:40
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;821a210a-8672-4eba-b27c-500bf63e58c1               
&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;&#x20;cancelled successfully                             
🚫 Task 821a210a-8672-4eba-b27c-500bf63e58c1 cancelled. Status available at: task://status/821a210a-8672-4eba-b27c-500bf63e58c1
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Now we select option <code>5</code> again to see the list of tasks.</p>
</section>
<section class="section-block-code-cell-">
<div class="input-code">
<div class="highlight hl-ipython3"><pre><span></span><span class="err">!</span><span class="n">cd</span> <span class="n">MCP_durability_client</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span> <span class="o">&amp;</span></span><span class="o">&amp;</span> <span class="n">uv</span> <span class="n">run</span> <span class="n">client</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section class="section-block-code-cell-">
<div class="output-wrapper">
<div class="output-area">
<div class="prompt"></div>
<div class="output-subarea-output-stream-output-stdout-output-text">
<pre>Available options:
1. Start data migration
2. Start batch processing
3. Start ML training
4. View server statistics
5. View task list
6. Monitor specific task
7. Cancel task
8. Exit

Select an option (1-8): 5
Task list:
&#x20;&#x20;&#x20;ID: 821a210a-8672-4eba-b27c-500bf63e58c1 | CANCELLED |   6.3% | Migrated 6300/100000 records
</pre>
</div>
</div>
</div>
</section>
<section class="section-block-markdown-cell">
<p>Vemos que la tarea que le pedimos al servidor aparece como cancelada (<code>CANCELLED</code>)</p>
</section>